<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoGuessr</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- External Libs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* ==================== THEME & RESET ==================== */
        :root {
            --bg-color: #0f0f12;
            --text-color: #ffffff;
            --primary-grad: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%);
            --purple-grad: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            --green-grad: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --glass-bg: rgba(20, 20, 25, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --blur: 15px;
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            overflow: hidden; -webkit-tap-highlight-color: transparent;
        }

        /* GLASSMORPHISM UTILITY */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* ==================== LAYERS ==================== */
        #mly { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        
        /* Mapillary Control Override: Move controls down */
        .mapillary-sequence-controls, .mapillary-direction-arrows {
            display: none;
        }
        
        /* ==================== MENUS & UI ==================== */
        .full-screen-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s ease;
            padding: 20px; box-sizing: border-box;
        }
        
        .menu-title { 
            font-size: 3.5rem; font-weight: 800; margin-bottom: 10px; 
            background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-align: center; letter-spacing: -1px;
        }
        .menu-subtitle { font-size: 1.1rem; color: #a0a0a0; margin-bottom: 50px; text-align: center; }

        .btn-main {
            width: 100%; max-width: 320px; padding: 18px; margin: 10px 0;
            border: none; border-radius: 18px; font-size: 1.2rem; font-weight: 600;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            color: white; text-transform: uppercase; letter-spacing: 1px;
            position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-main:active { transform: scale(0.97); }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Button Loader Styles */
        .btn-spinner {
            width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white; border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none;
        }
        .btn-main.loading .btn-content { display: none; }
        .btn-main.loading .btn-spinner { display: block; }

        .btn-blue { background: var(--primary-grad); }
        .btn-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-green { background: var(--green-grad); }
        .btn-dark { background: #333; border: 1px solid #555; }

        .input-code {
            padding: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.5); color: white; font-size: 24px; width: 80%;
            text-align: center; margin: 20px 0; letter-spacing: 5px; font-weight: bold;
            text-transform: uppercase; outline: none;
        }
        .input-code:focus { border-color: #00C6FF; }

        /* ==================== GAME HUD ==================== */
        #top-hud {
            position: absolute; 
            top: 80px; /* Requested 40px */
            left: 0; width: 100%;
            padding: 0 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 100; pointer-events: none;
        }

        #timer-box {
            color: white; padding: 10px 16px; border-radius: 14px;
            font-size: 1.4rem; font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: none;
            top: 80px;
            backdrop-filter: blur(10px); background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #timer-box.warning { color: #ff6b6b; border-color: #ff6b6b; animation: pulse 1s infinite; }

        #score-box {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            padding: 10px 15px; border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            top: 80px;
            font-size: 0.9rem; font-weight: 600; text-align: right;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .score-row { margin-bottom: 4px; display: flex; align-items: center; justify-content: flex-end; gap: 8px;}
        .score-val { color: #f1c40f; font-size: 1.1rem; font-weight: 800; font-family: monospace;}

        /* ==================== MAP & CONTROLS ==================== */
        #mobile-map-toggle {
            position: absolute; bottom: 30px; right: 20px;
            width: 65px; height: 65px; border-radius: 50%;
            background: var(--primary-grad); color: white;
            font-size: 28px; border: none; box-shadow: 0 8px 25px rgba(0, 114, 255, 0.4);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        #mobile-map-toggle:active { transform: scale(0.9); }

        #map-container {
            position: absolute; bottom: 110px; right: 20px;
            width: 90vw; max-width: 450px; height: 45vh;
            background: #fff; border-radius: 24px; border: 4px solid #fff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 200;
            transform: scale(0); opacity: 0; pointer-events: none;
            transform-origin: bottom right; transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        #map-container.open { transform: scale(1); opacity: 1; pointer-events: all; }
        #map { flex-grow: 1; width: 100%; }

        /* Fullscreen map for results */
        #map-container.map-result-mode {
            bottom: 0 !important; right: 0 !important; width: 100% !important; height: 100% !important;
            border-radius: 0 !important; border: none !important; max-width: none !important;
        }

        #confirm-btn {
            width: 100%; padding: 20px; background: #555; color: rgba(255,255,255,0.5);
            font-weight: 800; font-size: 16px; border: none; text-transform: uppercase;
            cursor: not-allowed; transition: 0.3s; letter-spacing: 1px;
        }
        #confirm-btn.active { background: var(--primary-grad); color: white; cursor: pointer; }

        /* ==================== RESULT SHEET ==================== */
        #result-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            z-index: 3000; transform: translateY(110%); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 30px 25px 40px 25px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 20px; color: white;
        }
        #result-sheet.show { transform: translateY(0); }

        .result-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .big-text { font-size: 2.2rem; font-weight: 900; line-height: 1; margin-bottom: 5px; }
        .sub-text { color: #aaa; font-size: 1rem; }

        .btn-group { display: flex; gap: 15px; margin-top: 10px; }
        .btn-primary {
            background: var(--primary-grad); color: white; padding: 18px;
            border: none; border-radius: 16px; font-size: 16px; font-weight: bold; flex: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1); color: white; padding: 16px;
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; 
            font-size: 22px; width: 70px; cursor: pointer;
        }

        /* ==================== SUMMARY MODAL ==================== */
        #summary-modal {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.95); z-index: 7000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: white;
        }
        .summary-score { 
            font-size: 4rem; font-weight: 900; 
            background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 20px 0; 
        }

        .hidden { display: none !important; }

        /* Loading Spinner Screen */
        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0f12; z-index: 4000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #00C6FF; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Toggle Buttons for MP */
        .toggle-group { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; }
        .toggle-btn {
            flex: 1; padding: 15px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3); color: #aaa; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .toggle-btn.selected { background: var(--primary-grad); color: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

    </style>
</head>
<body>

    <!-- 1. LOADING SCREEN (Global) -->
    <div id="loading">
        <div class="spinner"></div>
        <h3 id="loading-text" style="color: #666; font-weight: 400;">Loading World...</h3>
    </div>

    <!-- 2. MAIN MENU -->
    <div id="main-menu" class="full-screen-menu hidden">
        <div class="menu-title">GeoGuessr</div>
        <div class="menu-subtitle">Explore the world & challenge friends</div>

        <button class="btn-main btn-blue" onclick="window.startEndless()">
            <span class="btn-content"><span>âˆ</span> Endless Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-purple" onclick="window.startChallenge()">
            <span class="btn-content"><span>â±ï¸</span> Challenge Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-green" onclick="window.openFriendMenu()">
            <span class="btn-content"><span>ğŸ‘¥</span> Friend Mode</span>
            <div class="btn-spinner"></div>
        </button>
    </div>

    <!-- 3. FRIEND / MULTIPLAYER MENU -->
    <div id="friend-menu" class="full-screen-menu hidden">
        <h2 style="margin-bottom: 30px; font-size: 2rem;">Friend Mode</h2>
        
        <!-- Create -->
        <div class="glass-panel" style="padding:25px; width:100%; max-width:350px; margin-bottom:25px;">
            <h4 style="margin:0 0 15px 0; color:#aaa; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Create Room</h4>
            <div class="toggle-group">
                <button id="mp-mode-endless" class="toggle-btn selected" onclick="window.selectMpMode('endless')">Endless</button>
                <button id="mp-mode-challenge" class="toggle-btn" onclick="window.selectMpMode('challenge')">Challenge</button>
            </div>
            <button id="btn-create" class="btn-main btn-green" style="width:100%; max-width:none; margin:0;" onclick="window.createRoom()">
                <span class="btn-content">Create & Play</span>
                <div class="btn-spinner"></div>
            </button>
        </div>

        <div style="color:#555; font-weight:bold; margin-bottom: 25px;">â€” OR â€”</div>

        <!-- Join -->
        <div style="width:100%; max-width:350px; text-align:center;">
            <input type="text" id="join-code" class="input-code" placeholder="CODE" maxlength="5">
            <button id="btn-join" class="btn-main btn-blue" style="width:100%; max-width:none; margin:0;" onclick="window.joinRoom()">
                <span class="btn-content">Join Room</span>
                <div class="btn-spinner"></div>
            </button>
        </div>

        <button class="btn-main btn-dark" style="width:auto; padding: 12px 30px; margin-top: 40px;" onclick="window.showMainMenu()">Back</button>
    </div>

    <!-- 4. LOBBY SCREEN -->
    <div id="lobby-screen" class="full-screen-menu hidden">
        <h1 id="lobby-code-display" style="font-size:4rem; background: var(--primary-grad); -webkit-background-clip:text; -webkit-text-fill-color: transparent; letter-spacing:8px; margin-bottom: 10px;">----</h1>
        <p style="color:#888;">Share this code with your friend.</p>
        <div id="lobby-status" style="margin-top:30px; color:#fff; font-size: 1.2rem; font-weight: 600; display:flex; align-items:center; gap:10px;">
            <div class="spinner" style="width:20px; height:20px; margin:0; border-width:2px;"></div> 
            Waiting for player...
        </div>
        <button class="btn-main btn-dark" style="margin-top: 50px;" onclick="window.location.reload()">Cancel</button>
    </div>

    <!-- 5. GAME UI -->
    <div id="mly"></div> <!-- Street View -->

    <!-- HUD -->
    <div id="top-hud">
        <div id="timer-box">02:00</div>
        
        <div id="score-box">
            <div class="score-row" id="round-indicator" style="display:none; color:#aaa; font-size:0.8rem; text-transform:uppercase;">Round 1/5</div>
            <div class="score-row">YOU <span id="score-me" class="score-val">0</span></div>
            <div class="score-row" id="score-opp-row" style="display:none;">OPP <span id="score-opp" class="score-val" style="color:#ff6b6b">0</span></div>
        </div>
    </div>

    <!-- Map & Controls -->
    <button id="mobile-map-toggle" onclick="window.toggleMap()">ğŸ—ºï¸</button>

    <div id="map-container">
        <div id="map"></div>
        <button id="confirm-btn" onclick="window.submitGuess()">Tap map to guess</button>
    </div>

    <!-- Result Sheet -->
    <div id="result-sheet">
        <div class="result-row">
            <div>
                <div class="big-text" id="res-dist">0 m</div>
                <div style="color:#f1c40f; font-weight:bold; font-size:1.4rem;" id="res-pts">+0 pts</div>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:bold; font-size:1.1rem; color: #ddd;">Location</div>
                <div id="res-loc-name" class="sub-text">City, Country</div>
            </div>
        </div>

        <div id="res-multi-info" style="background:rgba(255,255,255,0.08); padding:15px; border-radius:12px; display:none;">
            <div style="display:flex; justify-content:space-between; align-items: center;">
                <span style="color:#aaa; font-weight:600;">Opponent:</span>
                <span id="res-opp-dist" style="color:#ff6b6b; font-weight:bold; font-size: 1.2rem;">--</span>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-secondary" onclick="window.shareResult()">ğŸ“¤</button>
            <button class="btn-primary" id="next-btn" onclick="window.nextRound()">
                <span class="btn-content">Play Next</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
    </div>

    <!-- 6. SUMMARY MODAL (Challenge Mode End) -->
    <div id="summary-modal">
        <h1 style="text-transform: uppercase; letter-spacing: 2px;">Game Over</h1>
        <p style="color:#aaa;">Total Score</p>
        <div class="summary-score" id="final-score">0</div>
        <button class="btn-main btn-blue" onclick="window.location.reload()">Back to Menu</button>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js"></script>

    <!-- FIREBASE MODULE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDJjo66zCwODJW1J2SoVQ2B8tIH5FPUu1A",
            authDomain: "mytube-cd424.firebaseapp.com",
            databaseURL: "https://mytube-cd424-default-rtdb.firebaseio.com",
            projectId: "mytube-cd424",
            storageBucket: "mytube-cd424.appspot.com",
            messagingSenderId: "865512387483",
            appId: "1:865512387483:web:de8245f509dba9bbd5273e",
            measurementId: "G-V4HBY4LBVH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ================= GLOBAL STATE =================
        const STATE = {
            mode: 'menu', 
            mpRole: null, 
            gameId: null,
            round: 1,
            maxRounds: 5,
            score: 0,
            oppScore: 0,
            timer: null,
            timeLeft: 120, 
            currentLoc: null,
            isLocked: false,
            mpModeSelected: 'endless',
            resultShown: false
        };

        const MLY_TOKEN = 'MLY|26213154491618951|523c0418de2d6a8118aefdab3284d6c2'; 
        let map, mly, guessMarker, resultLine, resultMarker, oppMarker, oppLine;

        // ================= LOCATION DATA =================
        const LOCATIONS = [
            // --- RUSSIA (Existing + 8 New) ---
            { name: "Saint Petersburg, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 59.9311, lng: 30.3609 },
            { name: "Moscow, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 55.7558, lng: 37.6173 },
            { name: "Kazan, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 55.7963, lng: 49.1088 },
            { name: "Sochi, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 43.5852, lng: 39.7231 },
            { name: "Novosibirsk, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 55.0302, lng: 82.9204 },
            { name: "Yekaterinburg, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 56.8389, lng: 60.6057 },
            { name: "Vladivostok, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 43.1198, lng: 131.8869 },
            { name: "Nizhny Novgorod, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 56.2965, lng: 43.9361 },
            { name: "Kaliningrad, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 54.7104, lng: 20.4522 },

            // --- NORTH AMERICA ---
            { name: "New York, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 40.7128, lng: -74.0060 },
            { name: "Los Angeles, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 34.0522, lng: -118.2437 },
            { name: "Chicago, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 41.8781, lng: -87.6298 },
            { name: "San Francisco, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 37.7749, lng: -122.4194 },
            { name: "Miami, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 25.7617, lng: -80.1918 },
            { name: "Las Vegas, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 36.1699, lng: -115.1398 },
            { name: "Seattle, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 47.6062, lng: -122.3321 },
            { name: "Boston, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 42.3601, lng: -71.0589 },
            { name: "Austin, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 30.2672, lng: -97.7431 },
            { name: "Denver, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 39.7392, lng: -104.9903 },
            { name: "New Orleans, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 29.9511, lng: -90.0715 },
            { name: "Philadelphia, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 39.9526, lng: -75.1652 },
            { name: "San Diego, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 32.7157, lng: -117.1611 },
            { name: "Portland, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 45.5051, lng: -122.6750 },
            { name: "Toronto, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 43.6532, lng: -79.3832 },
            { name: "Vancouver, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 49.2827, lng: -123.1207 },
            { name: "Montreal, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 45.5017, lng: -73.5673 },
            { name: "Calgary, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 51.0447, lng: -114.0719 },
            { name: "Ottawa, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 45.4215, lng: -75.6972 },
            { name: "Mexico City, Mexico", flag: "ğŸ‡²ğŸ‡½", lat: 19.4326, lng: -99.1332 },
            { name: "Guadalajara, Mexico", flag: "ğŸ‡²ğŸ‡½", lat: 20.6597, lng: -103.3496 },
            { name: "Monterrey, Mexico", flag: "ğŸ‡²ğŸ‡½", lat: 25.6866, lng: -100.3161 },

            // --- SOUTH AMERICA ---
            { name: "SÃ£o Paulo, Brazil", flag: "ğŸ‡§ğŸ‡·", lat: -23.5505, lng: -46.6333 },
            { name: "Rio de Janeiro, Brazil", flag: "ğŸ‡§ğŸ‡·", lat: -22.9068, lng: -43.1729 },
            { name: "BrasÃ­lia, Brazil", flag: "ğŸ‡§ğŸ‡·", lat: -15.7975, lng: -47.8919 },
            { name: "Salvador, Brazil", flag: "ğŸ‡§ğŸ‡·", lat: -12.9777, lng: -38.5016 },
            { name: "Buenos Aires, Argentina", flag: "ğŸ‡¦ğŸ‡·", lat: -34.6037, lng: -58.3816 },
            { name: "Mendoza, Argentina", flag: "ğŸ‡¦ğŸ‡·", lat: -32.8895, lng: -68.8458 },
            { name: "Santiago, Chile", flag: "ğŸ‡¨ğŸ‡±", lat: -33.4489, lng: -70.6693 },
            { name: "Valparaiso, Chile", flag: "ğŸ‡¨ğŸ‡±", lat: -33.0472, lng: -71.6127 },
            { name: "BogotÃ¡, Colombia", flag: "ğŸ‡¨ğŸ‡´", lat: 4.7110, lng: -74.0721 },
            { name: "MedellÃ­n, Colombia", flag: "ğŸ‡¨ğŸ‡´", lat: 6.2442, lng: -75.5812 },
            { name: "Lima, Peru", flag: "ğŸ‡µğŸ‡ª", lat: -12.0464, lng: -77.0428 },
            { name: "Cusco, Peru", flag: "ğŸ‡µğŸ‡ª", lat: -13.5320, lng: -71.9675 },
            { name: "Quito, Ecuador", flag: "ğŸ‡ªğŸ‡¨", lat: -0.1807, lng: -78.4678 },
            { name: "Montevideo, Uruguay", flag: "ğŸ‡ºğŸ‡¾", lat: -34.9011, lng: -56.1645 },
            { name: "La Paz, Bolivia", flag: "ğŸ‡§ğŸ‡´", lat: -16.5004, lng: -68.1193 },

            // --- EUROPE ---
            { name: "London, UK", flag: "ğŸ‡¬ğŸ‡§", lat: 51.5074, lng: -0.1278 },
            { name: "Manchester, UK", flag: "ğŸ‡¬ğŸ‡§", lat: 53.4808, lng: -2.2426 },
            { name: "Edinburgh, UK", flag: "ğŸ‡¬ğŸ‡§", lat: 55.9533, lng: -3.1883 },
            { name: "Paris, France", flag: "ğŸ‡«ğŸ‡·", lat: 48.8566, lng: 2.3522 },
            { name: "Lyon, France", flag: "ğŸ‡«ğŸ‡·", lat: 45.7640, lng: 4.8357 },
            { name: "Marseille, France", flag: "ğŸ‡«ğŸ‡·", lat: 43.2965, lng: 5.3698 },
            { name: "Nice, France", flag: "ğŸ‡«ğŸ‡·", lat: 43.7102, lng: 7.2620 },
            { name: "Madrid, Spain", flag: "ğŸ‡ªğŸ‡¸", lat: 40.4168, lng: -3.7038 },
            { name: "Barcelona, Spain", flag: "ğŸ‡ªğŸ‡¸", lat: 41.3851, lng: 2.1734 },
            { name: "Seville, Spain", flag: "ğŸ‡ªğŸ‡¸", lat: 37.3891, lng: -5.9845 },
            { name: "Valencia, Spain", flag: "ğŸ‡ªğŸ‡¸", lat: 39.4699, lng: -0.3763 },
            { name: "Lisbon, Portugal", flag: "ğŸ‡µğŸ‡¹", lat: 38.7223, lng: -9.1393 },
            { name: "Porto, Portugal", flag: "ğŸ‡µğŸ‡¹", lat: 41.1579, lng: -8.6291 },
            { name: "Berlin, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 52.5200, lng: 13.4050 },
            { name: "Munich, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 48.1351, lng: 11.5820 },
            { name: "Hamburg, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 53.5511, lng: 9.9937 },
            { name: "Frankfurt, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 50.1109, lng: 8.6821 },
            { name: "Cologne, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 50.9375, lng: 6.9603 },
            { name: "Rome, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 41.9028, lng: 12.4964 },
            { name: "Milan, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 45.4642, lng: 9.1900 },
            { name: "Venice, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 45.4408, lng: 12.3155 },
            { name: "Florence, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 43.7696, lng: 11.2558 },
            { name: "Naples, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 40.8518, lng: 14.2681 },
            { name: "Amsterdam, Netherlands", flag: "ğŸ‡³ğŸ‡±", lat: 52.3676, lng: 4.9041 },
            { name: "Rotterdam, Netherlands", flag: "ğŸ‡³ğŸ‡±", lat: 51.9244, lng: 4.4777 },
            { name: "Brussels, Belgium", flag: "ğŸ‡§ğŸ‡ª", lat: 50.8503, lng: 4.3517 },
            { name: "Vienna, Austria", flag: "ğŸ‡¦ğŸ‡¹", lat: 48.2082, lng: 16.3738 },
            { name: "Prague, Czechia", flag: "ğŸ‡¨ğŸ‡¿", lat: 50.0755, lng: 14.4378 },
            { name: "Budapest, Hungary", flag: "ğŸ‡­ğŸ‡º", lat: 47.4979, lng: 19.0402 },
            { name: "Stockholm, Sweden", flag: "ğŸ‡¸ğŸ‡ª", lat: 59.3293, lng: 18.0686 },
            { name: "Gothenburg, Sweden", flag: "ğŸ‡¸ğŸ‡ª", lat: 57.7089, lng: 11.9746 },
            { name: "Oslo, Norway", flag: "ğŸ‡³ğŸ‡´", lat: 59.9139, lng: 10.7522 },
            { name: "Bergen, Norway", flag: "ğŸ‡³ğŸ‡´", lat: 60.3913, lng: 5.3221 },
            { name: "Helsinki, Finland", flag: "ğŸ‡«ğŸ‡®", lat: 60.1699, lng: 24.9384 },
            { name: "Copenhagen, Denmark", flag: "ğŸ‡©ğŸ‡°", lat: 55.6761, lng: 12.5683 },
            { name: "Aarhus, Denmark", flag: "ğŸ‡©ğŸ‡°", lat: 56.1629, lng: 10.2039 },
            { name: "Warsaw, Poland", flag: "ğŸ‡µğŸ‡±", lat: 52.2297, lng: 21.0122 },
            { name: "Krakow, Poland", flag: "ğŸ‡µğŸ‡±", lat: 50.0647, lng: 19.9450 },
            { name: "Gdansk, Poland", flag: "ğŸ‡µğŸ‡±", lat: 54.3520, lng: 18.6466 },
            { name: "Athens, Greece", flag: "ğŸ‡¬ğŸ‡·", lat: 37.9838, lng: 23.7275 },
            { name: "Thessaloniki, Greece", flag: "ğŸ‡¬ğŸ‡·", lat: 40.6401, lng: 22.9444 },
            { name: "Zurich, Switzerland", flag: "ğŸ‡¨ğŸ‡­", lat: 47.3769, lng: 8.5417 },
            { name: "Geneva, Switzerland", flag: "ğŸ‡¨ğŸ‡­", lat: 46.2044, lng: 6.1432 },
            { name: "Dublin, Ireland", flag: "ğŸ‡®ğŸ‡ª", lat: 53.3498, lng: -6.2603 },
            { name: "Zagreb, Croatia", flag: "ğŸ‡­ğŸ‡·", lat: 45.8150, lng: 15.9819 },
            { name: "Dubrovnik, Croatia", flag: "ğŸ‡­ğŸ‡·", lat: 42.6507, lng: 18.0944 },
            { name: "Bucharest, Romania", flag: "ğŸ‡·ğŸ‡´", lat: 44.4268, lng: 26.1025 },
            { name: "Sofia, Bulgaria", flag: "ğŸ‡§ğŸ‡¬", lat: 42.6977, lng: 23.3219 },
            { name: "Belgrade, Serbia", flag: "ğŸ‡·ğŸ‡¸", lat: 44.7866, lng: 20.4489 },
            { name: "Tallinn, Estonia", flag: "ğŸ‡ªğŸ‡ª", lat: 59.4370, lng: 24.7536 },
            { name: "Riga, Latvia", flag: "ğŸ‡±ğŸ‡»", lat: 56.9496, lng: 24.1052 },
            { name: "Vilnius, Lithuania", flag: "ğŸ‡±ğŸ‡¹", lat: 54.6872, lng: 25.2797 },
            { name: "Reykjavik, Iceland", flag: "ğŸ‡®ğŸ‡¸", lat: 64.1265, lng: -21.8174 },

            // --- ASIA ---
            { name: "Istanbul, Turkey", flag: "ğŸ‡¹ğŸ‡·", lat: 41.0082, lng: 28.9784 },
            { name: "Ankara, Turkey", flag: "ğŸ‡¹ğŸ‡·", lat: 39.9334, lng: 32.8597 },
            { name: "Antalya, Turkey", flag: "ğŸ‡¹ğŸ‡·", lat: 36.8969, lng: 30.7133 },
            { name: "Tokyo, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 35.6762, lng: 139.6503 },
            { name: "Osaka, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 34.6937, lng: 135.5023 },
            { name: "Kyoto, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 35.0116, lng: 135.7681 },
            { name: "Sapporo, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 43.0618, lng: 141.3545 },
            { name: "Fukuoka, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 33.5902, lng: 130.4017 },
            { name: "Seoul, South Korea", flag: "ğŸ‡°ğŸ‡·", lat: 37.5665, lng: 126.9780 },
            { name: "Busan, South Korea", flag: "ğŸ‡°ğŸ‡·", lat: 35.1796, lng: 129.0756 },
            { name: "Taipei, Taiwan", flag: "ğŸ‡¹ğŸ‡¼", lat: 25.0330, lng: 121.5654 },
            { name: "Kaohsiung, Taiwan", flag: "ğŸ‡¹ğŸ‡¼", lat: 22.6273, lng: 120.3014 },
            { name: "Bangkok, Thailand", flag: "ğŸ‡¹ğŸ‡­", lat: 13.7563, lng: 100.5018 },
            { name: "Chiang Mai, Thailand", flag: "ğŸ‡¹ğŸ‡­", lat: 18.7883, lng: 98.9853 },
            { name: "Singapore", flag: "ğŸ‡¸ğŸ‡¬", lat: 1.3521, lng: 103.8198 },
            { name: "Kuala Lumpur, Malaysia", flag: "ğŸ‡²ğŸ‡¾", lat: 3.1390, lng: 101.6869 },
            { name: "Jakarta, Indonesia", flag: "ğŸ‡®ğŸ‡©", lat: -6.2088, lng: 106.8456 },
            { name: "Bali (Denpasar), Indonesia", flag: "ğŸ‡®ğŸ‡©", lat: -8.6705, lng: 115.2126 },
            { name: "Manila, Philippines", flag: "ğŸ‡µğŸ‡­", lat: 14.5995, lng: 120.9842 },
            { name: "Cebu City, Philippines", flag: "ğŸ‡µğŸ‡­", lat: 10.3157, lng: 123.8854 },
            { name: "Ho Chi Minh City, Vietnam", flag: "ğŸ‡»ğŸ‡³", lat: 10.8231, lng: 106.6297 },
            { name: "Hanoi, Vietnam", flag: "ğŸ‡»ğŸ‡³", lat: 21.0285, lng: 105.8542 },
            { name: "Dubai, UAE", flag: "ğŸ‡¦ğŸ‡ª", lat: 25.2048, lng: 55.2708 },
            { name: "Abu Dhabi, UAE", flag: "ğŸ‡¦ğŸ‡ª", lat: 24.4539, lng: 54.3773 },
            { name: "Doha, Qatar", flag: "ğŸ‡¶ğŸ‡¦", lat: 25.2854, lng: 51.5310 },
            { name: "Tel Aviv, Israel", flag: "ğŸ‡®ğŸ‡±", lat: 32.0853, lng: 34.7818 },
            { name: "Jerusalem, Israel", flag: "ğŸ‡®ğŸ‡±", lat: 31.7683, lng: 35.2137 },
            { name: "Mumbai, India", flag: "ğŸ‡®ğŸ‡³", lat: 19.0760, lng: 72.8777 },
            { name: "New Delhi, India", flag: "ğŸ‡®ğŸ‡³", lat: 28.6139, lng: 77.2090 },
            { name: "Bangalore, India", flag: "ğŸ‡®ğŸ‡³", lat: 12.9716, lng: 77.5946 },
            { name: "Colombo, Sri Lanka", flag: "ğŸ‡±ğŸ‡°", lat: 6.9271, lng: 79.8612 },
            { name: "Ulaanbaatar, Mongolia", flag: "ğŸ‡²ğŸ‡³", lat: 47.9181, lng: 106.9176 },

            // --- AFRICA ---
            { name: "Cape Town, South Africa", flag: "ğŸ‡¿ğŸ‡¦", lat: -33.9249, lng: 18.4241 },
            { name: "Johannesburg, South Africa", flag: "ğŸ‡¿ğŸ‡¦", lat: -26.2041, lng: 28.0473 },
            { name: "Durban, South Africa", flag: "ğŸ‡¿ğŸ‡¦", lat: -29.8587, lng: 31.0218 },
            { name: "Nairobi, Kenya", flag: "ğŸ‡°ğŸ‡ª", lat: -1.2921, lng: 36.8219 },
            { name: "Tunis, Tunisia", flag: "ğŸ‡¹ğŸ‡³", lat: 36.8065, lng: 10.1815 },
            { name: "Cairo, Egypt", flag: "ğŸ‡ªğŸ‡¬", lat: 30.0444, lng: 31.2357 },
            { name: "Marrakech, Morocco", flag: "ğŸ‡²ğŸ‡¦", lat: 31.6295, lng: -7.9811 },
            { name: "Casablanca, Morocco", flag: "ğŸ‡²ğŸ‡¦", lat: 33.5731, lng: -7.5898 },
            { name: "Dakar, Senegal", flag: "ğŸ‡¸ğŸ‡³", lat: 14.7167, lng: -17.4677 },
            { name: "Accra, Ghana", flag: "ğŸ‡¬ğŸ‡­", lat: 5.6037, lng: -0.1870 },
            { name: "Lagos, Nigeria", flag: "ğŸ‡³ğŸ‡¬", lat: 6.5244, lng: 3.3792 },

            // --- OCEANIA ---
            { name: "Sydney, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -33.8688, lng: 151.2093 },
            { name: "Melbourne, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -37.8136, lng: 144.9631 },
            { name: "Brisbane, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -27.4698, lng: 153.0251 },
            { name: "Perth, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -31.9505, lng: 115.8605 },
            { name: "Adelaide, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -34.9285, lng: 138.6007 },
            { name: "Hobart, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -42.8821, lng: 147.3272 },
            { name: "Auckland, New Zealand", flag: "ğŸ‡³ğŸ‡¿", lat: -36.8485, lng: 174.7633 },
            { name: "Wellington, New Zealand", flag: "ğŸ‡³ğŸ‡¿", lat: -41.2865, lng: 174.7762 },
            { name: "Christchurch, New Zealand", flag: "ğŸ‡³ğŸ‡¿", lat: -43.5321, lng: 172.6362 }
        ];

        // ================= INIT =================
        function init() {
            map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â©CARTO' }).addTo(map);

            const { Viewer } = mapillary;
            mly = new Viewer({
                accessToken: MLY_TOKEN,
                container: 'mly',
                component: { 
                    cover: false,
                    sequence: false  // <--- Disables the arrows on the floor (optional)
                }
            });

            // Tap Listener
            map.on('click', (e) => {
                if(STATE.isLocked) return;
                if(guessMarker) map.removeLayer(guessMarker);
                guessMarker = L.marker(e.latlng).addTo(map);
                
                const btn = document.getElementById('confirm-btn');
                btn.classList.add('active');
                btn.innerText = "CONFIRM GUESS";
                btn.disabled = false;
                
                if(window.Telegram?.WebApp?.HapticFeedback) {
                     window.Telegram.WebApp.HapticFeedback.selectionChanged();
                }
            });

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        // Helper: Toggle Button Loading
        function setBtnLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if(!btn) return;
            if(isLoading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // ================= MENU FUNCTIONS =================
        window.showMainMenu = () => {
            document.querySelectorAll('.full-screen-menu').forEach(el => el.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
        };

        window.openFriendMenu = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('friend-menu').classList.remove('hidden');
        };

        window.selectMpMode = (mode) => {
            STATE.mpModeSelected = mode;
            document.getElementById('mp-mode-endless').classList.toggle('selected', mode === 'endless');
            document.getElementById('mp-mode-challenge').classList.toggle('selected', mode === 'challenge');
        };

        // ================= GAME MODES =================
        window.startEndless = () => {
            STATE.mode = 'endless';
            STATE.score = 0;
            updateHUD();
            startGameLoop();
        };

        window.startChallenge = () => {
            STATE.mode = 'challenge';
            STATE.round = 1;
            STATE.score = 0;
            STATE.maxRounds = 5;
            updateHUD();
            startGameLoop();
        };

        function updateHUD() {
            document.querySelectorAll('.full-screen-menu').forEach(el => el.classList.add('hidden'));
            
            document.getElementById('score-me').innerText = STATE.score;
            document.getElementById('score-opp-row').style.display = (STATE.mode === 'multi') ? 'flex' : 'none';
            
            if (STATE.mode === 'challenge' || (STATE.mode === 'multi' && STATE.mpModeSelected === 'challenge')) {
                document.getElementById('round-indicator').style.display = 'block';
                document.getElementById('round-indicator').innerText = `ROUND ${STATE.round}/${STATE.maxRounds}`;
                document.getElementById('timer-box').style.display = 'block';
            } else {
                document.getElementById('round-indicator').style.display = 'none';
                document.getElementById('timer-box').style.display = 'none';
            }
        }

        function startGameLoop() {
            resetMapUI();
            
            if (STATE.mode !== 'multi') {
                document.getElementById('loading').classList.remove('hidden'); // Show loader
                pickRandomLocation().then(loc => {
                    STATE.currentLoc = loc;
                    loadLocation(loc);
                    if(STATE.mode === 'challenge') startTimer(120);
                });
            } else {
                document.getElementById('confirm-btn').innerText = "WAITING FOR SYNC...";
            }
        }

        // ================= MULTIPLAYER =================
        window.createRoom = () => {
            setBtnLoading('btn-create', true);
            const code = Math.floor(10000 + Math.random() * 90000).toString();
            STATE.gameId = code;
            STATE.mpRole = 'host';
            STATE.mode = 'multi';
            
            set(ref(db, 'games/' + code), {
                status: 'waiting',
                mode: STATE.mpModeSelected,
                round: 1,
                scores: { host: 0, guest: 0 },
                location: null
            }).then(() => {
                setBtnLoading('btn-create', false);
                document.getElementById('friend-menu').classList.add('hidden');
                document.getElementById('lobby-screen').classList.remove('hidden');
                document.getElementById('lobby-code-display').innerText = code;
                listenToGame(code);
            });
        };

        window.joinRoom = () => {
            const code = document.getElementById('join-code').value;
            if(code.length !== 5) return alert("Invalid Code");

            setBtnLoading('btn-join', true);

            get(ref(db, 'games/' + code)).then((snap) => {
                setBtnLoading('btn-join', false);
                if(snap.exists()) {
                    STATE.gameId = code;
                    STATE.mpRole = 'guest';
                    STATE.mode = 'multi';
                    
                    update(ref(db, 'games/' + code), { status: 'starting' });
                    
                    document.getElementById('friend-menu').classList.add('hidden');
                    document.getElementById('lobby-status').innerHTML = '<div class="spinner" style="width:20px;height:20px;margin:0;border-width:2px;"></div> Joining...';
                    document.getElementById('lobby-screen').classList.remove('hidden');
                    
                    listenToGame(code);
                } else {
                    alert("Room not found");
                }
            });
        };

        function listenToGame(gameId) {
            onValue(ref(db, 'games/' + gameId), (snap) => {
                const data = snap.val();
                if(!data) return;

                if(STATE.mpRole === 'guest' && data.mode) {
                    STATE.mpModeSelected = data.mode;
                }

                // 1. START GAME
                if(data.status === 'starting' || data.status === 'playing') {
                    document.getElementById('lobby-screen').classList.add('hidden');
                    
                    if (STATE.mpRole === 'host' && (!data.location || data.status === 'starting')) {
                        if (data.status === 'starting') {
                            update(ref(db, 'games/' + gameId), { status: 'playing' });
                            document.getElementById('loading').classList.remove('hidden');
                            pickRandomLocation().then(loc => {
                                update(ref(db, 'games/' + gameId), { location: loc });
                            });
                        }
                    }
                }

                // 2. LOCATION SYNC
                if(data.location && (!STATE.currentLoc || STATE.currentLoc.id !== data.location.id)) {
                    STATE.currentLoc = data.location;
                    STATE.round = data.round;
                    STATE.resultShown = false; 
                    
                    updateHUD();
                    loadLocation(data.location);
                    resetMapUI();
                    
                    if(STATE.mpModeSelected === 'challenge') startTimer(120);
                }

                // 3. SCORE
                if(data.scores) {
                    const oppRole = STATE.mpRole === 'host' ? 'guest' : 'host';
                    STATE.oppScore = data.scores[oppRole];
                    document.getElementById('score-opp').innerText = STATE.oppScore;
                    document.getElementById('score-me').innerText = data.scores[STATE.mpRole];
                    STATE.score = data.scores[STATE.mpRole];
                }

                // 4. SHOW RESULT
                if(data.guesses && data.guesses.host && data.guesses.guest && !STATE.resultShown) {
                     STATE.resultShown = true; 
                     clearInterval(STATE.timer);
                     showMpResult(data.guesses, data.location);
                } else if (data.guesses && !STATE.resultShown) {
                    if(STATE.isLocked) {
                        document.getElementById('confirm-btn').innerText = "Waiting for Opponent...";
                    }
                }
            });
        }

        // ================= GAME LOGIC =================
        async function pickRandomLocation() {
            const city = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
            const range = 0.04;
            const rLat = city.lat + (Math.random() * range * 2 - range);
            const rLng = city.lng + (Math.random() * range * 2 - range);
            const box = 0.005; 
            const bbox = `${rLng-box},${rLat-box},${rLng+box},${rLat+box}`;

            try {
                const res = await fetch(`https://graph.mapillary.com/images?access_token=${MLY_TOKEN}&fields=id,geometry&bbox=${bbox}&limit=1`);
                const data = await res.json();
                if(data.data && data.data.length > 0) {
                    return { 
                        id: data.data[0].id, 
                        lat: data.data[0].geometry.coordinates[1], 
                        lng: data.data[0].geometry.coordinates[0],
                        city: city 
                    };
                } else return pickRandomLocation(); 
            } catch(e) { return pickRandomLocation(); }
        }

        function loadLocation(loc) {
            // Loader is already shown before this call
            mly.moveTo(loc.id)
                .then(() => document.getElementById('loading').classList.add('hidden'))
                .catch(e => {
                     console.log(e);
                     // If fail, try new location
                     pickRandomLocation().then(l => loadLocation(l));
                });
        }

        function resetMapUI() {
            STATE.isLocked = false;
            setBtnLoading('next-btn', false); // Reset next button loading state
            document.getElementById('result-sheet').classList.remove('show');
            document.getElementById('map-container').classList.remove('map-result-mode', 'open');
            document.getElementById('mobile-map-toggle').style.display = 'flex';
            document.getElementById('res-multi-info').style.display = 'none';

            if(guessMarker) map.removeLayer(guessMarker);
            if(resultLine) map.removeLayer(resultLine);
            if(resultMarker) map.removeLayer(resultMarker);
            if(oppMarker) map.removeLayer(oppMarker);
            if(oppLine) map.removeLayer(oppLine);
            
            guessMarker = null; 
            map.setView([20,0], 2);
            
            const btn = document.getElementById('confirm-btn');
            btn.classList.remove('active');
            btn.innerText = "Tap map to guess";
            btn.disabled = true;
        }

        function startTimer(seconds) {
            clearInterval(STATE.timer);
            STATE.timeLeft = seconds;
            updateTimerDisplay();
            
            STATE.timer = setInterval(() => {
                STATE.timeLeft--;
                updateTimerDisplay();
                if(STATE.timeLeft <= 0) {
                    clearInterval(STATE.timer);
                    if(!STATE.isLocked) window.submitGuess(true); 
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const min = Math.floor(STATE.timeLeft / 60);
            const sec = STATE.timeLeft % 60;
            const el = document.getElementById('timer-box');
            el.innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;
            if(STATE.timeLeft < 10) el.classList.add('warning');
            else el.classList.remove('warning');
        }

        // ================= SUBMIT & RESULTS =================
        window.submitGuess = (force = false) => {
            if((!guessMarker && !force) || STATE.isLocked) return;
            
            clearInterval(STATE.timer);
            STATE.isLocked = true;
            
            const uLat = guessMarker ? guessMarker.getLatLng() : L.latLng(0,0);
            const aLat = L.latLng(STATE.currentLoc.lat, STATE.currentLoc.lng);
            const dist = map.distance(uLat, aLat);
            const pts = Math.round(5000 * Math.exp(-dist / 120000)); 

            if(window.Telegram?.WebApp?.HapticFeedback) {
                 window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }

            if(STATE.mode === 'multi') {
                document.getElementById('confirm-btn').innerText = "Waiting for Opponent...";
                set(ref(db, `games/${STATE.gameId}/guesses/${STATE.mpRole}`), {
                    lat: uLat.lat, lng: uLat.lng, pts: pts
                });
                return;
            }

            STATE.score += pts;
            showSingleResult(uLat, aLat, dist, pts);
        };

        function showSingleResult(uLat, aLat, dist, pts) {
            setupResultMap(uLat, aLat);
            
            document.getElementById('res-dist').innerText = formatDist(dist);
            document.getElementById('res-pts').innerText = "+" + pts + " pts";
            document.getElementById('res-loc-name').innerHTML = STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag;
            
            const nextBtn = document.getElementById('next-btn');
            const nextBtnText = nextBtn.querySelector('.btn-content');
            
            if (STATE.mode === 'challenge' && STATE.round >= STATE.maxRounds) {
                nextBtnText.innerText = "Finish Game";
                nextBtn.onclick = showSummary;
            } else {
                nextBtnText.innerText = "Play Next";
                nextBtn.onclick = window.nextRound;
            }

            document.getElementById('result-sheet').classList.add('show');
        }

        function showMpResult(guesses, locData) {
            const myGuess = guesses[STATE.mpRole];
            const oppRole = STATE.mpRole === 'host' ? 'guest' : 'host';
            const oppGuess = guesses[oppRole];
            const actual = L.latLng(locData.lat, locData.lng);
            
            setupResultMap(L.latLng(myGuess.lat, myGuess.lng), actual);
            
            const oppLatLng = L.latLng(oppGuess.lat, oppGuess.lng);
            oppMarker = L.circleMarker(oppLatLng, { radius: 6, color: '#ff6b6b', fillColor:'#ff6b6b', fillOpacity:1 }).addTo(map);
            oppLine = L.polyline([oppLatLng, actual], { color: '#ff6b6b', weight: 2, dashArray:'5,5' }).addTo(map);

            const myDist = map.distance(L.latLng(myGuess.lat, myGuess.lng), actual);
            const oppDist = map.distance(oppLatLng, actual);
            
            document.getElementById('res-dist').innerText = formatDist(myDist);
            const won = myDist < oppDist;
            document.getElementById('res-pts').innerText = won ? "WINNER!" : "LOST";
            document.getElementById('res-pts').style.color = won ? "#38ef7d" : "#ff6b6b";
            document.getElementById('res-loc-name').innerHTML = STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag;
            
            const mpInfo = document.getElementById('res-multi-info');
            mpInfo.style.display = 'block';
            document.getElementById('res-opp-dist').innerText = formatDist(oppDist);

            const nextBtn = document.getElementById('next-btn');
            const nextBtnText = nextBtn.querySelector('.btn-content');

            if (STATE.mpModeSelected === 'challenge' && STATE.round >= STATE.maxRounds) {
                nextBtnText.innerText = "Finish Game";
                nextBtn.onclick = showSummary;
            } else {
                nextBtnText.innerText = (STATE.mpRole === 'host') ? "Next Round" : "Waiting for Host...";
                nextBtn.onclick = (STATE.mpRole === 'host') ? window.nextRound : null;
                // Host updates scores in background
                if(STATE.mpRole === 'host') {
                     get(ref(db, `games/${STATE.gameId}/scores`)).then(snap => {
                        const cur = snap.val() || { host: 0, guest: 0 };
                        update(ref(db, `games/${STATE.gameId}/scores`), {
                            host: cur.host + (guesses.host.pts || 0),
                            guest: cur.guest + (guesses.guest.pts || 0)
                        });
                     });
                }
            }
            
            document.getElementById('result-sheet').classList.add('show');
            if(won) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        function setupResultMap(uLat, aLat) {
            document.getElementById('mobile-map-toggle').style.display = 'none';
            document.getElementById('map-container').classList.add('map-result-mode', 'open');
            setTimeout(() => map.invalidateSize(), 200);

            resultMarker = L.circleMarker(aLat, { radius: 8, color: '#fff', fillColor: '#00ff00', fillOpacity: 1 }).addTo(map);
            resultLine = L.polyline([uLat, aLat], { color: '#00C6FF', weight: 4 }).addTo(map);
            
            const group = new L.featureGroup([L.marker(uLat), resultMarker]);
            map.fitBounds(group.getBounds(), { padding: [50, 50], maxZoom: 16 });
        }

        window.nextRound = () => {
            setBtnLoading('next-btn', true);

            if(STATE.mode === 'endless' || STATE.mode === 'challenge') {
                if(STATE.mode === 'challenge') STATE.round++;
                startGameLoop();
            } else if (STATE.mode === 'multi' && STATE.mpRole === 'host') {
                const nextR = STATE.round + 1;
                // Host resets guesses and moves to next round
                // We also clear previous location to prevent glitch
                update(ref(db, `games/${STATE.gameId}`), {
                    status: 'next_round',
                    round: nextR,
                    guesses: null,
                    // DO NOT CLEAR LOCATION HERE. The new location fetch happens in 'startGameLoop' equiv logic
                    // Actually, for MP, we do it manually:
                }).then(() => {
                    // Host fetches next location immediately
                    document.getElementById('loading').classList.remove('hidden');
                    pickRandomLocation().then(loc => {
                        update(ref(db, `games/${STATE.gameId}`), {
                            location: loc,
                            status: 'playing'
                        });
                        // Listener will handle UI update
                    });
                });
            }
        };

        function showSummary() {
            document.getElementById('summary-modal').style.display = 'flex';
            document.getElementById('final-score').innerText = STATE.score;
            confetti({ particleCount: 200, spread: 100 });
        }

        window.toggleMap = () => {
            const c = document.getElementById('map-container');
            const b = document.getElementById('mobile-map-toggle');
            if(c.classList.contains('open')) {
                c.classList.remove('open');
                b.innerText = "ğŸ—ºï¸";
            } else {
                c.classList.add('open');
                b.innerText = "âœ–";
                setTimeout(() => map.invalidateSize(), 300);
            }
        };

        function formatDist(m) {
            return m < 1000 ? Math.round(m) + " m" : (m/1000).toFixed(1) + " km";
        }

        window.shareResult = () => {
            const text = `I scored ${STATE.score} pts in GeoGuessr! Can you beat me?`;
            const url = `https://t.me/share/url?url=${encodeURIComponent("t.me/geogur_bot/app")}&text=${encodeURIComponent(text)}`;
            if(window.Telegram?.WebApp) window.Telegram.WebApp.openTelegramLink(url);
            else window.open(url, '_blank');
        };

        init();
    </script>
</body>
</html>
