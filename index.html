<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoGuessr</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            try {
                window.Telegram.WebApp.requestFullscreen(); 
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.disableVerticalSwipes();
            } catch (e) { console.log("Telegram FS failed", e); }
        }
    </script>

    <!-- External Libs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    
    <!-- QR Code Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ==================== EXISTING CSS (UNCHANGED) ==================== */
        :root {
            --bg-color: #0f0f12;
            --text-color: #ffffff;
            --primary-grad: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%);
            --glass-bg: rgba(20, 20, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-shadow: 0 15px 35px 0 rgba(0, 0, 0, 0.6);
            --blur: 50px;
            --safe-top: 80px; 
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'SF Pro Display', sans-serif; background: var(--bg-color); color: var(--text-color); overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .bg-blob { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5; z-index: 0; animation: floatBlob 12s infinite alternate ease-in-out; pointer-events: none; }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: #00C6FF; }
        .blob-2 { bottom: -10%; right: -10%; width: 350px; height: 350px; background: #764ba2; animation-delay: -5s; }
        .blob-3 { top: 40%; left: 40%; width: 250px; height: 250px; background: #43cea2; animation-duration: 18s; opacity: 0.3; }
        @keyframes floatBlob { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(40px, 60px) scale(1.1); } }
        .glass-panel { background: var(--glass-bg); background-image: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.00) 100%); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur)); border: 1px solid var(--glass-border); border-top: 1px solid rgba(255,255,255,0.25); border-radius: 24px; box-shadow: var(--glass-shadow), inset 0 0 20px rgba(255,255,255,0.02); }
        .hidden { display: none !important; }
        .scrollable { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #settings-btn { position: absolute; top: var(--safe-top); right: 20px; z-index: 6000; width: 44px; height: 44px; background: rgba(30, 30, 40, 0.6); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-size: 22px; backdrop-filter: blur(15px); box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: opacity 0.3s, transform 0.2s; }
        #settings-btn:active { transform: scale(0.9); }
        body.game-active #settings-btn { opacity: 0; pointer-events: none; }
        .input-code { display: block; width: 80%; margin: 20px auto; padding: 18px; font-family: inherit; font-size: 26px; font-weight: 800; text-align: center; letter-spacing: 6px; text-transform: uppercase; color: white; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 18px; backdrop-filter: blur(10px); box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
        .input-code:focus { border-color: #00C6FF; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 0 15px rgba(0, 198, 255, 0.3); }
        .input-code::placeholder { color: rgba(255,255,255,0.3); }
        .full-screen-menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; transition: opacity 0.3s ease; }
        .menu-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); z-index: -1; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        .menu-title { font-size: 3.8rem; font-weight: 900; margin-bottom: 5px; margin-top: 10px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; letter-spacing: -2px; filter: drop-shadow(0 0 35px rgba(0, 198, 255, 0.5)); }
        .menu-subtitle { font-size: 1.1rem; color: #ccc; margin-bottom: 40px; text-align: center; font-weight: 500; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .btn-main { width: 100%; max-width: 320px; padding: 20px; margin: 10px 0; border: none; border-radius: 20px; font-size: 1.15rem; font-weight: 700; cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1.5px; position: relative; display: flex; align-items: center; justify-content: center; gap: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(5px); transition: transform 0.1s, box-shadow 0.2s; }
        .btn-main:active { transform: scale(0.96); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .btn-blue { background: linear-gradient(135deg, rgba(0, 198, 255, 0.9) 0%, rgba(0, 114, 255, 0.9) 100%); }
        .btn-purple { background: linear-gradient(135deg, #FF512F 0%, #F09819 100%); }
        .btn-green { background: linear-gradient(135deg, rgba(17, 153, 142, 0.9) 0%, rgba(56, 239, 125, 0.9) 100%); }
        .btn-red { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .btn-dark { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); }
        .btn-spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        .btn-main.loading .btn-content { display: none; }
        .btn-main.loading .btn-spinner { display: block; }
        #friend-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .friend-panel { padding: 30px 25px; width: 100%; max-width: 350px; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        #top-hud { position: absolute; top: var(--safe-top); left: 0; width: 100%; padding: 0 15px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: flex-start; z-index: 100; pointer-events: none; }
        #timer-box, #host-controls, #score-box { background: var(--glass-bg); background-image: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.0) 100%); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.2); border-radius: 18px; padding: 12px 18px; color: white; margin-bottom: 8px; pointer-events: all; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        #timer-box { font-size: 1.5rem; font-weight: 800; font-variant-numeric: tabular-nums; }
        #timer-box.warning { border-color: #ff4b2b; color: #ff4b2b; animation: pulse 1s infinite; }
        #score-box { text-align: right; }
        .score-val { color: #f1c40f; font-size: 1.2rem; font-weight: 800; font-family: monospace; text-shadow: 0 2px 10px rgba(0,0,0,0.5);}
        .mini-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color:white; padding:6px 12px; border-radius:8px; font-weight:600; cursor:pointer;}
        #mly { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        #mobile-map-toggle { position: absolute; bottom: 35px; right: 20px; width: 70px; height: 70px; border-radius: 50%; background: var(--primary-grad); color: white; font-size: 32px; border: 3px solid rgba(255,255,255,0.3); z-index: 100; display: flex; justify-content: center; align-items: center; box-shadow: 0 15px 40px rgba(0,0,0,0.6); transition: transform 0.2s; }
        #mobile-map-toggle:active { transform: scale(0.9); }
        #map-container { position: absolute; bottom: 120px; right: 20px; width: 90vw; max-width: 450px; height: 45vh; background: rgba(30, 30, 40, 0.85); backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px); border: 1px solid rgba(255,255,255,0.25); border-radius: 28px; box-shadow: 0 30px 60px rgba(0,0,0,0.7); z-index: 200; transform: scale(0); opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column; padding: 8px; box-sizing: border-box; }
        #map-container.open { transform: scale(1); opacity: 1; pointer-events: all; }
        #map-container.map-result-mode { bottom: 0 !important; right: 0 !important; width: 100% !important; height: 100% !important; border-radius: 0 !important; background: #1a1a1a; padding: 0; max-width: none; z-index: 10; }
        #map { flex-grow: 1; width: 100%; border-radius: 22px; }
        #confirm-btn { width: 100%; padding: 18px; margin-top: 8px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.4); font-weight: 800; border: none; text-transform: uppercase; border-radius: 16px; cursor: not-allowed; transition: 0.3s; letter-spacing: 1px; }
        #confirm-btn.active { background: var(--primary-grad); color: white; cursor: pointer; box-shadow: 0 5px 20px rgba(0, 198, 255, 0.4); }
        #result-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(15, 15, 25, 0.95); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px); border-top: 1px solid rgba(255,255,255,0.2); border-top-left-radius: 35px; border-top-right-radius: 35px; z-index: 3000; transform: translateY(110%); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); padding: 35px 25px 50px 25px; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; color: white; box-shadow: 0 -15px 60px rgba(0,0,0,0.8); }
        #result-sheet.show { transform: translateY(0); }
        .result-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .big-text { font-size: 2.5rem; font-weight: 900; line-height: 1; margin-bottom: 5px; text-shadow: 0 5px 15px rgba(0,0,0,0.5);}
        .sub-text { color: #aaa; font-size: 1.1rem; }
        .btn-group { display: flex; gap: 15px; margin-top: 10px; }
        .btn-primary { background: var(--primary-grad); color: white; padding: 20px; border: none; border-radius: 18px; font-size: 1.1rem; font-weight: 800; flex: 1; box-shadow: 0 8px 20px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; text-transform: uppercase; letter-spacing: 1px; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; padding: 16px; border: 1px solid rgba(255,255,255,0.1); border-radius: 18px; font-size: 24px; width: 75px; cursor: pointer; }
        .toggle-group { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; }
        .toggle-btn { flex: 1; padding: 18px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: #aaa; font-weight: 700; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
        .toggle-btn.selected { background: var(--primary-grad); color: white; border-color: transparent; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #player-list { width: 100%; max-width: 350px; max-height: 200px; margin: 20px 0; overflow-y: auto; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: rgba(255,255,255,0.08); margin-bottom: 8px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.05); }
        #profile-screen { background: rgba(10, 10, 15, 0.95); z-index: 6000; }
        .profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
        .big-avatar { width: 90px; height: 90px; border-radius: 50%; background: var(--primary-grad); display: flex; justify-content: center; align-items: center; font-size: 40px; margin-bottom: 15px; box-shadow: 0 0 30px rgba(0,198,255,0.5); border: 2px solid white; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 350px; margin-bottom: 30px; }
        .stat-card { background: rgba(255,255,255,0.06); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .history-item { background: rgba(255,255,255,0.04); padding: 14px; border-radius: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; border: 1px solid rgba(255,255,255,0.03); }
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f12; z-index: 8000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #loading lottie-player { margin-bottom: 30px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #history-list { width: 100%; padding: 0 10px; box-sizing: border-box; max-height: 140px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin: 10px 0; border-top: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); scrollbar-width: none; }
        #history-list::-webkit-scrollbar { display: none; }
        
        /* ==================== NEW CSS (UPDATES) ==================== */

        /* 1. Country Grid */
        .country-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 350px;
            margin: 20px 0;
            padding-bottom: 40px;
        }
        .country-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .country-card:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.1); }
        .country-flag { font-size: 40px; margin-bottom: 8px; }
        .country-name { font-size: 14px; font-weight: 700; color: #ddd; text-align: center; }

        /* 2. QR Code Styles */
        #qr-container {
            background: white;
            padding: 15px;
            border-radius: 18px;
            margin: 10px 0 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #qr-scanner-btn {
            background: transparent;
            border: 1px dashed rgba(255,255,255,0.4);
            color: rgba(255,255,255,0.8);
            padding: 15px;
            width: 100%;
            border-radius: 18px;
            margin-top: 10px;
            cursor: pointer;
        }

        /* 3. Casino / Bot Mode UI */
        .bet-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            margin-bottom: 20px;
        }
        .bet-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 15px;
            text-align: center;
            color: #aaa;
            cursor: pointer;
            transition: 0.3s;
        }
        .bet-btn.selected {
            background: var(--primary-grad);
            color: white;
            border-color: transparent;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,198,255,0.3);
        }
        .bet-btn .odds { font-size: 24px; font-weight: 900; margin-bottom: 5px; display: block; }
        .bet-btn .desc { font-size: 12px; font-weight: 600; text-transform: uppercase; }

        /* Bot Animation Elements */
        .bot-cursor {
            position: fixed;
            width: 32px;
            height: 32px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' stroke='black' stroke-width='1'%3E%3Cpath d='M5.5 3.5l12 11.5l-6 1l4 5.5l-2.5 1.5l-4-5.5l-2.5 4z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 9999;
            pointer-events: none;
            transition: top 1.5s cubic-bezier(0.45, 0, 0.55, 1), left 1.5s cubic-bezier(0.45, 0, 0.55, 1);
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
            display: none;
        }
        
        .bot-bubble {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: black;
            padding: 15px 25px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 14px;
            z-index: 500;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            max-width: 80%;
            text-align: center;
        }
        .bot-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            margin-left: -8px;
            border-width: 8px 8px 0;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        .bot-bubble.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Casino Mode Overrides */
        body.casino-mode #map-container { pointer-events: none; }
        body.casino-mode #confirm-btn { display: none; }
        body.casino-mode #mobile-map-toggle { display: none; }
        body.casino-mode .bot-cursor { display: block; }

    </style>
</head>
<body>

    <!-- Background Blobs -->
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>

    <!-- SETTINGS / LANG TOGGLE -->
    <button id="settings-btn" onclick="window.toggleLanguage()">ğŸŒ</button>

    <!-- LOADING -->
    <div id="loading">
        <lottie-player 
            src="https://raw.githubusercontent.com/Vasiliy-katsyka/GeoGuessr/main/ChicklingEmoji_AgAD1S0AAkOY8Ug.json" 
            background="transparent" 
            speed="1" 
            style="width: 150px; height: 150px; margin-bottom: 30px;" 
            loop autoplay>
        </lottie-player>
        <h3 id="load-text" style="color: #666; font-weight:400; letter-spacing:1px; margin-top:-10px;">Loading...</h3>
    </div>

    <!-- BOT ANIMATION ELEMENTS -->
    <div id="bot-cursor" class="bot-cursor"></div>
    <div id="bot-bubble" class="bot-bubble">I think I saw a bear...</div>

    <!-- MAIN MENU -->
    <div id="main-menu" class="full-screen-menu hidden">
        <div class="menu-overlay"></div>
        <lottie-player 
            src="https://raw.githubusercontent.com/Vasiliy-katsyka/GeoGuessr/main/RestrictedEmoji_AgADHFgAAt1K8Eo.json" 
            background="transparent" 
            speed="1" 
            style="width: 120px; height: 120px; margin-bottom: -20px;" 
            loop autoplay>
        </lottie-player>

        <div class="menu-title" data-i18n="app_title">GeoGuessr</div>
        <div class="menu-subtitle" data-i18n="app_subtitle">Explore the world & challenge friends</div>

        <button class="btn-main btn-blue" onclick="window.startEndless()">
            <span class="btn-content" data-i18n="btn_endless">âˆ Endless Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-purple" onclick="window.openCountryMenu()">
            <span class="btn-content" data-i18n="btn_countries">ğŸ³ï¸ Country Mode</span>
        </button>
        <button class="btn-main btn-green" onclick="window.openFriendMenu()">
            <span class="btn-content" data-i18n="btn_friend">ğŸ‘¥ Party Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-red" onclick="window.openCasinoMenu()">
            <span class="btn-content" data-i18n="btn_casino">ğŸ° Bot Casino</span>
        </button>
        <button class="btn-main btn-dark" onclick="window.openProfile()">
            <span class="btn-content" data-i18n="btn_profile">ğŸ‘¤ My Profile</span>
        </button>
    </div>

    <!-- COUNTRY SELECT MENU -->
    <div id="country-menu" class="full-screen-menu hidden scrollable">
        <div class="menu-overlay"></div>
        <h2 style="margin-bottom: 10px;" data-i18n="title_country">Select Country</h2>
        <p style="color:#aaa; text-align:center; font-size:0.9rem;" data-i18n="sub_country">10 Locations each</p>
        
        <div class="country-grid" id="country-grid">
            <!-- JS will populate -->
        </div>

        <button class="btn-main btn-dark" style="position:fixed; bottom:20px; max-width:200px;" onclick="window.showMainMenu()" data-i18n="btn_back">Back</button>
    </div>

    <!-- CASINO / BOT BETTING MENU -->
    <div id="casino-menu" class="full-screen-menu hidden">
        <div class="menu-overlay"></div>
        <h2 style="margin-bottom: 5px;" data-i18n="title_casino">Bot Watcher</h2>
        <p style="color:#aaa; text-align:center; font-size:0.9rem; margin-bottom:20px;" data-i18n="sub_casino">Bet XP on Auto-Boris</p>

        <div class="glass-panel" style="padding: 20px; width: 100%; max-width: 340px; text-align:center;">
            <div style="font-size: 1.2rem; color: #f1c40f; font-weight:800; margin-bottom:15px;">
                <span data-i18n="lbl_wallet">Wallet:</span> <span id="casino-wallet">0</span> XP
            </div>

            <div class="bet-grid">
                <div class="bet-btn" onclick="window.selectBet('god')" id="bet-god">
                    <span class="odds">15x</span>
                    <span class="desc" data-i18n="bet_god">God Mode (<10km)</span>
                </div>
                <div class="bet-btn" onclick="window.selectBet('solid')" id="bet-solid">
                    <span class="odds">3x</span>
                    <span class="desc" data-i18n="bet_solid">Solid (<500km)</span>
                </div>
                <div class="bet-btn" onclick="window.selectBet('drunk')" id="bet-drunk">
                    <span class="odds">2x</span>
                    <span class="desc" data-i18n="bet_drunk">Drunk (>2000km)</span>
                </div>
                <div class="bet-btn" onclick="window.selectBet('ocean')" id="bet-ocean">
                    <span class="odds">10x</span>
                    <span class="desc" data-i18n="bet_ocean">Ocean Splash</span>
                </div>
            </div>

            <input type="number" id="bet-amount" class="input-code" style="font-size:20px; padding:12px; margin: 10px 0;" placeholder="Bet Amount (XP)" value="100">

            <button class="btn-main btn-purple" style="width:100%; margin-top:10px;" onclick="window.startBotRound()">
                <span data-i18n="btn_watch">Watch Bot Play</span>
            </button>
        </div>
        <button class="btn-main btn-dark" style="margin-top: 20px;" onclick="window.showMainMenu()" data-i18n="btn_back">Back</button>
    </div>

    <!-- PROFILE SCREEN -->
    <div id="profile-screen" class="full-screen-menu hidden scrollable">
        <div class="menu-overlay"></div>
        <div class="profile-header">
            <div class="big-avatar" id="pf-avatar">ğŸ‘¤</div>
            <h2 id="pf-name">User</h2>
            <div style="color: #aaa;" data-i18n="pf_rank">Novice Explorer</div>
        </div>
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-val" id="pf-total-games">0</div>
                <div class="stat-label" data-i18n="lbl_games">Rounds</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="pf-total-score">0</div>
                <div class="stat-label" data-i18n="lbl_score">Total XP</div>
            </div>
        </div>
        <h3 style="align-self: flex-start; margin-left: 20px;" data-i18n="lbl_history">History</h3>
        <div id="history-list" class="history-list"></div>
        <button class="btn-main btn-dark" style="margin-top: 30px;" onclick="window.closeProfile()" data-i18n="btn_back">Back</button>
        <button class="btn-main btn-red" style="margin-top: 10px; opacity:0.8; transform:scale(0.9);" onclick="window.clearData()">ğŸ—‘ï¸ Clear Data</button>
    </div>

    <!-- FRIEND MENU -->
    <div id="friend-menu" class="full-screen-menu hidden">
        <div class="menu-overlay"></div>
        <h2 style="margin-bottom: 20px; font-size:2rem;" data-i18n="friend_mode">Party Mode</h2>
        
        <div class="glass-panel friend-panel">
            <h4 style="margin:0 0 15px 0; color:#ccc; font-size:0.8rem; text-transform:uppercase;" data-i18n="lbl_create">Create Room</h4>
            <div class="toggle-group" style="width:100%;">
                <button id="mp-mode-endless" class="toggle-btn selected" onclick="window.selectMpMode('endless')" data-i18n="mode_endless">Endless</button>
                <button id="mp-mode-challenge" class="toggle-btn" onclick="window.selectMpMode('challenge')" data-i18n="mode_challenge">Challenge</button>
            </div>
            <button id="btn-create" class="btn-main btn-green" style="width:100%; margin:0;" onclick="window.createRoom()">
                <span class="btn-content" data-i18n="btn_create_play">Create & Play</span>
                <div class="btn-spinner"></div>
            </button>
        </div>

        <div style="color:#aaa; font-weight:bold; margin-bottom: 20px;">â€” OR â€”</div>

        <div class="glass-panel friend-panel" style="text-align:center;">
            <h4 style="margin:0 0 15px 0; color:#ccc; font-size:0.8rem; text-transform:uppercase;" data-i18n="lbl_join">Join Room</h4>
            <input type="text" id="join-code" class="input-code" placeholder="CODE" maxlength="5">
            
            <button id="qr-scanner-btn" onclick="window.scanQrJoin()">ğŸ“· Scan QR Code</button>

            <button id="btn-join" class="btn-main btn-blue" style="width:100%; margin-top:15px;" onclick="window.joinRoom()">
                <span class="btn-content" data-i18n="btn_join">Join Room</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
        <button class="btn-main btn-dark" style="width:auto; padding: 10px 30px; margin-top: 20px;" onclick="window.showMainMenu()" data-i18n="btn_back">Back</button>
    </div>

    <!-- LOBBY -->
    <div id="lobby-screen" class="full-screen-menu hidden">
        <div class="menu-overlay"></div>
        
        <div id="qr-container"></div>
        <h1 id="lobby-code-display" style="font-size:3.5rem; background: var(--primary-grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:5px; margin:0;">----</h1>
        <p style="color:#ccc;" data-i18n="lbl_share_code">Share code with friends</p>
        
        <div id="player-list"></div>

        <div id="host-actions" class="hidden" style="width:100%; max-width:320px;">
            <button class="btn-main btn-green" onclick="window.hostStartGame()" data-i18n="btn_start_game">Start Game</button>
        </div>
        
        <div id="lobby-status" style="margin-top:20px; color:#aaa;" data-i18n="lbl_waiting">Waiting for players...</div>
        <button class="btn-main btn-red" style="width:auto; margin-top: 30px;" onclick="window.leaveLobby()" data-i18n="btn_leave">Leave</button>
    </div>

    <!-- GAME UI -->
    <div id="mly"></div>
    
    <div id="top-hud">
        <div style="display:flex; flex-direction:column;">
            <div id="timer-box">02:00</div>
            <div id="host-controls" class="hidden">
                <span style="font-size:10px; color:#aaa; margin-bottom:2px;">ADMIN</span>
                <button class="mini-btn" onclick="window.hostForceRoundEnd()" data-i18n="btn_force_end">End Round</button>
            </div>
        </div>
        <div id="score-box">
            <div class="score-row" id="round-indicator" style="display:none; color:#aaa; font-size:0.8rem;">ROUND 1/5</div>
            <div class="score-row"><span data-i18n="lbl_me">YOU</span> <span id="score-me" class="score-val">0</span></div>
            <div id="mp-scores" style="display:none; flex-direction:column; gap:2px; margin-top:5px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;"></div>
        </div>
    </div>

    <button id="mobile-map-toggle" onclick="window.toggleMap()">ğŸ—ºï¸</button>

    <div id="map-container">
        <div id="map"></div>
        <button id="confirm-btn" onclick="window.submitGuess()" data-i18n="btn_guess_tap">Tap map to guess</button>
    </div>

    <div id="result-sheet">
        <div class="result-row">
            <div>
                <div class="big-text" id="res-dist">0 m</div>
                <div style="color:#f1c40f; font-weight:bold; font-size:1.4rem;" id="res-pts">+0 pts</div>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:bold; font-size:1.1rem; color: #ddd;" data-i18n="lbl_location">Location</div>
                <div id="res-loc-name" class="sub-text">City, Country</div>
            </div>
        </div>
        
        <div id="res-mp-list" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; display:none; max-height:100px; overflow-y:auto; margin-top:10px;"></div>

        <div class="btn-group">
            <button class="btn-secondary" onclick="window.shareResult()">ğŸ“¤</button>
            <button class="btn-primary" id="next-btn" onclick="window.nextRound()">
                <span class="btn-content" data-i18n="btn_next">Play Next</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
    </div>

    <!-- SUMMARY MODAL -->
    <div id="summary-modal" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:7000; display:none; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="text-transform:uppercase; letter-spacing:2px;" data-i18n="lbl_game_over">Game Over</h1>
        <div class="summary-score" id="final-score" style="font-size:4rem; font-weight:900; background:var(--primary-grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:20px 0;">0</div>
        <button class="btn-main btn-blue" onclick="window.location.reload()" data-i18n="btn_menu">Menu</button>
    </div>

    <!-- JS MODULES -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // CONFIG & TRANSLATIONS
        const firebaseConfig = {
            apiKey: "AIzaSyDJjo66zCwODJW1J2SoVQ2B8tIH5FPUu1A",
            authDomain: "mytube-cd424.firebaseapp.com",
            databaseURL: "https://mytube-cd424-default-rtdb.firebaseio.com",
            projectId: "mytube-cd424",
            storageBucket: "mytube-cd424.appspot.com",
            messagingSenderId: "865512387483",
            appId: "1:865512387483:web:de8245f509dba9bbd5273e"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const MLY_TOKEN = 'MLY|26213154491618951|523c0418de2d6a8118aefdab3284d6c2';

        const TR = {
            en: {
                app_title: "GeoGuessr", app_subtitle: "Explore the world & challenge friends",
                btn_endless: "âˆ Endless Mode", btn_countries: "ğŸ³ï¸ Country Mode", btn_challenge: "â±ï¸ Challenge Mode", btn_friend: "ğŸ‘¥ Party Mode", btn_profile: "ğŸ‘¤ My Profile",
                btn_casino: "ğŸ° Bot Casino", btn_back: "Back", friend_mode: "Party Mode", lbl_create: "Create Room", lbl_join: "Join Room",
                mode_endless: "Endless", mode_challenge: "Challenge", btn_create_play: "Create & Play", btn_join: "Join Room",
                lbl_share_code: "Share code with friends", lbl_waiting: "Waiting for players...", btn_leave: "Leave", btn_start_game: "Start Game",
                lbl_me: "YOU", btn_force_end: "End Round", btn_guess_tap: "Tap map to guess", btn_guess_confirm: "CONFIRM GUESS", btn_wait: "WAITING...",
                lbl_location: "Location", btn_next: "Play Next", btn_finish: "Finish Game", lbl_game_over: "Game Over", btn_menu: "Main Menu",
                pf_rank: "Explorer", lbl_games: "Rounds", lbl_score: "Total XP", lbl_history: "History",
                msg_kicked: "You were kicked from the room.", title_country: "Select Country", sub_country: "10 Locations each",
                title_casino: "Bot Watcher", sub_casino: "Bet XP on Auto-Boris", lbl_wallet: "Wallet:", 
                bet_god: "God Mode (<10km)", bet_solid: "Solid (<500km)", bet_drunk: "Drunk (>2000km)", bet_ocean: "Ocean Splash",
                btn_watch: "Watch Bot Play"
            },
            ru: {
                app_title: "Ğ“ĞµĞ¾Ğ“ĞµÑÑÑÑ€", app_subtitle: "Ğ˜ÑÑĞ»ĞµĞ´ÑƒĞ¹ Ğ¼Ğ¸Ñ€ Ğ¸ Ğ¸Ğ³Ñ€Ğ°Ğ¹ Ñ Ğ´Ñ€ÑƒĞ·ÑŒÑĞ¼Ğ¸",
                btn_endless: "âˆ Ğ‘ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹", btn_countries: "ğŸ³ï¸ Ğ¡Ñ‚Ñ€Ğ°Ğ½Ñ‹", btn_challenge: "â±ï¸ ĞĞ° Ğ²Ñ€ĞµĞ¼Ñ", btn_friend: "ğŸ‘¥ Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ¹", btn_profile: "ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ",
                btn_casino: "ğŸ° Ğ‘Ğ¾Ñ‚ ĞšĞ°Ğ·Ğ¸Ğ½Ğ¾", btn_back: "ĞĞ°Ğ·Ğ°Ğ´", friend_mode: "Ğ˜Ğ³Ñ€Ğ° Ñ Ğ´Ñ€ÑƒĞ·ÑŒÑĞ¼Ğ¸", lbl_create: "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñƒ", lbl_join: "Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾ ĞºĞ¾Ğ´Ñƒ",
                mode_endless: "Ğ‘ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾", mode_challenge: "Ğ§ĞµĞ»Ğ»ĞµĞ½Ğ´Ğ¶", btn_create_play: "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ", btn_join: "Ğ’Ğ¾Ğ¹Ñ‚Ğ¸",
                lbl_share_code: "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ ĞºĞ¾Ğ´ Ğ´Ñ€ÑƒĞ·ÑŒÑĞ¼", lbl_waiting: "Ğ–Ğ´ĞµĞ¼ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²...", btn_leave: "Ğ’Ñ‹Ğ¹Ñ‚Ğ¸", btn_start_game: "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ",
                lbl_me: "Ğ’Ğ«", btn_force_end: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ", btn_guess_tap: "ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ñƒ", btn_guess_confirm: "ĞŸĞĞ”Ğ¢Ğ’Ğ•Ğ Ğ”Ğ˜Ğ¢Ğ¬", btn_wait: "ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ•...",
                lbl_location: "Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ", btn_next: "Ğ”Ğ°Ğ»ÑŒÑˆĞµ", btn_finish: "Ğ¤Ğ¸Ğ½Ğ¸Ñˆ", lbl_game_over: "ĞšĞ¾Ğ½ĞµÑ† Ğ¸Ğ³Ñ€Ñ‹", btn_menu: "Ğ’ Ğ¼ĞµĞ½Ñ",
                pf_rank: "Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ", lbl_games: "Ğ Ğ°ÑƒĞ½Ğ´Ñ‹", lbl_score: "Ğ’ÑĞµĞ³Ğ¾ XP", lbl_history: "Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ",
                msg_kicked: "Ğ’Ñ‹ Ğ±Ñ‹Ğ»Ğ¸ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ñ‹ Ğ¸Ğ· ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹.", title_country: "Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹", sub_country: "10 Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹",
                title_casino: "Ğ‘Ğ¾Ñ‚-Ğ—Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒ", sub_casino: "Ğ¡Ñ‚Ğ°Ğ²ÑŒ XP Ğ½Ğ° ĞĞ²Ñ‚Ğ¾-Ğ‘Ğ¾Ñ€Ğ¸ÑĞ°", lbl_wallet: "Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ:", 
                bet_god: "Ğ‘Ğ¾Ğ³ (<10ĞºĞ¼)", bet_solid: "Ğ¡Ğ¾Ğ¹Ğ´ĞµÑ‚ (<500ĞºĞ¼)", bet_drunk: "ĞŸÑŒÑĞ½ (>2000ĞºĞ¼)", bet_ocean: "ĞĞºĞµĞ°Ğ½",
                btn_watch: "Ğ¡Ğ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ"
            }
        };

        const USER = (window.Telegram?.WebApp?.initDataUnsafe?.user) || { id: 'test_'+Math.floor(Math.random()*1000), first_name: 'Guest', language_code: 'en' };
        
        const STATE = {
            lang: localStorage.getItem('geo_lang') || (USER.language_code === 'ru' ? 'ru' : 'en'),
            mode: 'menu', // endless, challenge, multi, country, casino
            mpRole: null, 
            gameId: null,
            myUid: USER.id.toString(),
            myName: USER.first_name,
            round: 1,
            maxRounds: 5,
            score: 0,
            timer: null,
            timeLeft: 120,
            currentLoc: null,
            isLocked: false,
            mpModeSelected: 'endless',
            players: {}, 
            history: JSON.parse(localStorage.getItem('geo_history') || '[]'),
            totalGames: parseInt(localStorage.getItem('geo_total_games') || '0'),
            totalScore: parseInt(localStorage.getItem('geo_total_score') || '0'),
            
            // New States
            countryFilter: null,
            betAmount: 100,
            betOption: null,
            botInterval: null
        };

        const LOCATIONS = [
            // --- RUSSIA (Existing + 8 New) ---
            { name: "Saint Petersburg, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 59.9311, lng: 30.3609 },
            { name: "Moscow, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 55.7558, lng: 37.6173 },
            { name: "Kazan, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 55.7963, lng: 49.1088 },
            { name: "Sochi, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 43.5852, lng: 39.7231 },
            { name: "Novosibirsk, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 55.0302, lng: 82.9204 },
            { name: "Yekaterinburg, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 56.8389, lng: 60.6057 },
            { name: "Vladivostok, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 43.1198, lng: 131.8869 },
            { name: "Nizhny Novgorod, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 56.2965, lng: 43.9361 },
            { name: "Kaliningrad, Russia", flag: "ğŸ‡·ğŸ‡º", lat: 54.7104, lng: 20.4522 },

            // --- NORTH AMERICA ---
            { name: "New York, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 40.7128, lng: -74.0060 },
            { name: "Los Angeles, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 34.0522, lng: -118.2437 },
            { name: "Chicago, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 41.8781, lng: -87.6298 },
            { name: "San Francisco, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 37.7749, lng: -122.4194 },
            { name: "Miami, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 25.7617, lng: -80.1918 },
            { name: "Las Vegas, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 36.1699, lng: -115.1398 },
            { name: "Seattle, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 47.6062, lng: -122.3321 },
            { name: "Boston, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 42.3601, lng: -71.0589 },
            { name: "Austin, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 30.2672, lng: -97.7431 },
            { name: "Denver, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 39.7392, lng: -104.9903 },
            { name: "New Orleans, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 29.9511, lng: -90.0715 },
            { name: "Philadelphia, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 39.9526, lng: -75.1652 },
            { name: "San Diego, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 32.7157, lng: -117.1611 },
            { name: "Portland, USA", flag: "ğŸ‡ºğŸ‡¸", lat: 45.5051, lng: -122.6750 },
            { name: "Toronto, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 43.6532, lng: -79.3832 },
            { name: "Vancouver, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 49.2827, lng: -123.1207 },
            { name: "Montreal, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 45.5017, lng: -73.5673 },
            { name: "Calgary, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 51.0447, lng: -114.0719 },
            { name: "Ottawa, Canada", flag: "ğŸ‡¨ğŸ‡¦", lat: 45.4215, lng: -75.6972 },
            { name: "Mexico City, Mexico", flag: "ğŸ‡²ğŸ‡½", lat: 19.4326, lng: -99.1332 },
            { name: "Guadalajara, Mexico", flag: "ğŸ‡²ğŸ‡½", lat: 20.6597, lng: -103.3496 },
            { name: "Monterrey, Mexico", flag: "ğŸ‡²ğŸ‡½", lat: 25.6866, lng: -100.3161 },

            // --- SOUTH AMERICA ---
            { name: "SÃ£o Paulo, Brazil", flag: "ğŸ‡§ğŸ‡·", lat: -23.5505, lng: -46.6333 },
            { name: "Rio de Janeiro, Brazil", flag: "ğŸ‡§ğŸ‡·", lat: -22.9068, lng: -43.1729 },
            { name: "BrasÃ­lia, Brazil", flag: "ğŸ‡§ğŸ‡·", lat: -15.7975, lng: -47.8919 },
            { name: "Salvador, Brazil", flag: "ğŸ‡§ğŸ‡·", lat: -12.9777, lng: -38.5016 },
            { name: "Buenos Aires, Argentina", flag: "ğŸ‡¦ğŸ‡·", lat: -34.6037, lng: -58.3816 },
            { name: "Mendoza, Argentina", flag: "ğŸ‡¦ğŸ‡·", lat: -32.8895, lng: -68.8458 },
            { name: "Santiago, Chile", flag: "ğŸ‡¨ğŸ‡±", lat: -33.4489, lng: -70.6693 },
            { name: "Valparaiso, Chile", flag: "ğŸ‡¨ğŸ‡±", lat: -33.0472, lng: -71.6127 },
            { name: "BogotÃ¡, Colombia", flag: "ğŸ‡¨ğŸ‡´", lat: 4.7110, lng: -74.0721 },
            { name: "MedellÃ­n, Colombia", flag: "ğŸ‡¨ğŸ‡´", lat: 6.2442, lng: -75.5812 },
            { name: "Lima, Peru", flag: "ğŸ‡µğŸ‡ª", lat: -12.0464, lng: -77.0428 },
            { name: "Cusco, Peru", flag: "ğŸ‡µğŸ‡ª", lat: -13.5320, lng: -71.9675 },
            { name: "Quito, Ecuador", flag: "ğŸ‡ªğŸ‡¨", lat: -0.1807, lng: -78.4678 },
            { name: "Montevideo, Uruguay", flag: "ğŸ‡ºğŸ‡¾", lat: -34.9011, lng: -56.1645 },
            { name: "La Paz, Bolivia", flag: "ğŸ‡§ğŸ‡´", lat: -16.5004, lng: -68.1193 },

            // --- EUROPE ---
            { name: "London, UK", flag: "ğŸ‡¬ğŸ‡§", lat: 51.5074, lng: -0.1278 },
            { name: "Manchester, UK", flag: "ğŸ‡¬ğŸ‡§", lat: 53.4808, lng: -2.2426 },
            { name: "Edinburgh, UK", flag: "ğŸ‡¬ğŸ‡§", lat: 55.9533, lng: -3.1883 },
            { name: "Paris, France", flag: "ğŸ‡«ğŸ‡·", lat: 48.8566, lng: 2.3522 },
            { name: "Lyon, France", flag: "ğŸ‡«ğŸ‡·", lat: 45.7640, lng: 4.8357 },
            { name: "Marseille, France", flag: "ğŸ‡«ğŸ‡·", lat: 43.2965, lng: 5.3698 },
            { name: "Nice, France", flag: "ğŸ‡«ğŸ‡·", lat: 43.7102, lng: 7.2620 },
            { name: "Madrid, Spain", flag: "ğŸ‡ªğŸ‡¸", lat: 40.4168, lng: -3.7038 },
            { name: "Barcelona, Spain", flag: "ğŸ‡ªğŸ‡¸", lat: 41.3851, lng: 2.1734 },
            { name: "Seville, Spain", flag: "ğŸ‡ªğŸ‡¸", lat: 37.3891, lng: -5.9845 },
            { name: "Valencia, Spain", flag: "ğŸ‡ªğŸ‡¸", lat: 39.4699, lng: -0.3763 },
            { name: "Lisbon, Portugal", flag: "ğŸ‡µğŸ‡¹", lat: 38.7223, lng: -9.1393 },
            { name: "Porto, Portugal", flag: "ğŸ‡µğŸ‡¹", lat: 41.1579, lng: -8.6291 },
            { name: "Berlin, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 52.5200, lng: 13.4050 },
            { name: "Munich, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 48.1351, lng: 11.5820 },
            { name: "Hamburg, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 53.5511, lng: 9.9937 },
            { name: "Frankfurt, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 50.1109, lng: 8.6821 },
            { name: "Cologne, Germany", flag: "ğŸ‡©ğŸ‡ª", lat: 50.9375, lng: 6.9603 },
            { name: "Rome, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 41.9028, lng: 12.4964 },
            { name: "Milan, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 45.4642, lng: 9.1900 },
            { name: "Venice, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 45.4408, lng: 12.3155 },
            { name: "Florence, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 43.7696, lng: 11.2558 },
            { name: "Naples, Italy", flag: "ğŸ‡®ğŸ‡¹", lat: 40.8518, lng: 14.2681 },
            { name: "Amsterdam, Netherlands", flag: "ğŸ‡³ğŸ‡±", lat: 52.3676, lng: 4.9041 },
            { name: "Rotterdam, Netherlands", flag: "ğŸ‡³ğŸ‡±", lat: 51.9244, lng: 4.4777 },
            { name: "Brussels, Belgium", flag: "ğŸ‡§ğŸ‡ª", lat: 50.8503, lng: 4.3517 },
            { name: "Vienna, Austria", flag: "ğŸ‡¦ğŸ‡¹", lat: 48.2082, lng: 16.3738 },
            { name: "Prague, Czechia", flag: "ğŸ‡¨ğŸ‡¿", lat: 50.0755, lng: 14.4378 },
            { name: "Budapest, Hungary", flag: "ğŸ‡­ğŸ‡º", lat: 47.4979, lng: 19.0402 },
            { name: "Stockholm, Sweden", flag: "ğŸ‡¸ğŸ‡ª", lat: 59.3293, lng: 18.0686 },
            { name: "Gothenburg, Sweden", flag: "ğŸ‡¸ğŸ‡ª", lat: 57.7089, lng: 11.9746 },
            { name: "Oslo, Norway", flag: "ğŸ‡³ğŸ‡´", lat: 59.9139, lng: 10.7522 },
            { name: "Bergen, Norway", flag: "ğŸ‡³ğŸ‡´", lat: 60.3913, lng: 5.3221 },
            { name: "Helsinki, Finland", flag: "ğŸ‡«ğŸ‡®", lat: 60.1699, lng: 24.9384 },
            { name: "Copenhagen, Denmark", flag: "ğŸ‡©ğŸ‡°", lat: 55.6761, lng: 12.5683 },
            { name: "Aarhus, Denmark", flag: "ğŸ‡©ğŸ‡°", lat: 56.1629, lng: 10.2039 },
            { name: "Warsaw, Poland", flag: "ğŸ‡µğŸ‡±", lat: 52.2297, lng: 21.0122 },
            { name: "Krakow, Poland", flag: "ğŸ‡µğŸ‡±", lat: 50.0647, lng: 19.9450 },
            { name: "Gdansk, Poland", flag: "ğŸ‡µğŸ‡±", lat: 54.3520, lng: 18.6466 },
            { name: "Athens, Greece", flag: "ğŸ‡¬ğŸ‡·", lat: 37.9838, lng: 23.7275 },
            { name: "Thessaloniki, Greece", flag: "ğŸ‡¬ğŸ‡·", lat: 40.6401, lng: 22.9444 },
            { name: "Zurich, Switzerland", flag: "ğŸ‡¨ğŸ‡­", lat: 47.3769, lng: 8.5417 },
            { name: "Geneva, Switzerland", flag: "ğŸ‡¨ğŸ‡­", lat: 46.2044, lng: 6.1432 },
            { name: "Dublin, Ireland", flag: "ğŸ‡®ğŸ‡ª", lat: 53.3498, lng: -6.2603 },
            { name: "Zagreb, Croatia", flag: "ğŸ‡­ğŸ‡·", lat: 45.8150, lng: 15.9819 },
            { name: "Dubrovnik, Croatia", flag: "ğŸ‡­ğŸ‡·", lat: 42.6507, lng: 18.0944 },
            { name: "Bucharest, Romania", flag: "ğŸ‡·ğŸ‡´", lat: 44.4268, lng: 26.1025 },
            { name: "Sofia, Bulgaria", flag: "ğŸ‡§ğŸ‡¬", lat: 42.6977, lng: 23.3219 },
            { name: "Belgrade, Serbia", flag: "ğŸ‡·ğŸ‡¸", lat: 44.7866, lng: 20.4489 },
            { name: "Tallinn, Estonia", flag: "ğŸ‡ªğŸ‡ª", lat: 59.4370, lng: 24.7536 },
            { name: "Riga, Latvia", flag: "ğŸ‡±ğŸ‡»", lat: 56.9496, lng: 24.1052 },
            { name: "Vilnius, Lithuania", flag: "ğŸ‡±ğŸ‡¹", lat: 54.6872, lng: 25.2797 },
            { name: "Reykjavik, Iceland", flag: "ğŸ‡®ğŸ‡¸", lat: 64.1265, lng: -21.8174 },

            // --- ASIA ---
            { name: "Istanbul, Turkey", flag: "ğŸ‡¹ğŸ‡·", lat: 41.0082, lng: 28.9784 },
            { name: "Ankara, Turkey", flag: "ğŸ‡¹ğŸ‡·", lat: 39.9334, lng: 32.8597 },
            { name: "Antalya, Turkey", flag: "ğŸ‡¹ğŸ‡·", lat: 36.8969, lng: 30.7133 },
            { name: "Tokyo, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 35.6762, lng: 139.6503 },
            { name: "Osaka, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 34.6937, lng: 135.5023 },
            { name: "Kyoto, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 35.0116, lng: 135.7681 },
            { name: "Sapporo, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 43.0618, lng: 141.3545 },
            { name: "Fukuoka, Japan", flag: "ğŸ‡¯ğŸ‡µ", lat: 33.5902, lng: 130.4017 },
            { name: "Seoul, South Korea", flag: "ğŸ‡°ğŸ‡·", lat: 37.5665, lng: 126.9780 },
            { name: "Busan, South Korea", flag: "ğŸ‡°ğŸ‡·", lat: 35.1796, lng: 129.0756 },
            { name: "Taipei, Taiwan", flag: "ğŸ‡¹ğŸ‡¼", lat: 25.0330, lng: 121.5654 },
            { name: "Kaohsiung, Taiwan", flag: "ğŸ‡¹ğŸ‡¼", lat: 22.6273, lng: 120.3014 },
            { name: "Bangkok, Thailand", flag: "ğŸ‡¹ğŸ‡­", lat: 13.7563, lng: 100.5018 },
            { name: "Chiang Mai, Thailand", flag: "ğŸ‡¹ğŸ‡­", lat: 18.7883, lng: 98.9853 },
            { name: "Singapore", flag: "ğŸ‡¸ğŸ‡¬", lat: 1.3521, lng: 103.8198 },
            { name: "Kuala Lumpur, Malaysia", flag: "ğŸ‡²ğŸ‡¾", lat: 3.1390, lng: 101.6869 },
            { name: "Jakarta, Indonesia", flag: "ğŸ‡®ğŸ‡©", lat: -6.2088, lng: 106.8456 },
            { name: "Bali (Denpasar), Indonesia", flag: "ğŸ‡®ğŸ‡©", lat: -8.6705, lng: 115.2126 },
            { name: "Manila, Philippines", flag: "ğŸ‡µğŸ‡­", lat: 14.5995, lng: 120.9842 },
            { name: "Cebu City, Philippines", flag: "ğŸ‡µğŸ‡­", lat: 10.3157, lng: 123.8854 },
            { name: "Ho Chi Minh City, Vietnam", flag: "ğŸ‡»ğŸ‡³", lat: 10.8231, lng: 106.6297 },
            { name: "Hanoi, Vietnam", flag: "ğŸ‡»ğŸ‡³", lat: 21.0285, lng: 105.8542 },
            { name: "Dubai, UAE", flag: "ğŸ‡¦ğŸ‡ª", lat: 25.2048, lng: 55.2708 },
            { name: "Abu Dhabi, UAE", flag: "ğŸ‡¦ğŸ‡ª", lat: 24.4539, lng: 54.3773 },
            { name: "Doha, Qatar", flag: "ğŸ‡¶ğŸ‡¦", lat: 25.2854, lng: 51.5310 },
            { name: "Tel Aviv, Israel", flag: "ğŸ‡®ğŸ‡±", lat: 32.0853, lng: 34.7818 },
            { name: "Jerusalem, Israel", flag: "ğŸ‡®ğŸ‡±", lat: 31.7683, lng: 35.2137 },
            { name: "Mumbai, India", flag: "ğŸ‡®ğŸ‡³", lat: 19.0760, lng: 72.8777 },
            { name: "New Delhi, India", flag: "ğŸ‡®ğŸ‡³", lat: 28.6139, lng: 77.2090 },
            { name: "Bangalore, India", flag: "ğŸ‡®ğŸ‡³", lat: 12.9716, lng: 77.5946 },
            { name: "Colombo, Sri Lanka", flag: "ğŸ‡±ğŸ‡°", lat: 6.9271, lng: 79.8612 },
            { name: "Ulaanbaatar, Mongolia", flag: "ğŸ‡²ğŸ‡³", lat: 47.9181, lng: 106.9176 },

            // --- AFRICA ---
            { name: "Cape Town, South Africa", flag: "ğŸ‡¿ğŸ‡¦", lat: -33.9249, lng: 18.4241 },
            { name: "Johannesburg, South Africa", flag: "ğŸ‡¿ğŸ‡¦", lat: -26.2041, lng: 28.0473 },
            { name: "Durban, South Africa", flag: "ğŸ‡¿ğŸ‡¦", lat: -29.8587, lng: 31.0218 },
            { name: "Nairobi, Kenya", flag: "ğŸ‡°ğŸ‡ª", lat: -1.2921, lng: 36.8219 },
            { name: "Tunis, Tunisia", flag: "ğŸ‡¹ğŸ‡³", lat: 36.8065, lng: 10.1815 },
            { name: "Cairo, Egypt", flag: "ğŸ‡ªğŸ‡¬", lat: 30.0444, lng: 31.2357 },
            { name: "Marrakech, Morocco", flag: "ğŸ‡²ğŸ‡¦", lat: 31.6295, lng: -7.9811 },
            { name: "Casablanca, Morocco", flag: "ğŸ‡²ğŸ‡¦", lat: 33.5731, lng: -7.5898 },
            { name: "Dakar, Senegal", flag: "ğŸ‡¸ğŸ‡³", lat: 14.7167, lng: -17.4677 },
            { name: "Accra, Ghana", flag: "ğŸ‡¬ğŸ‡­", lat: 5.6037, lng: -0.1870 },
            { name: "Lagos, Nigeria", flag: "ğŸ‡³ğŸ‡¬", lat: 6.5244, lng: 3.3792 },

            // --- OCEANIA ---
            { name: "Sydney, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -33.8688, lng: 151.2093 },
            { name: "Melbourne, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -37.8136, lng: 144.9631 },
            { name: "Brisbane, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -27.4698, lng: 153.0251 },
            { name: "Perth, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -31.9505, lng: 115.8605 },
            { name: "Adelaide, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -34.9285, lng: 138.6007 },
            { name: "Hobart, Australia", flag: "ğŸ‡¦ğŸ‡º", lat: -42.8821, lng: 147.3272 },
            { name: "Auckland, New Zealand", flag: "ğŸ‡³ğŸ‡¿", lat: -36.8485, lng: 174.7633 },
            { name: "Wellington, New Zealand", flag: "ğŸ‡³ğŸ‡¿", lat: -41.2865, lng: 174.7762 },
            { name: "Christchurch, New Zealand", flag: "ğŸ‡³ğŸ‡¿", lat: -43.5321, lng: 172.6362 }
        ];

        // --- NEW: COUNTRY SPECIFIC LISTS ---
        const COUNTRY_LOCATIONS = {
            ru: [ // Russia
                { lat: 59.9311, lng: 30.3609 }, { lat: 55.7558, lng: 37.6173 }, { lat: 55.7963, lng: 49.1088 }, 
                { lat: 43.5852, lng: 39.7231 }, { lat: 55.0302, lng: 82.9204 }, { lat: 56.8389, lng: 60.6057 },
                { lat: 43.1198, lng: 131.8869 }, { lat: 56.2965, lng: 43.9361 }, { lat: 54.7104, lng: 20.4522 }, { lat: 51.5336, lng: 46.0343 }
            ],
            ee: [ // Estonia (Requested)
                { lat: 59.4370, lng: 24.7536 }, { lat: 58.3780, lng: 26.7290 }, { lat: 59.3797, lng: 28.1791 },
                { lat: 58.2481, lng: 22.5038 }, { lat: 59.3591, lng: 24.5807 }, { lat: 58.8879, lng: 25.5682 },
                { lat: 57.7765, lng: 26.0312 }, { lat: 59.1042, lng: 26.3314 }, { lat: 58.9482, lng: 23.5392 }, { lat: 58.6477, lng: 23.1537 }
            ],
            us: [ // USA
                { lat: 40.7128, lng: -74.0060 }, { lat: 34.0522, lng: -118.2437 }, { lat: 41.8781, lng: -87.6298 },
                { lat: 37.7749, lng: -122.4194 }, { lat: 25.7617, lng: -80.1918 }, { lat: 36.1699, lng: -115.1398 },
                { lat: 47.6062, lng: -122.3321 }, { lat: 42.3601, lng: -71.0589 }, { lat: 30.2672, lng: -97.7431 }, { lat: 39.7392, lng: -104.9903 }
            ],
            fr: [ // France
                { lat: 48.8566, lng: 2.3522 }, { lat: 45.7640, lng: 4.8357 }, { lat: 43.2965, lng: 5.3698 },
                { lat: 43.7102, lng: 7.2620 }, { lat: 44.8378, lng: -0.5792 }, { lat: 48.5734, lng: 7.7521 },
                { lat: 43.6047, lng: 1.4442 }, { lat: 47.2184, lng: -1.5536 }, { lat: 50.6292, lng: 3.0573 }, { lat: 46.1603, lng: -1.1511 }
            ],
            jp: [ // Japan
                { lat: 35.6762, lng: 139.6503 }, { lat: 34.6937, lng: 135.5023 }, { lat: 35.0116, lng: 135.7681 },
                { lat: 43.0618, lng: 141.3545 }, { lat: 33.5902, lng: 130.4017 }, { lat: 35.4437, lng: 139.6380 },
                { lat: 38.2682, lng: 140.8694 }, { lat: 34.3853, lng: 132.4553 }, { lat: 26.2124, lng: 127.6809 }, { lat: 36.5613, lng: 136.6562 }
            ],
            br: [ // Brazil
                { lat: -23.5505, lng: -46.6333 }, { lat: -22.9068, lng: -43.1729 }, { lat: -15.7975, lng: -47.8919 },
                { lat: -12.9777, lng: -38.5016 }, { lat: -30.0346, lng: -51.2177 }, { lat: -3.7319, lng: -38.5267 },
                { lat: -19.9167, lng: -43.9345 }, { lat: -1.4558, lng: -48.4902 }, { lat: -8.0476, lng: -34.8770 }, { lat: -25.4284, lng: -49.2733 }
            ],
            it: [ // Italy
                { lat: 41.9028, lng: 12.4964 }, { lat: 45.4642, lng: 9.1900 }, { lat: 45.4408, lng: 12.3155 },
                { lat: 43.7696, lng: 11.2558 }, { lat: 40.8518, lng: 14.2681 }, { lat: 45.0703, lng: 7.6869 },
                { lat: 38.1157, lng: 13.3615 }, { lat: 44.4949, lng: 11.3426 }, { lat: 45.4384, lng: 10.9916 }, { lat: 41.1171, lng: 16.8719 }
            ],
            gb: [ // UK
                { lat: 51.5074, lng: -0.1278 }, { lat: 53.4808, lng: -2.2426 }, { lat: 55.9533, lng: -3.1883 },
                { lat: 52.4862, lng: -1.8904 }, { lat: 53.4084, lng: -2.9916 }, { lat: 51.4545, lng: -2.5879 },
                { lat: 54.9783, lng: -1.6178 }, { lat: 53.8008, lng: -1.5491 }, { lat: 55.8642, lng: -4.2518 }, { lat: 51.4816, lng: -3.1791 }
            ],
            de: [ // Germany
                { lat: 52.5200, lng: 13.4050 }, { lat: 48.1351, lng: 11.5820 }, { lat: 53.5511, lng: 9.9937 },
                { lat: 50.1109, lng: 8.6821 }, { lat: 50.9375, lng: 6.9603 }, { lat: 48.7758, lng: 9.1829 },
                { lat: 51.2277, lng: 6.7735 }, { lat: 51.3397, lng: 12.3731 }, { lat: 51.0504, lng: 13.7373 }, { lat: 53.0793, lng: 8.8017 }
            ],
            tr: [ // Turkey
                { lat: 41.0082, lng: 28.9784 }, { lat: 39.9334, lng: 32.8597 }, { lat: 36.8969, lng: 30.7133 },
                { lat: 38.4237, lng: 27.1428 }, { lat: 37.0000, lng: 35.3213 }, { lat: 40.1885, lng: 29.0610 },
                { lat: 37.0662, lng: 37.3833 }, { lat: 38.7578, lng: 30.5387 }, { lat: 40.9168, lng: 39.5855 }, { lat: 36.5866, lng: 36.1666 }
            ]
        };

        const COUNTRY_META = [
            { id: 'ru', flag: 'ğŸ‡·ğŸ‡º', name: 'Russia' }, { id: 'ee', flag: 'ğŸ‡ªğŸ‡ª', name: 'Estonia' },
            { id: 'us', flag: 'ğŸ‡ºğŸ‡¸', name: 'USA' }, { id: 'fr', flag: 'ğŸ‡«ğŸ‡·', name: 'France' },
            { id: 'jp', flag: 'ğŸ‡¯ğŸ‡µ', name: 'Japan' }, { id: 'br', flag: 'ğŸ‡§ğŸ‡·', name: 'Brazil' },
            { id: 'it', flag: 'ğŸ‡®ğŸ‡¹', name: 'Italy' }, { id: 'gb', flag: 'ğŸ‡¬ğŸ‡§', name: 'UK' },
            { id: 'de', flag: 'ğŸ‡©ğŸ‡ª', name: 'Germany' }, { id: 'tr', flag: 'ğŸ‡¹ğŸ‡·', name: 'Turkey' }
        ];

        let map, mly, guessMarker, resultLine, resultMarker, oppMarkers = [];

        function init() {
            map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â©CARTO' }).addTo(map);

            const { Viewer } = mapillary;
            mly = new Viewer({ accessToken: MLY_TOKEN, container: 'mly', component: { cover: false, sequence: false } });

            map.on('click', (e) => {
                if(STATE.isLocked || STATE.mode === 'casino') return;
                if(guessMarker) map.removeLayer(guessMarker);
                guessMarker = L.marker(e.latlng).addTo(map);
                
                const btn = document.getElementById('confirm-btn');
                btn.classList.add('active');
                btn.innerText = t('btn_guess_confirm');
                btn.disabled = false;
                if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.selectionChanged();
            });

            applyTranslations();
            renderCountryGrid();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function t(key) { return TR[STATE.lang][key] || key; }
        
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.innerText = t(el.getAttribute('data-i18n'));
            });
            document.getElementById('settings-btn').innerText = STATE.lang === 'en' ? 'ğŸ‡ºğŸ‡¸' : 'ğŸ‡·ğŸ‡º';
        }

        window.toggleLanguage = () => {
            STATE.lang = STATE.lang === 'en' ? 'ru' : 'en';
            localStorage.setItem('geo_lang', STATE.lang);
            applyTranslations();
        };

        window.showMainMenu = () => {
            document.body.classList.remove('game-active', 'casino-mode');
            document.querySelectorAll('.full-screen-menu').forEach(el => el.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
            // Clean up QR if exists
            document.getElementById('qr-container').innerHTML = '';
            // Stop bot if running
            if(STATE.botInterval) { clearInterval(STATE.botInterval); STATE.botInterval = null; }
            document.getElementById('bot-cursor').style.display = 'none';
        };

        window.openFriendMenu = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('friend-menu').classList.remove('hidden');
        };

        window.selectMpMode = (mode) => {
            STATE.mpModeSelected = mode;
            document.getElementById('mp-mode-endless').classList.toggle('selected', mode === 'endless');
            document.getElementById('mp-mode-challenge').classList.toggle('selected', mode === 'challenge');
        };

        // --- PROFILE LOGIC ---
        window.openProfile = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('profile-screen').classList.remove('hidden');
            document.getElementById('pf-name').innerText = STATE.myName;
            document.getElementById('pf-total-games').innerText = STATE.totalGames;
            document.getElementById('pf-total-score').innerText = STATE.totalScore;
            
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            [...STATE.history].reverse().slice(0, 30).forEach(h => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<div>${h.loc || 'Unknown'}</div><div class="h-score">+${h.pts}</div>`;
                list.appendChild(div);
            });
        };
        window.closeProfile = () => window.showMainMenu();
        window.clearData = () => {
            if(!confirm('Delete history?')) return;
            localStorage.removeItem('geo_history');
            localStorage.removeItem('geo_total_games');
            localStorage.removeItem('geo_total_score');
            STATE.history = []; STATE.totalGames = 0; STATE.totalScore = 0;
            window.openProfile();
        };

        // --- NEW: COUNTRY MODE ---
        function renderCountryGrid() {
            const grid = document.getElementById('country-grid');
            grid.innerHTML = '';
            COUNTRY_META.forEach(c => {
                const div = document.createElement('div');
                div.className = 'country-card';
                div.innerHTML = `<div class="country-flag">${c.flag}</div><div class="country-name">${c.name}</div>`;
                div.onclick = () => window.startCountryMode(c.id);
                grid.appendChild(div);
            });
        }
        
        window.openCountryMenu = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('country-menu').classList.remove('hidden');
        };

        window.startCountryMode = (code) => {
            STATE.countryFilter = code;
            STATE.mode = 'endless'; // Keep it simple for now, can be changed to challenge later
            document.body.classList.add('game-active');
            updateHUD();
            startGameLoop();
        };

        // --- NEW: CASINO / BOT MODE ---
        window.openCasinoMenu = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('casino-menu').classList.remove('hidden');
            document.getElementById('casino-wallet').innerText = STATE.totalScore;
            STATE.betOption = null;
            document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('selected'));
        };

        window.selectBet = (opt) => {
            STATE.betOption = opt;
            document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('bet-'+opt).classList.add('selected');
        };

        window.startBotRound = () => {
            const amount = parseInt(document.getElementById('bet-amount').value);
            if(!STATE.betOption) { alert("Select a bet option!"); return; }
            if(amount > STATE.totalScore) { alert("Not enough XP!"); return; }
            if(amount <= 0) { alert("Invalid bet!"); return; }

            STATE.betAmount = amount;
            STATE.totalScore -= amount; // Deduct immediately (House rules!)
            localStorage.setItem('geo_total_score', STATE.totalScore.toString());

            document.getElementById('casino-menu').classList.add('hidden');
            document.body.classList.add('game-active', 'casino-mode');
            STATE.mode = 'casino';
            STATE.countryFilter = null;
            
            startGameLoop();
            
            // Bot Logic
            setTimeout(() => runBotSequence(), 3000);
        };

        async function runBotSequence() {
            // 1. Determine Outcome RNG
            const rng = Math.random() * 100;
            let outcome = 'fail'; 
            // 15% God (<10km), 35% Solid (<500km), 30% Drunk (>2000km), 20% Ocean
            if(rng < 15) outcome = 'god';
            else if(rng < 50) outcome = 'solid';
            else if(rng < 80) outcome = 'drunk';
            else outcome = 'ocean';

            const actualLat = STATE.currentLoc.lat;
            const actualLng = STATE.currentLoc.lng;

            let targetLat, targetLng;

            if(outcome === 'god') {
                targetLat = actualLat + (Math.random()*0.1 - 0.05);
                targetLng = actualLng + (Math.random()*0.1 - 0.05);
            } else if(outcome === 'solid') {
                targetLat = actualLat + (Math.random()*4 - 2);
                targetLng = actualLng + (Math.random()*4 - 2);
            } else if(outcome === 'drunk') {
                // Random point far away
                targetLat = actualLat > 0 ? -20 : 50; 
                targetLng = actualLng + 90;
            } else {
                // Ocean (Null Island area usually safe bet for ocean, or specific Pacific point)
                targetLat = 0; targetLng = -160; 
            }

            // 2. Animation
            const bubbles = ["Hmmm...", "Calculating sun angle...", "Looks like Brazil...", "Wait, is that a cat?", "Scanning pixels...", "My WiFi is slow..."];
            const bubbleEl = document.getElementById('bot-bubble');
            const cursorEl = document.getElementById('bot-cursor');

            let bearing = 0;
            STATE.botInterval = setInterval(() => {
                bearing = (bearing + 1) % 360;
                mly.setBearing(bearing); // Pan camera
                
                if(Math.random() > 0.9) {
                    bubbleEl.innerText = bubbles[Math.floor(Math.random()*bubbles.length)];
                    bubbleEl.classList.add('show');
                    setTimeout(() => bubbleEl.classList.remove('show'), 2000);
                }
            }, 50);

            // After 5 seconds, move cursor
            setTimeout(() => {
                clearInterval(STATE.botInterval);
                document.getElementById('mobile-map-toggle').click(); // Open Map
                
                cursorEl.style.display = 'block';
                // Start position (random on screen)
                cursorEl.style.top = '80%'; cursorEl.style.left = '20%';

                setTimeout(() => {
                    // Move to center of map (approx) then to target? 
                    // Since Map container is fixed, we simulate relative movement
                    const mapRect = document.getElementById('map').getBoundingClientRect();
                    const endX = mapRect.left + mapRect.width/2 + (Math.random()*50-25);
                    const endY = mapRect.top + mapRect.height/2 + (Math.random()*50-25);
                    
                    cursorEl.style.top = endY + 'px';
                    cursorEl.style.left = endX + 'px';
                    
                    // Shake effect
                    setTimeout(() => {
                        // Place Marker programmatically
                        guessMarker = L.marker([targetLat, targetLng]).addTo(map);
                        
                        setTimeout(() => {
                             // Submit
                             cursorEl.style.display = 'none';
                             window.submitGuess(true); // force submit
                             checkBetResult(outcome);
                        }, 1000);

                    }, 1500);

                }, 500);

            }, 5000);
        }

        function checkBetResult(actualOutcome) {
            let win = false;
            let multiplier = 0;

            if(STATE.betOption === 'god' && actualOutcome === 'god') { win = true; multiplier = 15; }
            if(STATE.betOption === 'solid' && (actualOutcome === 'solid' || actualOutcome === 'god')) { win = true; multiplier = 3; }
            if(STATE.betOption === 'drunk' && actualOutcome === 'drunk') { win = true; multiplier = 2; }
            if(STATE.betOption === 'ocean' && actualOutcome === 'ocean') { win = true; multiplier = 10; }

            const profit = win ? STATE.betAmount * multiplier : 0;
            STATE.totalScore += profit;
            localStorage.setItem('geo_total_score', STATE.totalScore.toString());

            // Override result text
            const resDist = document.getElementById('res-dist');
            resDist.innerHTML = win ? `<span style="color:#00ff00">YOU WON!</span>` : `<span style="color:red">YOU LOST</span>`;
            document.getElementById('res-pts').innerText = win ? `+${profit} XP` : `-${STATE.betAmount} XP`;
        }

        // --- GAME LOGIC ---
        window.startEndless = () => {
            STATE.countryFilter = null;
            document.body.classList.add('game-active');
            STATE.mode = 'endless'; STATE.score = 0;
            updateHUD(); startGameLoop();
        };

        window.startChallenge = () => {
            STATE.countryFilter = null;
            document.body.classList.add('game-active');
            STATE.mode = 'challenge'; STATE.round = 1; STATE.score = 0; STATE.maxRounds = 5;
            updateHUD(); startGameLoop();
        };

        function updateHUD() {
            document.querySelectorAll('.full-screen-menu').forEach(el => el.classList.add('hidden'));
            document.getElementById('score-me').innerText = STATE.score;
            document.getElementById('mp-scores').style.display = 'none';
            document.getElementById('host-controls').style.display = 'none';

            if (STATE.mode === 'challenge' || (STATE.mode === 'multi' && STATE.mpModeSelected === 'challenge')) {
                document.getElementById('round-indicator').style.display = 'flex';
                document.getElementById('round-indicator').innerText = `ROUND ${STATE.round}/${STATE.maxRounds}`;
                document.getElementById('timer-box').style.display = 'block';
            } else {
                document.getElementById('round-indicator').style.display = 'none';
                document.getElementById('timer-box').style.display = 'none';
            }
        }

        async function pickRandomLocation() {
            // 1. Check Country Filter
            let pool = LOCATIONS;
            if(STATE.countryFilter && COUNTRY_LOCATIONS[STATE.countryFilter]) {
                pool = COUNTRY_LOCATIONS[STATE.countryFilter];
            }

            // Fallback
            if(pool.length < 1) return { id: '5177821635678829', lat: 48.8566, lng: 2.3522, city: { name: "Paris", flag: "ğŸ‡«ğŸ‡·"} };
            
            // 2. Pick Item
            const city = pool[Math.floor(Math.random() * pool.length)];
            
            // 3. Get Mapillary ID
            const range = 0.04;
            const rLat = city.lat + (Math.random() * range * 2 - range);
            const rLng = city.lng + (Math.random() * range * 2 - range);
            const bbox = `${rLng-0.005},${rLat-0.005},${rLng+0.005},${rLat+0.005}`;
            
            try {
                const res = await fetch(`https://graph.mapillary.com/images?access_token=${MLY_TOKEN}&fields=id,geometry&bbox=${bbox}&limit=1`);
                const data = await res.json();
                if(data.data && data.data.length > 0) {
                    const foundName = city.name || (STATE.countryFilter ? COUNTRY_META.find(c=>c.id===STATE.countryFilter).name : "Unknown");
                    const foundFlag = city.flag || (STATE.countryFilter ? COUNTRY_META.find(c=>c.id===STATE.countryFilter).flag : "ğŸ³ï¸");
                    
                    return { 
                        id: data.data[0].id, 
                        lat: data.data[0].geometry.coordinates[1], 
                        lng: data.data[0].geometry.coordinates[0], 
                        city: { name: foundName, flag: foundFlag } 
                    };
                } else return pickRandomLocation(); 
            } catch(e) { return pickRandomLocation(); }
        }

        function startGameLoop() {
            resetMapUI();
            if (STATE.mode !== 'multi') {
                document.getElementById('loading').classList.remove('hidden');
                pickRandomLocation().then(loc => {
                    STATE.currentLoc = loc;
                    loadLocation(loc);
                    if(STATE.mode === 'challenge') startTimer(120);
                });
            } else {
                document.getElementById('confirm-btn').innerText = t('btn_wait');
            }
        }

        function loadLocation(loc) {
            mly.moveTo(loc.id)
                .then(() => document.getElementById('loading').classList.add('hidden'))
                .catch(() => pickRandomLocation().then(l => loadLocation(l)));
        }

        function resetMapUI() {
            STATE.isLocked = false;
            document.getElementById('result-sheet').classList.remove('show');
            document.getElementById('map-container').classList.remove('map-result-mode', 'open');
            document.getElementById('res-mp-list').style.display = 'none';

            if(guessMarker) map.removeLayer(guessMarker);
            if(resultLine) map.removeLayer(resultLine);
            if(resultMarker) map.removeLayer(resultMarker);
            oppMarkers.forEach(m => map.removeLayer(m));
            oppMarkers = [];
            
            guessMarker = null; 
            map.setView([20,0], 2);
            
            const btn = document.getElementById('confirm-btn');
            btn.classList.remove('active');
            btn.innerText = t('btn_guess_tap');
            btn.disabled = true;
            
            // Casino Mode specifics
            if(STATE.mode === 'casino') {
                document.getElementById('mobile-map-toggle').style.display = 'none';
                document.getElementById('confirm-btn').style.display = 'none';
            } else {
                document.getElementById('mobile-map-toggle').style.display = 'flex';
                document.getElementById('confirm-btn').style.display = 'block';
            }
            
            const nextBtn = document.getElementById('next-btn');
            nextBtn.classList.remove('loading');
            nextBtn.disabled = false;
        }

        function startTimer(seconds) {
            clearInterval(STATE.timer);
            STATE.timeLeft = seconds;
            updateTimerDisplay();
            STATE.timer = setInterval(() => {
                STATE.timeLeft--;
                updateTimerDisplay();
                if(STATE.timeLeft <= 0) {
                    clearInterval(STATE.timer);
                    if(!STATE.isLocked) window.submitGuess(true); 
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const min = Math.floor(STATE.timeLeft / 60);
            const sec = STATE.timeLeft % 60;
            const el = document.getElementById('timer-box');
            el.innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;
            if(STATE.timeLeft < 10) el.classList.add('warning'); else el.classList.remove('warning');
        }

        // --- MULTIPLAYER & QR ---
        window.createRoom = () => {
            const btn = document.getElementById('btn-create');
            btn.classList.add('loading');
            const code = Math.floor(10000 + Math.random() * 90000).toString();
            STATE.gameId = code;
            STATE.mpRole = 'host';
            STATE.mode = 'multi';
            
            const initialData = {
                status: 'waiting',
                mode: STATE.mpModeSelected,
                round: 1,
                host: STATE.myUid,
                players: { [STATE.myUid]: { name: STATE.myName, score: 0, avatar: 'ğŸ‘‘' } }
            };

            set(ref(db, 'games/' + code), initialData).then(() => {
                btn.classList.remove('loading');
                enterLobby(code);
            });
        };

        window.joinRoom = () => {
            const code = document.getElementById('join-code').value;
            if(code.length !== 5) return;
            const btn = document.getElementById('btn-join');
            btn.classList.add('loading');
            // ... (Same join logic)
            performJoin(code);
        };
        
        // Native Telegram QR Scanner
        window.scanQrJoin = () => {
            if(window.Telegram?.WebApp) {
                window.Telegram.WebApp.showScanQrPopup({ text: 'Scan Lobby Code' }, (text) => {
                    // Telegram returns text, we expect 5 digits
                    if(text && text.length >= 5) {
                        // Sometimes text is URL, extract digits? For now assume raw code
                        const match = text.match(/\d{5}/);
                        if(match) {
                            window.Telegram.WebApp.closeScanQrPopup();
                            document.getElementById('join-code').value = match[0];
                            window.joinRoom();
                            return true; // close scanner
                        }
                    }
                });
            } else {
                alert("Only available in Telegram");
            }
        };

        function performJoin(code) {
             get(ref(db, 'games/' + code)).then((snap) => {
                document.getElementById('btn-join').classList.remove('loading');
                if(snap.exists()) {
                    STATE.gameId = code;
                    STATE.mpRole = 'guest';
                    STATE.mode = 'multi';
                    update(ref(db, `games/${code}/players/${STATE.myUid}`), {
                        name: STATE.myName, score: 0, avatar: 'ğŸ‘¤'
                    });
                    enterLobby(code);
                } else {
                    alert("Room not found");
                }
            });
        }

        function enterLobby(code) {
            document.getElementById('friend-menu').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('lobby-code-display').innerText = code;
            
            // Generate QR
            const qrContainer = document.getElementById('qr-container');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: code,
                width: 128,
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff"
            });

            if(STATE.mpRole === 'host') document.getElementById('host-actions').classList.remove('hidden');
            listenToLobby(code);
        }

        window.hostStartGame = () => {
            update(ref(db, `games/${STATE.gameId}`), { status: 'starting' });
        };
        
        window.leaveLobby = () => {
            remove(ref(db, `games/${STATE.gameId}/players/${STATE.myUid}`));
            window.location.reload();
        };

        function listenToLobby(code) {
            onValue(ref(db, 'games/' + code), (snap) => {
                const data = snap.val();
                if(!data) { alert("Room closed"); window.location.reload(); return; }
                if(!data.players || !data.players[STATE.myUid]) {
                    alert(t('msg_kicked')); window.location.reload(); return;
                }
                STATE.players = data.players;
                renderPlayerList(data.players);

                if(data.status === 'starting' || data.status === 'playing') {
                    document.getElementById('lobby-screen').classList.add('hidden');
                    document.body.classList.add('game-active');
                    if(STATE.mpRole === 'host' && data.status === 'starting') {
                        update(ref(db, `games/${code}`), { status: 'playing' });
                        document.getElementById('loading').classList.remove('hidden');
                        pickRandomLocation().then(loc => {
                            update(ref(db, `games/${code}`), { location: loc });
                        });
                    }
                    listenToGame(code);
                }
            });
        }

        function renderPlayerList(players) {
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            Object.keys(players).forEach(uid => {
                const p = players[uid];
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `<div class="player-info"><div class="player-avatar">${p.avatar}</div> <span>${p.name}</span></div>`;
                list.appendChild(div);
            });
        }

        function listenToGame(code) {
            document.getElementById('mp-scores').style.display = 'flex';
            if(STATE.mpRole === 'host') document.getElementById('host-controls').style.display = 'flex';

            onValue(ref(db, 'games/' + code), (snap) => {
                const data = snap.val();
                if(!data) return;

                if(data.status === 'next_round') {
                    document.getElementById('loading').classList.remove('hidden');
                    document.getElementById('result-sheet').classList.remove('show');
                }

                renderMpScores(data.players);

                if(data.location && (!STATE.currentLoc || STATE.currentLoc.id !== data.location.id)) {
                    STATE.currentLoc = data.location;
                    STATE.round = data.round;
                    STATE.resultShown = false; 
                    
                    updateHUD();
                    loadLocation(data.location);
                    resetMapUI();
                    if(data.mode === 'challenge') startTimer(120);
                }

                if(data.forceEndRound && !STATE.isLocked && !STATE.resultShown) {
                     window.submitGuess(true);
                }

                const playerIds = Object.keys(data.players);
                const guesses = data.guesses || {};
                const allGuessed = playerIds.every(uid => guesses[uid]);
                
                if( (allGuessed || data.status === 'results') && !STATE.resultShown ) {
                    STATE.resultShown = true;
                    clearInterval(STATE.timer);
                    showMpResult(guesses, data.location);
                }
            });
        }

        function renderMpScores(players) {
            const container = document.getElementById('mp-scores');
            container.innerHTML = '';
            Object.values(players).sort((a,b) => b.score - a.score).forEach(p => {
                const div = document.createElement('div');
                div.style.cssText = "display:flex; justify-content:space-between; font-size:0.8rem; color:#ddd;";
                div.innerHTML = `<span>${p.name}</span> <span style="color:#f1c40f">${p.score}</span>`;
                container.appendChild(div);
            });
        }
        
        window.hostForceRoundEnd = () => {
            update(ref(db, `games/${STATE.gameId}`), { status: 'results' });
        };

        // --- SUBMIT ---
        window.submitGuess = (force = false) => {
            if((!guessMarker && !force) || STATE.isLocked) return;
            
            clearInterval(STATE.timer);
            STATE.isLocked = true;
            
            const uLat = guessMarker ? guessMarker.getLatLng() : L.latLng(0,0);
            const aLat = L.latLng(STATE.currentLoc.lat, STATE.currentLoc.lng);
            const dist = map.distance(uLat, aLat);
            const pts = (force && !guessMarker) ? 0 : Math.round(5000 * Math.exp(-dist / 120000)); 

            if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            // --- SAVE HISTORY IMMEDIATELY (Unless Casino) ---
            if(STATE.mode !== 'casino') {
                STATE.totalScore += pts;
                STATE.totalGames++; 
                localStorage.setItem('geo_total_score', STATE.totalScore.toString());
                localStorage.setItem('geo_total_games', STATE.totalGames.toString());

                const historyItem = { 
                    date: new Date().toLocaleDateString(), 
                    pts: pts,
                    loc: STATE.currentLoc ? (STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag) : "Unknown" 
                };
                STATE.history.push(historyItem);
                localStorage.setItem('geo_history', JSON.stringify(STATE.history));
            }

            if(STATE.mode === 'multi') {
                document.getElementById('confirm-btn').innerText = t('btn_wait');
                update(ref(db, `games/${STATE.gameId}/guesses/${STATE.myUid}`), {
                    lat: uLat.lat, lng: uLat.lng, pts: pts, name: STATE.myName
                });
                return;
            }

            if(STATE.mode !== 'casino') STATE.score += pts;
            showSingleResult(uLat, aLat, dist, pts);
        };

        function showSingleResult(uLat, aLat, dist, pts) {
            setupResultMap(uLat, aLat);
            // Casino has its own result text logic in checkBetResult, this is default
            if(STATE.mode !== 'casino') {
                document.getElementById('res-dist').innerText = formatDist(dist);
                document.getElementById('res-pts').innerText = "+" + pts + " pts";
            }
            document.getElementById('res-loc-name').innerHTML = STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag;
            
            const nextBtn = document.getElementById('next-btn');
            const nextBtnText = nextBtn.querySelector('.btn-content');
            
            if (STATE.mode === 'challenge' && STATE.round >= STATE.maxRounds) {
                nextBtnText.innerText = t('btn_finish');
                nextBtn.onclick = showSummary;
            } else if (STATE.mode === 'casino') {
                 nextBtnText.innerText = t('btn_menu');
                 nextBtn.onclick = window.showMainMenu;
            } else {
                nextBtnText.innerText = t('btn_next');
                nextBtn.onclick = window.nextRound;
            }
            document.getElementById('result-sheet').classList.add('show');
        }

        function showMpResult(guesses, locData) {
            const actual = L.latLng(locData.lat, locData.lng);
            const myGuess = guesses[STATE.myUid];
            
            setupResultMap(myGuess ? L.latLng(myGuess.lat, myGuess.lng) : actual, actual);
            
            Object.keys(guesses).forEach(uid => {
                if(uid === STATE.myUid) return;
                const g = guesses[uid];
                const gLat = L.latLng(g.lat, g.lng);
                // Smaller markers for 20 players
                const m = L.circleMarker(gLat, { radius:4, color:'#ff4b2b', fillColor:'#ff4b2b', fillOpacity:0.8 }).addTo(map);
                oppMarkers.push(m);
            });

            const pts = myGuess ? myGuess.pts : 0;
            const dist = myGuess ? map.distance(L.latLng(myGuess.lat, myGuess.lng), actual) : 0;
            
            document.getElementById('res-dist').innerText = myGuess ? formatDist(dist) : "Did not guess";
            document.getElementById('res-pts').innerText = "+" + pts + " pts";
            document.getElementById('res-loc-name').innerHTML = STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag;

            const list = document.getElementById('res-mp-list');
            list.style.display = 'block';
            list.innerHTML = '';
            Object.values(guesses).sort((a,b)=>b.pts - a.pts).forEach(g => {
                const r = document.createElement('div');
                r.style.cssText = "display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:4px;";
                r.innerHTML = `<span>${g.name}</span> <span style="color:#f1c40f">+${g.pts}</span>`;
                list.appendChild(r);
            });

            const nextBtn = document.getElementById('next-btn');
            const nextBtnText = nextBtn.querySelector('.btn-content');
            
            if (STATE.mpModeSelected === 'challenge' && STATE.round >= STATE.maxRounds) {
                nextBtnText.innerText = t('btn_finish');
                nextBtn.onclick = showSummary;
            } else {
                nextBtnText.innerText = (STATE.mpRole === 'host') ? t('btn_next') : t('btn_wait');
                nextBtn.disabled = (STATE.mpRole !== 'host');
                nextBtn.onclick = (STATE.mpRole === 'host') ? window.nextRound : null;
                
                if(STATE.mpRole === 'host') {
                    get(ref(db, `games/${STATE.gameId}/players`)).then(snap => {
                        const p = snap.val();
                        Object.keys(guesses).forEach(uid => { if(p[uid]) p[uid].score += guesses[uid].pts; });
                        update(ref(db, `games/${STATE.gameId}/players`), p);
                    });
                }
            }
            document.getElementById('result-sheet').classList.add('show');
        }

        function setupResultMap(uLat, aLat) {
            document.getElementById('map-container').classList.add('map-result-mode', 'open');
            setTimeout(() => map.invalidateSize(), 200);

            resultMarker = L.circleMarker(aLat, { radius: 8, color: '#fff', fillColor: '#00ff00', fillOpacity: 1 }).addTo(map);
            resultLine = L.polyline([uLat, aLat], { color: '#00C6FF', weight: 4 }).addTo(map);
            
            const group = new L.featureGroup([L.marker(uLat), resultMarker]);
            map.fitBounds(group.getBounds(), { padding: [50, 50], maxZoom: 16 });
        }

        window.nextRound = () => {
            const btn = document.getElementById('next-btn');
            btn.classList.add('loading');
            
            if(STATE.mode === 'endless' || STATE.mode === 'challenge') {
                if(STATE.mode === 'challenge') STATE.round++;
                startGameLoop();
            } else if (STATE.mode === 'multi' && STATE.mpRole === 'host') {
                const nextR = STATE.round + 1;
                update(ref(db, `games/${STATE.gameId}`), {
                    status: 'next_round',
                    round: nextR,
                    guesses: null,
                    forceEndRound: null
                }).then(() => {
                    pickRandomLocation().then(loc => {
                        update(ref(db, `games/${STATE.gameId}`), { location: loc, status: 'playing' });
                    });
                });
            }
        };

        function showSummary() {
            document.getElementById('summary-modal').style.display = 'flex';
            document.getElementById('final-score').innerText = STATE.score;
            confetti({ particleCount: 200, spread: 100 });
        }

        window.toggleMap = () => {
            const c = document.getElementById('map-container');
            const b = document.getElementById('mobile-map-toggle');
            if(c.classList.contains('open')) { c.classList.remove('open'); b.innerText = "ğŸ—ºï¸"; } 
            else { c.classList.add('open'); b.innerText = "âœ–"; setTimeout(() => map.invalidateSize(), 300); }
        };

        function formatDist(m) { return m < 1000 ? Math.round(m) + " m" : (m/1000).toFixed(1) + " km"; }

        window.shareResult = () => {
            const text = `GeoGuessr: I scored ${STATE.score} pts!`;
            const url = `https://t.me/share/url?url=${encodeURIComponent("t.me/geogur_bot/app")}&text=${encodeURIComponent(text)}`;
            if(window.Telegram?.WebApp) window.Telegram.WebApp.openTelegramLink(url);
            else window.open(url, '_blank');
        };

        init();
    </script>
</body>
</html>
