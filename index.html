<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoGuessr Ultimate</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            try {
                window.Telegram.WebApp.requestFullscreen(); 
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.disableVerticalSwipes();
                // Enable closing via swipe down only in specific conditions if needed
                window.Telegram.WebApp.enableClosingConfirmation();
            } catch (e) { console.log("Telegram FS failed", e); }
        }
    </script>

    <!-- External Libs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ==================== THEME & VARS ==================== */
        :root {
            --bg-color: #050505;
            --text-color: #ffffff;
            --primary-grad: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%);
            
            /* ULTRA GLASS VARIABLES */
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            --blur: 40px; 
            --safe-top: 20px; 
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            overflow: hidden; -webkit-tap-highlight-color: transparent;
        }

        /* ==================== ANIMATED BACKGROUND ==================== */
        .bg-blob {
            position: absolute; border-radius: 50%;
            filter: blur(80px); opacity: 0.6; z-index: 0;
            animation: floatBlob 15s infinite alternate ease-in-out;
            pointer-events: none;
        }
        .blob-1 { top: -15%; left: -15%; width: 50vw; height: 50vw; background: #004e92; }
        .blob-2 { bottom: -15%; right: -15%; width: 60vw; height: 60vw; background: #560a5c; animation-delay: -5s; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #00293b; animation-duration: 25s; opacity: 0.4; }

        @keyframes floatBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        /* ==================== UTILS & GLASS ==================== */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border); 
            border-top: 1px solid var(--glass-highlight); 
            border-radius: 24px;
            box-shadow: var(--glass-shadow);
            position: relative;
            overflow: hidden;
        }
        /* Shine effect on glass */
        .glass-panel::before {
            content: ''; position: absolute; top: 0; left: -50%; width: 100%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.03), transparent);
            transform: skewX(-25deg); pointer-events: none;
        }

        .hidden { display: none !important; }
        .scrollable { overflow-y: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .scrollable::-webkit-scrollbar { display: none; }

        /* ==================== UI ELEMENTS ==================== */
        
        #settings-btn {
            position: absolute; top: 20px; right: 20px; z-index: 6000;
            width: 44px; height: 44px; 
            background: rgba(255,255,255,0.1);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            border: 1px solid rgba(255,255,255,0.1); cursor: pointer; font-size: 22px;
            backdrop-filter: blur(10px);
        }

        .input-code {
            display: block; width: 80%; margin: 15px auto; padding: 16px;
            font-size: 24px; font-weight: 800; text-align: center; letter-spacing: 5px;
            color: white; background: rgba(0, 0, 0, 0.3); 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px; outline: none;
            text-transform: uppercase;
        }
        .input-code:focus { border-color: #00C6FF; box-shadow: 0 0 15px rgba(0,198,255,0.2); }

        /* ==================== MENUS ==================== */
        .full-screen-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            background: rgba(0,0,0,0.2); /* darken slightly */
        }
        
        .menu-title { 
            font-size: 3.5rem; font-weight: 900; margin-top: 10px; margin-bottom: 5px;
            background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-align: center; letter-spacing: -2px; filter: drop-shadow(0 0 20px rgba(0,198,255,0.3));
        }
        .menu-subtitle { font-size: 1rem; color: #bbb; margin-bottom: 30px; text-align: center; opacity: 0.8; }

        /* Buttons */
        .btn-main {
            width: 100%; max-width: 300px; padding: 18px; margin: 8px 0;
            border: none; border-radius: 18px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.97); }
        .btn-blue { background: linear-gradient(135deg, rgba(0,198,255,0.8) 0%, rgba(0,114,255,0.8) 100%); }
        .btn-orange { background: linear-gradient(135deg, #FF512F 0%, #F09819 100%); }
        .btn-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .btn-dark { background: rgba(255,255,255,0.08); }
        
        .btn-spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s infinite linear; display: none; }
        .btn-main.loading .btn-content { display: none; }
        .btn-main.loading .btn-spinner { display: block; }

        /* ==================== COUNTRY MODE GRID ==================== */
        #country-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            width: 100%; max-width: 340px; margin-bottom: 20px;
        }
        .country-card {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 15px; text-align: center;
            cursor: pointer; transition: 0.2s;
        }
        .country-card:active { background: rgba(255,255,255,0.15); transform: scale(0.95); }
        .c-flag { font-size: 2.5rem; display: block; margin-bottom: 5px; }
        .c-name { font-size: 0.9rem; font-weight: 600; color: #ddd; }

        /* ==================== HUD & MAP ==================== */
        #top-hud {
            position: absolute; top: var(--safe-top); left: 0; width: 100%;
            padding: 0 15px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 100; pointer-events: none;
        }
        .hud-box {
            background: rgba(10,10,15,0.6); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;
            padding: 10px 16px; color: white; margin-bottom: 8px;
            pointer-events: all; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        #map-container {
            position: absolute; bottom: 120px; right: 20px;
            width: 90vw; max-width: 450px; height: 45vh;
            background: #1a1a1a; 
            border: 2px solid rgba(255,255,255,0.2); border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); z-index: 200;
            transform: scale(0); opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            padding: 0; overflow: hidden;
        }
        #map-container.open { transform: scale(1); opacity: 1; pointer-events: all; }
        #map-container.map-result-mode {
            bottom: 0 !important; right: 0 !important; width: 100% !important; height: 100% !important;
            border-radius: 0 !important; max-width: none; z-index: 10;
        }
        #map { width: 100%; height: 100%; }

        #confirm-btn {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 80%; padding: 15px; background: var(--primary-grad);
            color: white; font-weight: 800; border: none; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,198,255,0.4); z-index: 210;
            display: none;
        }
        #map-container.open #confirm-btn { display: block; }

        /* ==================== RESULT SHEET ==================== */
        #result-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(10, 12, 18, 0.95);
            backdrop-filter: blur(40px);
            border-top: 1px solid rgba(255,255,255,0.15);
            border-radius: 30px 30px 0 0;
            z-index: 3000; transform: translateY(110%); 
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 30px 25px 40px 25px; box-sizing: border-box;
            color: white;
        }
        #result-sheet.show { transform: translateY(0); }

        /* ==================== LOBBY & QR ==================== */
        #qrcode-container {
            background: white; padding: 15px; border-radius: 15px; margin: 20px 0;
            box-shadow: 0 0 30px rgba(0,198,255,0.2);
        }
        #player-list { 
            width: 100%; max-width: 320px; max-height: 250px; 
            margin: 10px 0; overflow-y: auto; 
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .player-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 5px; 
            border-radius: 10px; font-size: 0.9rem;
        }

        #mobile-map-toggle {
            position: absolute; bottom: 30px; right: 20px;
            width: 65px; height: 65px; border-radius: 50%;
            background: var(--primary-grad); color: white; font-size: 30px;
            z-index: 100; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3);
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>

    <button id="settings-btn" onclick="window.toggleLanguage()">üåê</button>

    <!-- LOADING -->
    <div id="loading" class="full-screen-menu" style="background:#050505; z-index:8000;">
        <lottie-player 
            src="https://raw.githubusercontent.com/Vasiliy-katsyka/GeoGuessr/main/ChicklingEmoji_AgAD1S0AAkOY8Ug.json" 
            background="transparent" speed="1" style="width: 150px; height: 150px;" loop autoplay>
        </lottie-player>
    </div>

    <!-- MAIN MENU -->
    <div id="main-menu" class="full-screen-menu hidden">
        <lottie-player 
            src="https://raw.githubusercontent.com/Vasiliy-katsyka/GeoGuessr/main/RestrictedEmoji_AgADHFgAAt1K8Eo.json" 
            background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: -10px;" loop autoplay>
        </lottie-player>
        
        <div class="menu-title" data-i18n="app_title">GeoUltimate</div>
        <div class="menu-subtitle" data-i18n="app_subtitle">Global Exploration</div>

        <!-- Global Modes -->
        <button class="btn-main btn-blue" onclick="window.startGame('endless', 'global')">
            <span data-i18n="btn_endless">‚àû Endless World</span>
        </button>
        <button class="btn-main btn-orange" onclick="window.startGame('challenge', 'global')">
            <span data-i18n="btn_challenge">‚è±Ô∏è World Challenge</span>
        </button>
        
        <!-- New Country Mode -->
        <button class="btn-main btn-dark" style="border-color: rgba(0,198,255,0.4);" onclick="window.openCountryMenu()">
            <span data-i18n="btn_country">üè≥Ô∏è Country Mode</span>
        </button>

        <!-- Multiplayer -->
        <button class="btn-main btn-green" onclick="window.openFriendMenu()">
            <span data-i18n="btn_friend">üë• Party Mode</span>
        </button>
        
        <!-- Profile -->
        <button class="btn-main btn-dark" onclick="window.openProfile()">
            <span data-i18n="btn_profile">üë§ My Profile</span>
        </button>
    </div>

    <!-- COUNTRY SELECT MENU -->
    <div id="country-menu" class="full-screen-menu hidden scrollable">
        <h2 style="margin-bottom: 20px;" data-i18n="lbl_select_country">Select Country</h2>
        <div id="country-grid">
            <!-- Populated by JS -->
        </div>
        <button class="btn-main btn-dark" onclick="window.showMainMenu()" data-i18n="btn_back">Back</button>
    </div>

    <!-- COUNTRY MODE TYPE SELECT -->
    <div id="country-mode-select" class="full-screen-menu hidden" style="background:rgba(0,0,0,0.8);">
        <h2 id="cms-title" style="font-size:3rem; margin-bottom:5px;">Country</h2>
        <p style="color:#aaa; margin-bottom:30px;">Choose Game Type</p>
        
        <button class="btn-main btn-blue" onclick="window.confirmCountryMode('endless')">
            <span data-i18n="btn_endless">‚àû Endless</span>
        </button>
        <button class="btn-main btn-orange" onclick="window.confirmCountryMode('challenge')">
            <span data-i18n="btn_challenge">‚è±Ô∏è Challenge</span>
        </button>
        <button class="btn-main btn-dark" style="margin-top:20px" onclick="document.getElementById('country-mode-select').classList.add('hidden')">Cancel</button>
    </div>

    <!-- FRIEND MENU -->
    <div id="friend-menu" class="full-screen-menu hidden">
        <h2 style="margin-bottom: 20px;" data-i18n="friend_mode">Party Mode</h2>
        
        <div class="glass-panel" style="padding:25px; width:100%; max-width:320px; margin-bottom:20px;">
            <div style="font-size:0.8rem; text-transform:uppercase; color:#aaa; margin-bottom:10px;" data-i18n="lbl_create">Create Room</div>
            <button id="btn-create" class="btn-main btn-green" style="width:100%; margin:0;" onclick="window.createRoom()">
                <span class="btn-content" data-i18n="btn_create_play">Create & Play</span>
                <div class="btn-spinner"></div>
            </button>
        </div>

        <div class="glass-panel" style="padding:25px; width:100%; max-width:320px; text-align:center;">
            <div style="font-size:0.8rem; text-transform:uppercase; color:#aaa;" data-i18n="lbl_join">Join Room</div>
            <input type="text" id="join-code" class="input-code" placeholder="12345" maxlength="5">
            
            <button class="btn-main btn-dark" style="width:100%; margin:10px 0 5px 0; font-size:0.9rem;" onclick="window.scanQR()">
                üì∑ Scan QR
            </button>
            
            <button id="btn-join" class="btn-main btn-blue" style="width:100%; margin:0;" onclick="window.joinRoom()">
                <span class="btn-content" data-i18n="btn_join">Join Room</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
        <button class="btn-main btn-dark" style="margin-top:20px;" onclick="window.showMainMenu()" data-i18n="btn_back">Back</button>
    </div>

    <!-- LOBBY -->
    <div id="lobby-screen" class="full-screen-menu hidden">
        <h1 id="lobby-code-display" style="font-size:3rem; margin:0; color:#00C6FF;">----</h1>
        
        <!-- QR Container -->
        <div id="qrcode-container"></div>
        
        <p style="color:#aaa; margin-bottom:10px;" data-i18n="lbl_share_code">Scan or Share Code</p>
        <div id="player-list"></div>
        <div id="lobby-count" style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">0/20 Players</div>

        <div id="host-actions" class="hidden" style="width:100%; max-width:300px;">
            <button class="btn-main btn-green" onclick="window.hostStartGame()" data-i18n="btn_start_game">Start Game</button>
        </div>
        
        <div id="lobby-status" style="margin-top:15px; color:#666; font-size:0.9rem;" data-i18n="lbl_waiting">Waiting for host...</div>
        <button class="btn-main btn-dark" style="margin-top: 20px; background:rgba(255,50,50,0.2);" onclick="window.leaveLobby()" data-i18n="btn_leave">Leave</button>
    </div>

    <!-- PROFILE (Simple) -->
    <div id="profile-screen" class="full-screen-menu hidden scrollable">
        <h1 style="margin-bottom:10px;">Stats</h1>
        <div class="glass-panel" style="padding:20px; width:80%; margin-bottom:15px;">
            <div style="font-size:2rem; font-weight:800; color:#00C6FF;" id="pf-score">0</div>
            <div style="color:#aaa;">Total XP</div>
        </div>
        <div class="glass-panel" style="padding:20px; width:80%;">
            <div style="font-size:2rem; font-weight:800;" id="pf-games">0</div>
            <div style="color:#aaa;">Rounds Played</div>
        </div>
        <button class="btn-main btn-dark" style="margin-top:30px;" onclick="window.showMainMenu()">Back</button>
    </div>

    <!-- GAME HUD -->
    <div id="mly" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;"></div>
    
    <div id="top-hud">
        <div style="display:flex; flex-direction:column;">
            <div id="timer-box" class="hud-box" style="font-variant-numeric: tabular-nums;">02:00</div>
        </div>
        <div class="hud-box" style="text-align:right;">
            <div id="round-indicator" style="font-size:0.7rem; color:#aaa; margin-bottom:2px;">ROUND 1</div>
            <div>XP <span id="score-val" style="color:#f1c40f; font-weight:bold;">0</span></div>
        </div>
    </div>

    <button id="mobile-map-toggle" onclick="window.toggleMap()">üó∫Ô∏è</button>

    <div id="map-container">
        <div id="map"></div>
        <button id="confirm-btn" onclick="window.submitGuess()" data-i18n="btn_guess_confirm">CONFIRM GUESS</button>
    </div>

    <!-- RESULTS -->
    <div id="result-sheet">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
            <div>
                <div id="res-dist" style="font-size:2.5rem; font-weight:900; line-height:1;">0m</div>
                <div id="res-pts" style="color:#f1c40f; font-size:1.5rem; font-weight:700;">+0 pts</div>
            </div>
            <div style="text-align:right; max-width:50%;">
                <div id="res-loc" style="font-size:1rem; color:#ddd;">Location</div>
                <div id="res-country" style="font-size:0.9rem; color:#888;">Country</div>
            </div>
        </div>
        
        <!-- Leaderboard for MP -->
        <div id="res-mp-list" class="scrollable" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:15px; max-height:120px; display:none; margin-bottom:15px;"></div>

        <button id="next-btn" class="btn-main btn-blue" style="width:100%; max-width:none;" onclick="window.nextRound()">
            <span class="btn-content" data-i18n="btn_next">Next Round</span>
            <div class="btn-spinner"></div>
        </button>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDJjo66zCwODJW1J2SoVQ2B8tIH5FPUu1A",
            authDomain: "mytube-cd424.firebaseapp.com",
            databaseURL: "https://mytube-cd424-default-rtdb.firebaseio.com",
            projectId: "mytube-cd424",
            storageBucket: "mytube-cd424.appspot.com",
            messagingSenderId: "865512387483",
            appId: "1:865512387483:web:de8245f509dba9bbd5273e"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- DATA ---
        const MLY_TOKEN = 'MLY|26213154491618951|523c0418de2d6a8118aefdab3284d6c2';
        
        const LOCATIONS_GLOBAL = [
            // --- RUSSIA (Existing + 8 New) ---
            { name: "Saint Petersburg, Russia", flag: "üá∑üá∫", lat: 59.9311, lng: 30.3609 },
            { name: "Moscow, Russia", flag: "üá∑üá∫", lat: 55.7558, lng: 37.6173 },
            { name: "Kazan, Russia", flag: "üá∑üá∫", lat: 55.7963, lng: 49.1088 },
            { name: "Sochi, Russia", flag: "üá∑üá∫", lat: 43.5852, lng: 39.7231 },
            { name: "Novosibirsk, Russia", flag: "üá∑üá∫", lat: 55.0302, lng: 82.9204 },
            { name: "Yekaterinburg, Russia", flag: "üá∑üá∫", lat: 56.8389, lng: 60.6057 },
            { name: "Vladivostok, Russia", flag: "üá∑üá∫", lat: 43.1198, lng: 131.8869 },
            { name: "Nizhny Novgorod, Russia", flag: "üá∑üá∫", lat: 56.2965, lng: 43.9361 },
            { name: "Kaliningrad, Russia", flag: "üá∑üá∫", lat: 54.7104, lng: 20.4522 },

            // --- NORTH AMERICA ---
            { name: "New York, USA", flag: "üá∫üá∏", lat: 40.7128, lng: -74.0060 },
            { name: "Los Angeles, USA", flag: "üá∫üá∏", lat: 34.0522, lng: -118.2437 },
            { name: "Chicago, USA", flag: "üá∫üá∏", lat: 41.8781, lng: -87.6298 },
            { name: "San Francisco, USA", flag: "üá∫üá∏", lat: 37.7749, lng: -122.4194 },
            { name: "Miami, USA", flag: "üá∫üá∏", lat: 25.7617, lng: -80.1918 },
            { name: "Las Vegas, USA", flag: "üá∫üá∏", lat: 36.1699, lng: -115.1398 },
            { name: "Seattle, USA", flag: "üá∫üá∏", lat: 47.6062, lng: -122.3321 },
            { name: "Boston, USA", flag: "üá∫üá∏", lat: 42.3601, lng: -71.0589 },
            { name: "Austin, USA", flag: "üá∫üá∏", lat: 30.2672, lng: -97.7431 },
            { name: "Denver, USA", flag: "üá∫üá∏", lat: 39.7392, lng: -104.9903 },
            { name: "New Orleans, USA", flag: "üá∫üá∏", lat: 29.9511, lng: -90.0715 },
            { name: "Philadelphia, USA", flag: "üá∫üá∏", lat: 39.9526, lng: -75.1652 },
            { name: "San Diego, USA", flag: "üá∫üá∏", lat: 32.7157, lng: -117.1611 },
            { name: "Portland, USA", flag: "üá∫üá∏", lat: 45.5051, lng: -122.6750 },
            { name: "Toronto, Canada", flag: "üá®üá¶", lat: 43.6532, lng: -79.3832 },
            { name: "Vancouver, Canada", flag: "üá®üá¶", lat: 49.2827, lng: -123.1207 },
            { name: "Montreal, Canada", flag: "üá®üá¶", lat: 45.5017, lng: -73.5673 },
            { name: "Calgary, Canada", flag: "üá®üá¶", lat: 51.0447, lng: -114.0719 },
            { name: "Ottawa, Canada", flag: "üá®üá¶", lat: 45.4215, lng: -75.6972 },
            { name: "Mexico City, Mexico", flag: "üá≤üáΩ", lat: 19.4326, lng: -99.1332 },
            { name: "Guadalajara, Mexico", flag: "üá≤üáΩ", lat: 20.6597, lng: -103.3496 },
            { name: "Monterrey, Mexico", flag: "üá≤üáΩ", lat: 25.6866, lng: -100.3161 },

            // --- SOUTH AMERICA ---
            { name: "S√£o Paulo, Brazil", flag: "üáßüá∑", lat: -23.5505, lng: -46.6333 },
            { name: "Rio de Janeiro, Brazil", flag: "üáßüá∑", lat: -22.9068, lng: -43.1729 },
            { name: "Bras√≠lia, Brazil", flag: "üáßüá∑", lat: -15.7975, lng: -47.8919 },
            { name: "Salvador, Brazil", flag: "üáßüá∑", lat: -12.9777, lng: -38.5016 },
            { name: "Buenos Aires, Argentina", flag: "üá¶üá∑", lat: -34.6037, lng: -58.3816 },
            { name: "Mendoza, Argentina", flag: "üá¶üá∑", lat: -32.8895, lng: -68.8458 },
            { name: "Santiago, Chile", flag: "üá®üá±", lat: -33.4489, lng: -70.6693 },
            { name: "Valparaiso, Chile", flag: "üá®üá±", lat: -33.0472, lng: -71.6127 },
            { name: "Bogot√°, Colombia", flag: "üá®üá¥", lat: 4.7110, lng: -74.0721 },
            { name: "Medell√≠n, Colombia", flag: "üá®üá¥", lat: 6.2442, lng: -75.5812 },
            { name: "Lima, Peru", flag: "üáµüá™", lat: -12.0464, lng: -77.0428 },
            { name: "Cusco, Peru", flag: "üáµüá™", lat: -13.5320, lng: -71.9675 },
            { name: "Quito, Ecuador", flag: "üá™üá®", lat: -0.1807, lng: -78.4678 },
            { name: "Montevideo, Uruguay", flag: "üá∫üáæ", lat: -34.9011, lng: -56.1645 },
            { name: "La Paz, Bolivia", flag: "üáßüá¥", lat: -16.5004, lng: -68.1193 },

            // --- EUROPE ---
            { name: "London, UK", flag: "üá¨üáß", lat: 51.5074, lng: -0.1278 },
            { name: "Manchester, UK", flag: "üá¨üáß", lat: 53.4808, lng: -2.2426 },
            { name: "Edinburgh, UK", flag: "üá¨üáß", lat: 55.9533, lng: -3.1883 },
            { name: "Paris, France", flag: "üá´üá∑", lat: 48.8566, lng: 2.3522 },
            { name: "Lyon, France", flag: "üá´üá∑", lat: 45.7640, lng: 4.8357 },
            { name: "Marseille, France", flag: "üá´üá∑", lat: 43.2965, lng: 5.3698 },
            { name: "Nice, France", flag: "üá´üá∑", lat: 43.7102, lng: 7.2620 },
            { name: "Madrid, Spain", flag: "üá™üá∏", lat: 40.4168, lng: -3.7038 },
            { name: "Barcelona, Spain", flag: "üá™üá∏", lat: 41.3851, lng: 2.1734 },
            { name: "Seville, Spain", flag: "üá™üá∏", lat: 37.3891, lng: -5.9845 },
            { name: "Valencia, Spain", flag: "üá™üá∏", lat: 39.4699, lng: -0.3763 },
            { name: "Lisbon, Portugal", flag: "üáµüáπ", lat: 38.7223, lng: -9.1393 },
            { name: "Porto, Portugal", flag: "üáµüáπ", lat: 41.1579, lng: -8.6291 },
            { name: "Berlin, Germany", flag: "üá©üá™", lat: 52.5200, lng: 13.4050 },
            { name: "Munich, Germany", flag: "üá©üá™", lat: 48.1351, lng: 11.5820 },
            { name: "Hamburg, Germany", flag: "üá©üá™", lat: 53.5511, lng: 9.9937 },
            { name: "Frankfurt, Germany", flag: "üá©üá™", lat: 50.1109, lng: 8.6821 },
            { name: "Cologne, Germany", flag: "üá©üá™", lat: 50.9375, lng: 6.9603 },
            { name: "Rome, Italy", flag: "üáÆüáπ", lat: 41.9028, lng: 12.4964 },
            { name: "Milan, Italy", flag: "üáÆüáπ", lat: 45.4642, lng: 9.1900 },
            { name: "Venice, Italy", flag: "üáÆüáπ", lat: 45.4408, lng: 12.3155 },
            { name: "Florence, Italy", flag: "üáÆüáπ", lat: 43.7696, lng: 11.2558 },
            { name: "Naples, Italy", flag: "üáÆüáπ", lat: 40.8518, lng: 14.2681 },
            { name: "Amsterdam, Netherlands", flag: "üá≥üá±", lat: 52.3676, lng: 4.9041 },
            { name: "Rotterdam, Netherlands", flag: "üá≥üá±", lat: 51.9244, lng: 4.4777 },
            { name: "Brussels, Belgium", flag: "üáßüá™", lat: 50.8503, lng: 4.3517 },
            { name: "Vienna, Austria", flag: "üá¶üáπ", lat: 48.2082, lng: 16.3738 },
            { name: "Prague, Czechia", flag: "üá®üáø", lat: 50.0755, lng: 14.4378 },
            { name: "Budapest, Hungary", flag: "üá≠üá∫", lat: 47.4979, lng: 19.0402 },
            { name: "Stockholm, Sweden", flag: "üá∏üá™", lat: 59.3293, lng: 18.0686 },
            { name: "Gothenburg, Sweden", flag: "üá∏üá™", lat: 57.7089, lng: 11.9746 },
            { name: "Oslo, Norway", flag: "üá≥üá¥", lat: 59.9139, lng: 10.7522 },
            { name: "Bergen, Norway", flag: "üá≥üá¥", lat: 60.3913, lng: 5.3221 },
            { name: "Helsinki, Finland", flag: "üá´üáÆ", lat: 60.1699, lng: 24.9384 },
            { name: "Copenhagen, Denmark", flag: "üá©üá∞", lat: 55.6761, lng: 12.5683 },
            { name: "Aarhus, Denmark", flag: "üá©üá∞", lat: 56.1629, lng: 10.2039 },
            { name: "Warsaw, Poland", flag: "üáµüá±", lat: 52.2297, lng: 21.0122 },
            { name: "Krakow, Poland", flag: "üáµüá±", lat: 50.0647, lng: 19.9450 },
            { name: "Gdansk, Poland", flag: "üáµüá±", lat: 54.3520, lng: 18.6466 },
            { name: "Athens, Greece", flag: "üá¨üá∑", lat: 37.9838, lng: 23.7275 },
            { name: "Thessaloniki, Greece", flag: "üá¨üá∑", lat: 40.6401, lng: 22.9444 },
            { name: "Zurich, Switzerland", flag: "üá®üá≠", lat: 47.3769, lng: 8.5417 },
            { name: "Geneva, Switzerland", flag: "üá®üá≠", lat: 46.2044, lng: 6.1432 },
            { name: "Dublin, Ireland", flag: "üáÆüá™", lat: 53.3498, lng: -6.2603 },
            { name: "Zagreb, Croatia", flag: "üá≠üá∑", lat: 45.8150, lng: 15.9819 },
            { name: "Dubrovnik, Croatia", flag: "üá≠üá∑", lat: 42.6507, lng: 18.0944 },
            { name: "Bucharest, Romania", flag: "üá∑üá¥", lat: 44.4268, lng: 26.1025 },
            { name: "Sofia, Bulgaria", flag: "üáßüá¨", lat: 42.6977, lng: 23.3219 },
            { name: "Belgrade, Serbia", flag: "üá∑üá∏", lat: 44.7866, lng: 20.4489 },
            { name: "Tallinn, Estonia", flag: "üá™üá™", lat: 59.4370, lng: 24.7536 },
            { name: "Riga, Latvia", flag: "üá±üáª", lat: 56.9496, lng: 24.1052 },
            { name: "Vilnius, Lithuania", flag: "üá±üáπ", lat: 54.6872, lng: 25.2797 },
            { name: "Reykjavik, Iceland", flag: "üáÆüá∏", lat: 64.1265, lng: -21.8174 },

            // --- ASIA ---
            { name: "Istanbul, Turkey", flag: "üáπüá∑", lat: 41.0082, lng: 28.9784 },
            { name: "Ankara, Turkey", flag: "üáπüá∑", lat: 39.9334, lng: 32.8597 },
            { name: "Antalya, Turkey", flag: "üáπüá∑", lat: 36.8969, lng: 30.7133 },
            { name: "Tokyo, Japan", flag: "üáØüáµ", lat: 35.6762, lng: 139.6503 },
            { name: "Osaka, Japan", flag: "üáØüáµ", lat: 34.6937, lng: 135.5023 },
            { name: "Kyoto, Japan", flag: "üáØüáµ", lat: 35.0116, lng: 135.7681 },
            { name: "Sapporo, Japan", flag: "üáØüáµ", lat: 43.0618, lng: 141.3545 },
            { name: "Fukuoka, Japan", flag: "üáØüáµ", lat: 33.5902, lng: 130.4017 },
            { name: "Seoul, South Korea", flag: "üá∞üá∑", lat: 37.5665, lng: 126.9780 },
            { name: "Busan, South Korea", flag: "üá∞üá∑", lat: 35.1796, lng: 129.0756 },
            { name: "Taipei, Taiwan", flag: "üáπüáº", lat: 25.0330, lng: 121.5654 },
            { name: "Kaohsiung, Taiwan", flag: "üáπüáº", lat: 22.6273, lng: 120.3014 },
            { name: "Bangkok, Thailand", flag: "üáπüá≠", lat: 13.7563, lng: 100.5018 },
            { name: "Chiang Mai, Thailand", flag: "üáπüá≠", lat: 18.7883, lng: 98.9853 },
            { name: "Singapore", flag: "üá∏üá¨", lat: 1.3521, lng: 103.8198 },
            { name: "Kuala Lumpur, Malaysia", flag: "üá≤üáæ", lat: 3.1390, lng: 101.6869 },
            { name: "Jakarta, Indonesia", flag: "üáÆüá©", lat: -6.2088, lng: 106.8456 },
            { name: "Bali (Denpasar), Indonesia", flag: "üáÆüá©", lat: -8.6705, lng: 115.2126 },
            { name: "Manila, Philippines", flag: "üáµüá≠", lat: 14.5995, lng: 120.9842 },
            { name: "Cebu City, Philippines", flag: "üáµüá≠", lat: 10.3157, lng: 123.8854 },
            { name: "Ho Chi Minh City, Vietnam", flag: "üáªüá≥", lat: 10.8231, lng: 106.6297 },
            { name: "Hanoi, Vietnam", flag: "üáªüá≥", lat: 21.0285, lng: 105.8542 },
            { name: "Dubai, UAE", flag: "üá¶üá™", lat: 25.2048, lng: 55.2708 },
            { name: "Abu Dhabi, UAE", flag: "üá¶üá™", lat: 24.4539, lng: 54.3773 },
            { name: "Doha, Qatar", flag: "üá∂üá¶", lat: 25.2854, lng: 51.5310 },
            { name: "Tel Aviv, Israel", flag: "üáÆüá±", lat: 32.0853, lng: 34.7818 },
            { name: "Jerusalem, Israel", flag: "üáÆüá±", lat: 31.7683, lng: 35.2137 },
            { name: "Mumbai, India", flag: "üáÆüá≥", lat: 19.0760, lng: 72.8777 },
            { name: "New Delhi, India", flag: "üáÆüá≥", lat: 28.6139, lng: 77.2090 },
            { name: "Bangalore, India", flag: "üáÆüá≥", lat: 12.9716, lng: 77.5946 },
            { name: "Colombo, Sri Lanka", flag: "üá±üá∞", lat: 6.9271, lng: 79.8612 },
            { name: "Ulaanbaatar, Mongolia", flag: "üá≤üá≥", lat: 47.9181, lng: 106.9176 },

            // --- AFRICA ---
            { name: "Cape Town, South Africa", flag: "üáøüá¶", lat: -33.9249, lng: 18.4241 },
            { name: "Johannesburg, South Africa", flag: "üáøüá¶", lat: -26.2041, lng: 28.0473 },
            { name: "Durban, South Africa", flag: "üáøüá¶", lat: -29.8587, lng: 31.0218 },
            { name: "Nairobi, Kenya", flag: "üá∞üá™", lat: -1.2921, lng: 36.8219 },
            { name: "Tunis, Tunisia", flag: "üáπüá≥", lat: 36.8065, lng: 10.1815 },
            { name: "Cairo, Egypt", flag: "üá™üá¨", lat: 30.0444, lng: 31.2357 },
            { name: "Marrakech, Morocco", flag: "üá≤üá¶", lat: 31.6295, lng: -7.9811 },
            { name: "Casablanca, Morocco", flag: "üá≤üá¶", lat: 33.5731, lng: -7.5898 },
            { name: "Dakar, Senegal", flag: "üá∏üá≥", lat: 14.7167, lng: -17.4677 },
            { name: "Accra, Ghana", flag: "üá¨üá≠", lat: 5.6037, lng: -0.1870 },
            { name: "Lagos, Nigeria", flag: "üá≥üá¨", lat: 6.5244, lng: 3.3792 },

            // --- OCEANIA ---
            { name: "Sydney, Australia", flag: "üá¶üá∫", lat: -33.8688, lng: 151.2093 },
            { name: "Melbourne, Australia", flag: "üá¶üá∫", lat: -37.8136, lng: 144.9631 },
            { name: "Brisbane, Australia", flag: "üá¶üá∫", lat: -27.4698, lng: 153.0251 },
            { name: "Perth, Australia", flag: "üá¶üá∫", lat: -31.9505, lng: 115.8605 },
            { name: "Adelaide, Australia", flag: "üá¶üá∫", lat: -34.9285, lng: 138.6007 },
            { name: "Hobart, Australia", flag: "üá¶üá∫", lat: -42.8821, lng: 147.3272 },
            { name: "Auckland, New Zealand", flag: "üá≥üáø", lat: -36.8485, lng: 174.7633 },
            { name: "Wellington, New Zealand", flag: "üá≥üáø", lat: -41.2865, lng: 174.7762 },
            { name: "Christchurch, New Zealand", flag: "üá≥üáø", lat: -43.5321, lng: 172.6362 }
        ];

        // 2. COUNTRY SPECIFIC POOLS
        const COUNTRY_DATA = {
            'ru': { name: "Russia", flag: "üá∑üá∫", cities: [
                { lat: 55.7558, lng: 37.6173 }, { lat: 59.9311, lng: 30.3609 }, { lat: 43.5852, lng: 39.7231 }, 
                { lat: 55.7963, lng: 49.1088 }, { lat: 56.8389, lng: 60.6057 }, { lat: 43.1198, lng: 131.8869 },
                { lat: 55.0302, lng: 82.9204 }, { lat: 56.2965, lng: 43.9361 }, { lat: 54.7104, lng: 20.4522 },
                { lat: 51.5336, lng: 46.0343 }, { lat: 47.2357, lng: 39.7015 }, { lat: 58.0105, lng: 56.2294 }
            ]},
            'ee': { name: "Estonia", flag: "üá™üá™", cities: [
                { lat: 59.4370, lng: 24.7536 }, { lat: 58.3780, lng: 26.7290 }, { lat: 59.3797, lng: 28.1791 }, 
                { lat: 58.3859, lng: 24.4971 }, { lat: 58.3639, lng: 25.5900 }, { lat: 59.3467, lng: 26.3558 },
                { lat: 59.4716, lng: 25.0175 }, { lat: 59.3965, lng: 27.7618 }, { lat: 58.2526, lng: 22.4862 },
                { lat: 57.7765, lng: 26.0315 }
            ]},
            'us': { name: "USA", flag: "üá∫üá∏", cities: [
                { lat: 40.7128, lng: -74.0060 }, { lat: 34.0522, lng: -118.2437 }, { lat: 41.8781, lng: -87.6298 },
                { lat: 25.7617, lng: -80.1918 }, { lat: 47.6062, lng: -122.3321 }, { lat: 29.9511, lng: -90.0715 },
                { lat: 39.7392, lng: -104.9903 }, { lat: 36.1699, lng: -115.1398 }, { lat: 38.9072, lng: -77.0369 },
                { lat: 32.7767, lng: -96.7970 }
            ]},
            'fr': { name: "France", flag: "üá´üá∑", cities: [
                { lat: 48.8566, lng: 2.3522 }, { lat: 45.7640, lng: 4.8357 }, { lat: 43.2965, lng: 5.3698 },
                { lat: 44.8378, lng: -0.5792 }, { lat: 43.6047, lng: 1.4442 }, { lat: 43.7102, lng: 7.2620 },
                { lat: 48.5734, lng: 7.7521 }, { lat: 47.2184, lng: -1.5536 }, { lat: 50.6292, lng: 3.0573 }
            ]},
            'jp': { name: "Japan", flag: "üáØüáµ", cities: [
                { lat: 35.6762, lng: 139.6503 }, { lat: 34.6937, lng: 135.5023 }, { lat: 35.0116, lng: 135.7681 },
                { lat: 43.0618, lng: 141.3545 }, { lat: 33.5902, lng: 130.4017 }, { lat: 38.2682, lng: 140.8694 },
                { lat: 34.3853, lng: 132.4553 }, { lat: 26.2124, lng: 127.6809 }, { lat: 35.4437, lng: 139.6380 }
            ]},
            'br': { name: "Brazil", flag: "üáßüá∑", cities: [
                { lat: -23.5505, lng: -46.6333 }, { lat: -22.9068, lng: -43.1729 }, { lat: -15.7975, lng: -47.8919 },
                { lat: -12.9777, lng: -38.5016 }, { lat: -3.7172, lng: -38.5434 }, { lat: -30.0346, lng: -51.2177 },
                { lat: -1.4550, lng: -48.5024 }, { lat: -8.0476, lng: -34.8770 }, { lat: -19.9167, lng: -43.9345 }
            ]},
            'tr': { name: "Turkey", flag: "üáπüá∑", cities: [
                { lat: 41.0082, lng: 28.9784 }, { lat: 39.9334, lng: 32.8597 }, { lat: 38.4237, lng: 27.1428 },
                { lat: 36.8969, lng: 30.7133 }, { lat: 37.0000, lng: 35.3213 }, { lat: 37.0662, lng: 37.3833 },
                { lat: 41.2867, lng: 36.3300 }, { lat: 40.1828, lng: 29.0665 }, { lat: 38.7578, lng: 30.5387 }
            ]},
            'it': { name: "Italy", flag: "üáÆüáπ", cities: [
                { lat: 41.9028, lng: 12.4964 }, { lat: 45.4642, lng: 9.1900 }, { lat: 40.8518, lng: 14.2681 },
                { lat: 45.0703, lng: 7.6869 }, { lat: 38.1157, lng: 13.3615 }, { lat: 44.4949, lng: 11.3426 },
                { lat: 43.7696, lng: 11.2558 }, { lat: 45.4408, lng: 12.3155 }, { lat: 41.1171, lng: 16.8719 }
            ]},
            'de': { name: "Germany", flag: "üá©üá™", cities: [
                { lat: 52.5200, lng: 13.4050 }, { lat: 48.1351, lng: 11.5820 }, { lat: 53.5511, lng: 9.9937 },
                { lat: 50.9375, lng: 6.9603 }, { lat: 50.1109, lng: 8.6821 }, { lat: 48.7758, lng: 9.1829 },
                { lat: 51.2277, lng: 6.7735 }, { lat: 51.3397, lng: 12.3731 }, { lat: 51.0504, lng: 13.7373 }
            ]},
            'uk': { name: "UK", flag: "üá¨üáß", cities: [
                { lat: 51.5074, lng: -0.1278 }, { lat: 52.4862, lng: -1.8904 }, { lat: 55.8642, lng: -4.2518 },
                { lat: 53.4808, lng: -2.2426 }, { lat: 53.8008, lng: -1.5491 }, { lat: 55.9533, lng: -3.1883 },
                { lat: 51.4816, lng: -3.1791 }, { lat: 54.5973, lng: -5.9301 }, { lat: 53.4084, lng: -2.9916 }
            ]}
        };

        const USER = (window.Telegram?.WebApp?.initDataUnsafe?.user) || { id: 'test_'+Math.floor(Math.random()*1000), first_name: 'Guest' };
        
        const STATE = {
            lang: 'en',
            mode: 'menu', 
            countryFilter: null, // 'global' or 'ru', 'ee', etc.
            gameId: null, mpRole: null, 
            score: 0, round: 1, maxRounds: 5,
            timeLeft: 120, timer: null,
            currentLoc: null, isLocked: false,
            myUid: USER.id.toString(), myName: USER.first_name,
            stats: { score: parseInt(localStorage.getItem('geo_xp')||0), games: parseInt(localStorage.getItem('geo_games')||0) }
        };

        const TR = {
            en: { 
                app_title: "GeoUltimate", btn_country: "üè≥Ô∏è Country Mode", lbl_select_country: "Select Country", 
                btn_create_play: "Create & Play", btn_join: "Join Room", btn_endless: "Endless", btn_challenge: "Challenge",
                btn_guess_confirm: "CONFIRM GUESS", btn_next: "Next Round", lbl_waiting: "Waiting for host...",
                btn_start_game: "Start Game", btn_leave: "Leave", btn_back: "Back", btn_profile: "My Profile"
            },
            ru: { 
                app_title: "–ì–µ–æ–£–ª—å—Ç–∏–º–∞", btn_country: "üè≥Ô∏è –ü–æ –°—Ç—Ä–∞–Ω–∞–º", lbl_select_country: "–í—ã–±–µ—Ä–∏—Ç–µ –°—Ç—Ä–∞–Ω—É",
                btn_create_play: "–°–æ–∑–¥–∞—Ç—å –ò–≥—Ä—É", btn_join: "–í–æ–π—Ç–∏", btn_endless: "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ", btn_challenge: "–ù–∞ –í—Ä–µ–º—è",
                btn_guess_confirm: "–ü–û–î–¢–í–ï–†–î–ò–¢–¨", btn_next: "–î–∞–ª—å—à–µ", lbl_waiting: "–ñ–¥–µ–º —Ö–æ—Å—Ç–∞...",
                btn_start_game: "–ù–∞—á–∞—Ç—å", btn_leave: "–í—ã–π—Ç–∏", btn_back: "–ù–∞–∑–∞–¥", btn_profile: "–ü—Ä–æ—Ñ–∏–ª—å"
            }
        };

        let map, mly, guessMarker, resultLine, resultMarker, oppMarkers = [];

        // --- INIT ---
        window.onload = () => {
            initMap();
            initCountryGrid();
            updateStatsUI();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map);
            
            const { Viewer } = mapillary;
            mly = new Viewer({ accessToken: MLY_TOKEN, container: 'mly', component: { cover: false, sequence: false, direction: false } });

            map.on('click', (e) => {
                if(STATE.isLocked) return;
                if(guessMarker) map.removeLayer(guessMarker);
                guessMarker = L.marker(e.latlng).addTo(map);
                document.getElementById('confirm-btn').innerText = t('btn_guess_confirm');
                if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.selectionChanged();
            });
        }

        function t(k) { return TR[STATE.lang][k] || k; }
        
        window.toggleLanguage = () => {
            STATE.lang = STATE.lang === 'en' ? 'ru' : 'en';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = t(el.getAttribute('data-i18n')));
        };

        function updateStatsUI() {
            document.getElementById('pf-score').innerText = STATE.stats.score;
            document.getElementById('pf-games').innerText = STATE.stats.games;
        }

        // --- COUNTRY MODE LOGIC ---
        function initCountryGrid() {
            const grid = document.getElementById('country-grid');
            Object.keys(COUNTRY_DATA).forEach(code => {
                const c = COUNTRY_DATA[code];
                const div = document.createElement('div');
                div.className = 'country-card';
                div.innerHTML = `<span class="c-flag">${c.flag}</span><span class="c-name">${c.name}</span>`;
                div.onclick = () => window.selectCountry(code);
                grid.appendChild(div);
            });
        }

        window.openCountryMenu = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('country-menu').classList.remove('hidden');
        };

        window.selectCountry = (code) => {
            STATE.tempCountry = code;
            const c = COUNTRY_DATA[code];
            document.getElementById('cms-title').innerHTML = c.flag;
            document.getElementById('country-mode-select').classList.remove('hidden');
        };

        window.confirmCountryMode = (mode) => {
            document.getElementById('country-mode-select').classList.add('hidden');
            window.startGame(mode, STATE.tempCountry);
        };

        window.showMainMenu = () => {
            document.querySelectorAll('.full-screen-menu').forEach(e => e.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
        };
        
        window.openProfile = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('profile-screen').classList.remove('hidden');
        };

        // --- GAME LOGIC ---
        window.startGame = (mode, countryFilter) => {
            document.querySelectorAll('.full-screen-menu').forEach(e => e.classList.add('hidden'));
            
            STATE.mode = mode;
            STATE.countryFilter = countryFilter;
            STATE.score = 0;
            STATE.round = 1;
            
            // HUD
            document.getElementById('timer-box').style.display = (mode === 'challenge') ? 'block' : 'none';
            document.getElementById('score-val').innerText = '0';
            
            loadNewRound();
        };

        async function pickLocation() {
            let pool = LOCATIONS_GLOBAL;
            // Filter logic
            if(STATE.countryFilter && COUNTRY_DATA[STATE.countryFilter]) {
                pool = COUNTRY_DATA[STATE.countryFilter].cities;
            } else if (STATE.countryFilter === 'global') {
                pool = LOCATIONS_GLOBAL;
            }

            const city = pool[Math.floor(Math.random() * pool.length)];
            const range = 0.05; // 5km approx
            const rLat = city.lat + (Math.random() * range * 2 - range);
            const rLng = city.lng + (Math.random() * range * 2 - range);
            const bbox = `${rLng-0.005},${rLat-0.005},${rLng+0.005},${rLat+0.005}`;
            
            try {
                const res = await fetch(`https://graph.mapillary.com/images?access_token=${MLY_TOKEN}&fields=id,geometry&bbox=${bbox}&limit=1`);
                const data = await res.json();
                if(data.data && data.data.length > 0) {
                    return { 
                        id: data.data[0].id, 
                        lat: data.data[0].geometry.coordinates[1], 
                        lng: data.data[0].geometry.coordinates[0],
                        name: city.name || COUNTRY_DATA[STATE.countryFilter]?.name || "Unknown",
                        flag: city.flag || COUNTRY_DATA[STATE.countryFilter]?.flag || "üè≥Ô∏è"
                    };
                } else return pickLocation(); 
            } catch { return pickLocation(); }
        }

        function loadNewRound() {
            resetMap();
            document.getElementById('loading').classList.remove('hidden');
            pickLocation().then(loc => {
                STATE.currentLoc = loc;
                mly.moveTo(loc.id)
                    .then(() => {
                        document.getElementById('loading').classList.add('hidden');
                        if(STATE.mode === 'challenge') startTimer(120);
                    });
            });
            document.getElementById('round-indicator').innerText = `ROUND ${STATE.round}`;
        }

        function resetMap() {
            STATE.isLocked = false;
            if(guessMarker) map.removeLayer(guessMarker);
            if(resultLine) map.removeLayer(resultLine);
            if(resultMarker) map.removeLayer(resultMarker);
            oppMarkers.forEach(m => map.removeLayer(m)); oppMarkers = [];
            guessMarker = null;
            
            document.getElementById('map-container').classList.remove('open', 'map-result-mode');
            document.getElementById('mobile-map-toggle').style.display = 'flex';
            document.getElementById('result-sheet').classList.remove('show');
            document.getElementById('confirm-btn').style.display = 'none';
        }

        function startTimer(sec) {
            clearInterval(STATE.timer);
            STATE.timeLeft = sec;
            updateTimer();
            STATE.timer = setInterval(() => {
                STATE.timeLeft--;
                updateTimer();
                if(STATE.timeLeft <= 0) { clearInterval(STATE.timer); window.submitGuess(); }
            }, 1000);
        }
        function updateTimer() {
            const m = Math.floor(STATE.timeLeft/60);
            const s = STATE.timeLeft%60;
            document.getElementById('timer-box').innerText = `0${m}:${s<10?'0'+s:s}`;
        }

        // --- SUBMIT & RESULT ---
        window.submitGuess = () => {
            if(STATE.isLocked) return;
            STATE.isLocked = true; clearInterval(STATE.timer);
            
            const uLat = guessMarker ? guessMarker.getLatLng() : L.latLng(0,0);
            const actual = L.latLng(STATE.currentLoc.lat, STATE.currentLoc.lng);
            const dist = map.distance(uLat, actual);
            const pts = (guessMarker) ? Math.round(5000 * Math.exp(-dist/200000)) : 0;
            
            STATE.score += pts;
            STATE.stats.score += pts; STATE.stats.games++;
            localStorage.setItem('geo_xp', STATE.stats.score);
            localStorage.setItem('geo_games', STATE.stats.games);
            
            // UI
            document.getElementById('score-val').innerText = STATE.score;
            document.getElementById('res-dist').innerText = formatDist(dist);
            document.getElementById('res-pts').innerText = `+${pts}`;
            document.getElementById('res-loc').innerText = STATE.currentLoc.name;
            document.getElementById('res-country').innerText = STATE.currentLoc.flag;
            
            // Show Map
            document.getElementById('mobile-map-toggle').style.display = 'none';
            document.getElementById('map-container').classList.add('open', 'map-result-mode');
            setTimeout(() => map.invalidateSize(), 200);
            
            resultMarker = L.circleMarker(actual, {radius:8, color:'white', fillColor:'#0f0', fillOpacity:1}).addTo(map);
            resultLine = L.polyline([uLat, actual], {color:'#00C6FF', weight:3, dashArray:'10,10'}).addTo(map);
            map.fitBounds(L.latLngBounds([uLat, actual]), {padding:[50,50], maxZoom:14});

            document.getElementById('result-sheet').classList.add('show');

            if(STATE.mode === 'multi') {
                update(ref(db, `games/${STATE.gameId}/guesses/${STATE.myUid}`), {
                    lat: uLat.lat, lng: uLat.lng, pts: pts, name: STATE.myName
                });
                document.getElementById('next-btn').querySelector('.btn-content').innerText = "WAITING...";
            }
        };

        window.nextRound = () => {
            if(STATE.mode === 'multi') {
                if(STATE.mpRole === 'host') {
                    update(ref(db, `games/${STATE.gameId}`), { status: 'playing', round: STATE.round+1, guesses:null })
                    .then(() => {
                        pickLocation().then(l => update(ref(db, `games/${STATE.gameId}`), {location:l}));
                    });
                }
            } else {
                STATE.round++;
                loadNewRound();
            }
        };

        // --- MULTIPLAYER & QR ---
        window.openFriendMenu = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('friend-menu').classList.remove('hidden');
        };

        window.createRoom = () => {
            const btn = document.getElementById('btn-create');
            btn.classList.add('loading');
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            STATE.gameId = code; STATE.mpRole = 'host'; STATE.mode = 'multi';
            
            set(ref(db, 'games/'+code), {
                status: 'waiting', host: STATE.myUid, round: 1, mode: 'global',
                players: { [STATE.myUid]: { name: STATE.myName, score: 0 } }
            }).then(() => {
                btn.classList.remove('loading');
                enterLobby(code);
            });
        };

        window.joinRoom = () => {
            const code = document.getElementById('join-code').value;
            if(!code) return;
            const btn = document.getElementById('btn-join');
            btn.classList.add('loading');
            get(ref(db, 'games/'+code)).then(snap => {
                if(snap.exists()) {
                    STATE.gameId = code; STATE.mpRole = 'guest'; STATE.mode = 'multi';
                    update(ref(db, `games/${code}/players/${STATE.myUid}`), { name: STATE.myName, score: 0 })
                    .then(() => enterLobby(code));
                } else {
                    btn.classList.remove('loading'); alert('Invalid Code');
                }
            });
        };

        // --- QR CODE SCANNER (NATIVE TELEGRAM) ---
        window.scanQR = () => {
            if(window.Telegram?.WebApp?.showScanQrPopup) {
                window.Telegram.WebApp.showScanQrPopup({
                    text: 'Scan Host QR Code'
                }, (data) => {
                    // data is the string read from QR
                    if(data) {
                        document.getElementById('join-code').value = data;
                        window.Telegram.WebApp.closeScanQrPopup(); // Close UI
                        window.joinRoom(); // Auto join
                        return true;
                    }
                });
            } else {
                alert("QR Scanner only available in Telegram Mobile App");
            }
        };

        function enterLobby(code) {
            document.getElementById('friend-menu').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('lobby-code-display').innerText = code;
            
            // GENERATE QR
            const qrBox = document.getElementById('qrcode-container');
            qrBox.innerHTML = '';
            new QRCode(qrBox, { text: code, width: 128, height: 128 });

            if(STATE.mpRole === 'host') document.getElementById('host-actions').classList.remove('hidden');

            onValue(ref(db, 'games/'+code), snap => {
                const d = snap.val();
                if(!d) { window.location.reload(); return; }
                
                // Lobby UI
                const pList = document.getElementById('player-list');
                pList.innerHTML = '';
                const pKeys = Object.keys(d.players || {});
                document.getElementById('lobby-count').innerText = `${pKeys.length}/20 Players`;
                
                pKeys.forEach(uid => {
                    const p = d.players[uid];
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    div.innerHTML = `<span>${p.name}</span> <span style="color:#aaa">${p.score}pts</span>`;
                    pList.appendChild(div);
                });

                // Start Trigger
                if(d.status === 'playing' && document.getElementById('lobby-screen').classList.contains('hidden') === false) {
                    document.getElementById('lobby-screen').classList.add('hidden');
                    // Host sets initial location
                    if(STATE.mpRole === 'host') pickLocation().then(l => update(ref(db, `games/${code}`), {location:l}));
                }

                // Game Loop Sync
                if(d.status === 'playing' && d.location && (!STATE.currentLoc || STATE.currentLoc.id !== d.location.id)) {
                    STATE.currentLoc = d.location; STATE.round = d.round;
                    loadNewRound();
                }

                // Results Sync
                if(d.guesses) {
                    const guessCount = Object.keys(d.guesses).length;
                    const playerCount = Object.keys(d.players).length;
                    if(guessCount === playerCount && !document.getElementById('result-sheet').classList.contains('show')) {
                        showMpResults(d.guesses, d.location);
                    }
                }
            });
        }

        window.hostStartGame = () => update(ref(db, `games/${STATE.gameId}`), { status: 'playing' });
        window.leaveLobby = () => {
             remove(ref(db, `games/${STATE.gameId}/players/${STATE.myUid}`));
             window.location.reload();
        };

        function showMpResults(guesses, loc) {
            const list = document.getElementById('res-mp-list');
            list.style.display = 'block'; list.innerHTML = '';
            
            const actual = L.latLng(loc.lat, loc.lng);
            
            // Plot opponents
            Object.keys(guesses).forEach(uid => {
                const g = guesses[uid];
                const row = document.createElement('div');
                row.style.cssText = "display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;";
                row.innerHTML = `<span>${g.name}</span> <span style="color:#f1c40f">+${g.pts}</span>`;
                list.appendChild(row);

                if(uid !== STATE.myUid) {
                    const opLat = L.latLng(g.lat, g.lng);
                    const m = L.circleMarker(opLat, {radius:5, color:'#ff4b2b', fillColor:'#ff4b2b', fillOpacity:0.8}).addTo(map);
                    const l = L.polyline([opLat, actual], {color:'#ff4b2b', weight:1, opacity:0.5}).addTo(map);
                    oppMarkers.push(m, l);
                }
            });

            // If I haven't guessed yet (timeout), force show
            if(!STATE.isLocked) {
                document.getElementById('score-val').innerText = STATE.score;
                document.getElementById('res-dist').innerText = "-";
                document.getElementById('res-pts').innerText = "0 pts";
                document.getElementById('result-sheet').classList.add('show');
                setupMapResultMode(actual);
            }
            
            const btn = document.getElementById('next-btn');
            if(STATE.mpRole === 'host') {
                btn.querySelector('.btn-content').innerText = "Next Round";
                btn.disabled = false;
            } else {
                btn.querySelector('.btn-content').innerText = "Waiting for host...";
                btn.disabled = true;
            }
        }

        function setupMapResultMode(actual) {
            document.getElementById('map-container').classList.add('open', 'map-result-mode');
            setTimeout(() => map.invalidateSize(), 200);
            resultMarker = L.circleMarker(actual, {radius:8, color:'white', fillColor:'#0f0', fillOpacity:1}).addTo(map);
        }

        window.toggleMap = () => {
            const c = document.getElementById('map-container');
            const b = document.getElementById('mobile-map-toggle');
            if(c.classList.contains('open')) { c.classList.remove('open'); b.innerText = "üó∫Ô∏è"; } 
            else { c.classList.add('open'); b.innerText = "‚úñ"; setTimeout(() => map.invalidateSize(), 300); }
        };

        function formatDist(m) { return m < 1000 ? Math.round(m)+"m" : (m/1000).toFixed(1)+"km"; }
    </script>
</body>
</html>
