<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoGuessr</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            try {
                window.Telegram.WebApp.requestFullscreen(); 
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.disableVerticalSwipes();
            } catch (e) { console.log("Telegram FS failed", e); }
        }
    </script>

    <!-- External Libs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Lottie Player -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <style>
        /* ==================== THEME & VARS ==================== */
        :root {
            --bg-color: #0f0f12;
            --text-color: #ffffff;
            --primary-grad: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%);
            --glass-bg: rgba(25, 25, 35, 0.65);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --blur: 40px;
            --safe-top: 80px; 
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            overflow: hidden; -webkit-tap-highlight-color: transparent;
        }

        /* ==================== ANIMATED BACKGROUND ==================== */
        .bg-blob {
            position: absolute; border-radius: 50%;
            filter: blur(80px); opacity: 0.4; z-index: 0;
            animation: floatBlob 10s infinite alternate ease-in-out;
        }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: #00C6FF; }
        .blob-2 { bottom: -10%; right: -10%; width: 350px; height: 350px; background: #764ba2; animation-delay: -5s; }
        .blob-3 { top: 40%; left: 40%; width: 200px; height: 200px; background: #38ef7d; animation-duration: 15s; opacity: 0.2; }

        @keyframes floatBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        /* ==================== UTILS & GLASS ==================== */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border); border-radius: 24px;
            box-shadow: var(--glass-shadow);
        }
        .hidden { display: none !important; }
        
        /* Language Toggle - Hidden when .game-active is on body */
        #settings-btn {
            position: absolute; top: var(--safe-top); right: 20px; z-index: 6000;
            width: 42px; height: 42px; background: var(--glass-bg);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-size: 22px;
            backdrop-filter: blur(10px); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: opacity 0.3s;
        }
        body.game-active #settings-btn { opacity: 0; pointer-events: none; }

        /* ==================== MENUS ==================== */
        .full-screen-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            transition: opacity 0.3s ease;
        }
        /* Dark overlay for menus to make text pop over blobs */
        .menu-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.4); z-index: -1; backdrop-filter: blur(10px);
        }

        .menu-title { 
            font-size: 3.5rem; font-weight: 800; margin-bottom: 5px; 
            background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-align: center; letter-spacing: -1px; filter: drop-shadow(0 0 30px rgba(0, 198, 255, 0.4));
        }
        .menu-subtitle { font-size: 1.1rem; color: #ccc; margin-bottom: 40px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        .btn-main {
            width: 100%; max-width: 320px; padding: 18px; margin: 8px 0;
            border: none; border-radius: 18px; font-size: 1.1rem; font-weight: 600;
            cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px;
            position: relative; display: flex; align-items: center; justify-content: center; gap: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); background-size: 200% auto;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }
        .btn-main:active { transform: scale(0.97); }
        .btn-blue { background: var(--primary-grad); }
        .btn-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .btn-dark { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .btn-spinner {
            width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white; border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none;
        }
        .btn-main.loading .btn-content { display: none; }
        .btn-main.loading .btn-spinner { display: block; }

        /* ==================== FRIEND MENU (Centered) ==================== */
        #friend-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ==================== HUD ==================== */
        #top-hud {
            position: absolute; top: var(--safe-top); left: 0; width: 100%;
            padding: 0 15px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 100; pointer-events: none;
        }
        #timer-box, #host-controls, #score-box {
            background: var(--glass-bg); backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: 16px;
            padding: 10px 15px; color: white; margin-bottom: 5px;
            pointer-events: all; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #timer-box { font-size: 1.4rem; font-weight: 700; }
        #timer-box.warning { border-color: #ff4b2b; color: #ff4b2b; animation: pulse 1s infinite; }
        #score-box { text-align: right; }
        .score-val { color: #f1c40f; font-size: 1.1rem; font-weight: 800; font-family: monospace;}

        /* ==================== MAP & RESULTS ==================== */
        #mly { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        
        #mobile-map-toggle {
            position: absolute; bottom: 30px; right: 20px;
            width: 65px; height: 65px; border-radius: 50%;
            background: var(--primary-grad); color: white;
            font-size: 28px; border: 2px solid rgba(255,255,255,0.2);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #map-container {
            position: absolute; bottom: 110px; right: 20px;
            width: 90vw; max-width: 450px; height: 45vh;
            background: rgba(30, 30, 35, 0.8); backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 200;
            transform: scale(0); opacity: 0; pointer-events: none;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column; padding: 6px; box-sizing: border-box;
        }
        #map-container.open { transform: scale(1); opacity: 1; pointer-events: all; }
        #map-container.map-result-mode {
            bottom: 0 !important; right: 0 !important; width: 100% !important; height: 100% !important;
            border-radius: 0 !important; background: #1a1a1a; padding: 0; max-width: none; z-index: 10;
        }
        #map { flex-grow: 1; width: 100%; border-radius: 18px; }

        #confirm-btn {
            width: 100%; padding: 16px; margin-top: 6px;
            background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.4);
            font-weight: 800; border: none; text-transform: uppercase;
            border-radius: 14px; cursor: not-allowed; transition: 0.3s;
        }
        #confirm-btn.active { background: var(--primary-grad); color: white; cursor: pointer; }

        #result-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 15, 22, 0.95); backdrop-filter: blur(40px);
            border-top: 1px solid rgba(255,255,255,0.2);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            z-index: 3000; transform: translateY(110%); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 30px 25px 50px 25px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 20px; color: white;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }
        #result-sheet.show { transform: translateY(0); }

        .result-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .big-text { font-size: 2.2rem; font-weight: 900; line-height: 1; margin-bottom: 5px; }
        .btn-group { display: flex; gap: 15px; margin-top: 10px; }
        .btn-primary {
            background: var(--primary-grad); color: white; padding: 18px;
            border: none; border-radius: 16px; font-size: 16px; font-weight: bold; flex: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1); color: white; padding: 16px;
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; 
            font-size: 22px; width: 70px; cursor: pointer;
        }

        /* ==================== OTHERS ==================== */
        .toggle-group { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; }
        .toggle-btn {
            flex: 1; padding: 15px; border-radius: 14px; 
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); 
            color: #aaa; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .toggle-btn.selected { background: var(--primary-grad); color: white; border-color: transparent; }
        
        /* Player List & Profile */
        #player-list { width: 100%; max-width: 350px; max-height: 200px; margin: 20px 0; overflow-y: auto; }
        .player-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: rgba(255,255,255,0.05); margin-bottom: 8px; border-radius: 12px;
        }
        
        #profile-screen { background: rgba(10, 10, 15, 0.95); z-index: 6000; }
        .profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
        .big-avatar {
            width: 80px; height: 80px; border-radius: 50%; background: var(--primary-grad);
            display: flex; justify-content: center; align-items: center; font-size: 35px;
            margin-bottom: 15px; box-shadow: 0 0 30px rgba(0,198,255,0.4);
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 350px; margin-bottom: 30px; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 800; color: #fff; }
        .history-item { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; }

        /* LOADING SCREEN */
        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0f12; z-index: 8000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .scrollable { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>

    <!-- Background Blobs -->
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>

    <!-- SETTINGS / LANG TOGGLE -->
    <button id="settings-btn" onclick="window.toggleLanguage()">üåê</button>

    <!-- LOADING -->
    <div id="loading">
        <!-- Lottie Loader -->
        <lottie-player 
            src="https://raw.githubusercontent.com/Vasiliy-katsyka/GeoGuessr/main/ChicklingEmoji_AgAD1S0AAkOY8Ug.json" 
            background="transparent" 
            speed="1" 
            style="width: 150px; height: 150px;" 
            loop autoplay>
        </lottie-player>
        <h3 id="load-text" style="color: #666; font-weight:400; letter-spacing:1px; margin-top:-10px;">Loading...</h3>
    </div>

    <!-- MAIN MENU -->
    <div id="main-menu" class="full-screen-menu hidden">
        <div class="menu-overlay"></div>
        <!-- Title Lottie -->
        <lottie-player 
            src="https://raw.githubusercontent.com/Vasiliy-katsyka/GeoGuessr/main/RestrictedEmoji_AgADHFgAAt1K8Eo.json" 
            background="transparent" 
            speed="1" 
            style="width: 120px; height: 120px; margin-bottom: -20px;" 
            loop autoplay>
        </lottie-player>

        <div class="menu-title" data-i18n="app_title">GeoGuessr</div>
        <div class="menu-subtitle" data-i18n="app_subtitle">Explore the world & challenge friends</div>

        <button class="btn-main btn-blue" onclick="window.startEndless()">
            <span class="btn-content" data-i18n="btn_endless">‚àû Endless Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-purple" onclick="window.startChallenge()">
            <span class="btn-content" data-i18n="btn_challenge">‚è±Ô∏è Challenge Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-green" onclick="window.openFriendMenu()">
            <span class="btn-content" data-i18n="btn_friend">üë• Party Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-dark" onclick="window.openProfile()">
            <span class="btn-content" data-i18n="btn_profile">üë§ My Profile</span>
        </button>
    </div>

    <!-- PROFILE SCREEN -->
    <div id="profile-screen" class="full-screen-menu hidden scrollable">
        <div class="menu-overlay"></div>
        <div class="profile-header">
            <div class="big-avatar" id="pf-avatar">üë§</div>
            <h2 id="pf-name">User</h2>
            <div style="color: #aaa;" data-i18n="pf_rank">Novice Explorer</div>
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-val" id="pf-total-games">0</div>
                <div class="stat-label" data-i18n="lbl_games">Games</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="pf-total-score">0</div>
                <div class="stat-label" data-i18n="lbl_score">Total XP</div>
            </div>
        </div>

        <h3 style="align-self: flex-start; margin-left: 20px;" data-i18n="lbl_history">History</h3>
        <div id="history-list" class="history-list" style="width:100%; padding:0 20px; box-sizing:border-box;"></div>

        <button class="btn-main btn-dark" style="margin-top: 30px;" onclick="window.closeProfile()" data-i18n="btn_back">Back</button>
    </div>

    <!-- FRIEND MENU -->
    <div id="friend-menu" class="full-screen-menu hidden">
        <div class="menu-overlay"></div>
        <h2 style="margin-bottom: 20px; font-size:2rem;" data-i18n="friend_mode">Party Mode</h2>
        
        <div class="glass-panel" style="padding:25px; width:100%; max-width:350px; margin-bottom:20px; display:flex; flex-direction:column; align-items:center;">
            <h4 style="margin:0 0 15px 0; color:#ccc; font-size:0.8rem; text-transform:uppercase;" data-i18n="lbl_create">Create Room</h4>
            <div class="toggle-group" style="width:100%;">
                <button id="mp-mode-endless" class="toggle-btn selected" onclick="window.selectMpMode('endless')" data-i18n="mode_endless">Endless</button>
                <button id="mp-mode-challenge" class="toggle-btn" onclick="window.selectMpMode('challenge')" data-i18n="mode_challenge">Challenge</button>
            </div>
            <button id="btn-create" class="btn-main btn-green" style="width:100%; margin:0;" onclick="window.createRoom()">
                <span class="btn-content" data-i18n="btn_create_play">Create & Play</span>
                <div class="btn-spinner"></div>
            </button>
        </div>

        <div style="color:#aaa; font-weight:bold; margin-bottom: 20px;">‚Äî OR ‚Äî</div>

        <div class="glass-panel" style="padding:25px; width:100%; max-width:350px; text-align:center; display:flex; flex-direction:column; align-items:center;">
            <h4 style="margin:0 0 15px 0; color:#ccc; font-size:0.8rem; text-transform:uppercase;" data-i18n="lbl_join">Join Room</h4>
            <input type="text" id="join-code" class="input-code" placeholder="CODE" maxlength="5">
            <button id="btn-join" class="btn-main btn-blue" style="width:100%; margin:0;" onclick="window.joinRoom()">
                <span class="btn-content" data-i18n="btn_join">Join Room</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
        <button class="btn-main btn-dark" style="width:auto; padding: 10px 30px; margin-top: 20px;" onclick="window.showMainMenu()" data-i18n="btn_back">Back</button>
    </div>

    <!-- LOBBY -->
    <div id="lobby-screen" class="full-screen-menu hidden">
        <div class="menu-overlay"></div>
        <h1 id="lobby-code-display" style="font-size:3.5rem; background: var(--primary-grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:5px; margin:0;">----</h1>
        <p style="color:#ccc;" data-i18n="lbl_share_code">Share code with friends</p>
        
        <div id="player-list"></div>

        <div id="host-actions" class="hidden" style="width:100%; max-width:320px;">
            <button class="btn-main btn-green" onclick="window.hostStartGame()" data-i18n="btn_start_game">Start Game</button>
        </div>
        
        <div id="lobby-status" style="margin-top:20px; color:#aaa;" data-i18n="lbl_waiting">Waiting for players...</div>
        <button class="btn-main btn-red" style="width:auto; margin-top: 30px;" onclick="window.leaveLobby()" data-i18n="btn_leave">Leave</button>
    </div>

    <!-- GAME UI -->
    <div id="mly"></div>
    
    <div id="top-hud">
        <div style="display:flex; flex-direction:column;">
            <div id="timer-box">02:00</div>
            <div id="host-controls" class="hidden">
                <span style="font-size:10px; color:#aaa; margin-bottom:2px;">ADMIN</span>
                <button class="mini-btn" style="background:rgba(255,255,255,0.1); border:none; color:white; padding:5px; border-radius:5px;" onclick="window.hostForceRoundEnd()" data-i18n="btn_force_end">End Round</button>
            </div>
        </div>
        <div id="score-box">
            <div class="score-row" id="round-indicator" style="display:none; color:#aaa; font-size:0.8rem;">ROUND 1/5</div>
            <div class="score-row"><span data-i18n="lbl_me">YOU</span> <span id="score-me" class="score-val">0</span></div>
            <!-- MP Score List -->
            <div id="mp-scores" style="display:none; flex-direction:column; gap:2px; margin-top:5px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;"></div>
        </div>
    </div>

    <button id="mobile-map-toggle" onclick="window.toggleMap()">üó∫Ô∏è</button>

    <div id="map-container">
        <div id="map"></div>
        <button id="confirm-btn" onclick="window.submitGuess()" data-i18n="btn_guess_tap">Tap map to guess</button>
    </div>

    <div id="result-sheet">
        <div class="result-row">
            <div>
                <div class="big-text" id="res-dist">0 m</div>
                <div style="color:#f1c40f; font-weight:bold; font-size:1.4rem;" id="res-pts">+0 pts</div>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:bold; font-size:1.1rem; color: #ddd;" data-i18n="lbl_location">Location</div>
                <div id="res-loc-name" class="sub-text">City, Country</div>
            </div>
        </div>
        
        <!-- Multi Player Results List -->
        <div id="res-mp-list" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; display:none; max-height:100px; overflow-y:auto;"></div>

        <div class="btn-group">
            <button class="btn-secondary" onclick="window.shareResult()">üì§</button>
            <button class="btn-primary" id="next-btn" onclick="window.nextRound()">
                <span class="btn-content" data-i18n="btn_next">Play Next</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
    </div>

    <!-- SUMMARY MODAL -->
    <div id="summary-modal" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:7000; display:none; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="text-transform:uppercase; letter-spacing:2px;" data-i18n="lbl_game_over">Game Over</h1>
        <div class="summary-score" id="final-score" style="font-size:4rem; font-weight:900; background:var(--primary-grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:20px 0;">0</div>
        <button class="btn-main btn-blue" onclick="window.location.reload()" data-i18n="btn_menu">Menu</button>
    </div>

    <!-- JS MODULES -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // CONFIG & TRANSLATIONS
        const firebaseConfig = {
            apiKey: "AIzaSyDJjo66zCwODJW1J2SoVQ2B8tIH5FPUu1A",
            authDomain: "mytube-cd424.firebaseapp.com",
            databaseURL: "https://mytube-cd424-default-rtdb.firebaseio.com",
            projectId: "mytube-cd424",
            storageBucket: "mytube-cd424.appspot.com",
            messagingSenderId: "865512387483",
            appId: "1:865512387483:web:de8245f509dba9bbd5273e"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const MLY_TOKEN = 'MLY|26213154491618951|523c0418de2d6a8118aefdab3284d6c2';

        const TR = {
            en: {
                app_title: "GeoGuessr", app_subtitle: "Explore the world & challenge friends",
                btn_endless: "‚àû Endless Mode", btn_challenge: "‚è±Ô∏è Challenge Mode", btn_friend: "üë• Party Mode", btn_profile: "üë§ My Profile",
                btn_back: "Back", friend_mode: "Party Mode", lbl_create: "Create Room", lbl_join: "Join Room",
                mode_endless: "Endless", mode_challenge: "Challenge", btn_create_play: "Create & Play", btn_join: "Join Room",
                lbl_share_code: "Share code with friends", lbl_waiting: "Waiting for players...", btn_leave: "Leave", btn_start_game: "Start Game",
                lbl_me: "YOU", btn_force_end: "End Round", btn_guess_tap: "Tap map to guess", btn_guess_confirm: "CONFIRM GUESS", btn_wait: "WAITING...",
                lbl_location: "Location", btn_next: "Play Next", btn_finish: "Finish Game", lbl_game_over: "Game Over", btn_menu: "Main Menu",
                pf_rank: "Explorer", lbl_games: "Games", lbl_score: "Total XP", lbl_history: "History",
                msg_kicked: "You were kicked from the room."
            },
            ru: {
                app_title: "–ì–µ–æ–ì–µ—Å—Å—Ä", app_subtitle: "–ò—Å—Å–ª–µ–¥—É–π –º–∏—Ä –∏ –∏–≥—Ä–∞–π —Å –¥—Ä—É–∑—å—è–º–∏",
                btn_endless: "‚àû –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π", btn_challenge: "‚è±Ô∏è –ù–∞ –≤—Ä–µ–º—è", btn_friend: "üë• –ì—Ä—É–ø–ø–æ–≤–æ–π", btn_profile: "üë§ –ü—Ä–æ—Ñ–∏–ª—å",
                btn_back: "–ù–∞–∑–∞–¥", friend_mode: "–ò–≥—Ä–∞ —Å –¥—Ä—É–∑—å—è–º–∏", lbl_create: "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É", lbl_join: "–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É",
                mode_endless: "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ", mode_challenge: "–ß–µ–ª–ª–µ–Ω–¥–∂", btn_create_play: "–°–æ–∑–¥–∞—Ç—å", btn_join: "–í–æ–π—Ç–∏",
                lbl_share_code: "–û—Ç–ø—Ä–∞–≤—å –∫–æ–¥ –¥—Ä—É–∑—å—è–º", lbl_waiting: "–ñ–¥–µ–º –∏–≥—Ä–æ–∫–æ–≤...", btn_leave: "–í—ã–π—Ç–∏", btn_start_game: "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É",
                lbl_me: "–í–´", btn_force_end: "–ó–∞–≤–µ—Ä—à–∏—Ç—å", btn_guess_tap: "–ù–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç—É", btn_guess_confirm: "–ü–û–î–¢–í–ï–†–î–ò–¢–¨", btn_wait: "–û–ñ–ò–î–ê–ù–ò–ï...",
                lbl_location: "–õ–æ–∫–∞—Ü–∏—è", btn_next: "–î–∞–ª—å—à–µ", btn_finish: "–§–∏–Ω–∏—à", lbl_game_over: "–ö–æ–Ω–µ—Ü –∏–≥—Ä—ã", btn_menu: "–í –º–µ–Ω—é",
                pf_rank: "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å", lbl_games: "–ò–≥—Ä—ã", lbl_score: "–í—Å–µ–≥–æ XP", lbl_history: "–ò—Å—Ç–æ—Ä–∏—è",
                msg_kicked: "–í—ã –±—ã–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –∫–æ–º–Ω–∞—Ç—ã."
            }
        };

        // GLOBAL STATE
        const USER = (window.Telegram?.WebApp?.initDataUnsafe?.user) || { id: 'test_'+Math.floor(Math.random()*1000), first_name: 'Guest', language_code: 'en' };
        
        const STATE = {
            lang: localStorage.getItem('geo_lang') || (USER.language_code === 'ru' ? 'ru' : 'en'),
            mode: 'menu',
            mpRole: null, 
            gameId: null,
            myUid: USER.id.toString(),
            myName: USER.first_name,
            round: 1,
            maxRounds: 5,
            score: 0,
            timer: null,
            timeLeft: 120,
            currentLoc: null,
            isLocked: false,
            mpModeSelected: 'endless',
            players: {}, 
            history: JSON.parse(localStorage.getItem('geo_history') || '[]'),
            totalGames: parseInt(localStorage.getItem('geo_total_games') || '0'),
            totalScore: parseInt(localStorage.getItem('geo_total_score') || '0')
        };

        const LOCATIONS = [
            // --- RUSSIA (Existing + 8 New) ---
            { name: "Saint Petersburg, Russia", flag: "üá∑üá∫", lat: 59.9311, lng: 30.3609 },
            { name: "Moscow, Russia", flag: "üá∑üá∫", lat: 55.7558, lng: 37.6173 },
            { name: "Kazan, Russia", flag: "üá∑üá∫", lat: 55.7963, lng: 49.1088 },
            { name: "Sochi, Russia", flag: "üá∑üá∫", lat: 43.5852, lng: 39.7231 },
            { name: "Novosibirsk, Russia", flag: "üá∑üá∫", lat: 55.0302, lng: 82.9204 },
            { name: "Yekaterinburg, Russia", flag: "üá∑üá∫", lat: 56.8389, lng: 60.6057 },
            { name: "Vladivostok, Russia", flag: "üá∑üá∫", lat: 43.1198, lng: 131.8869 },
            { name: "Nizhny Novgorod, Russia", flag: "üá∑üá∫", lat: 56.2965, lng: 43.9361 },
            { name: "Kaliningrad, Russia", flag: "üá∑üá∫", lat: 54.7104, lng: 20.4522 },

            // --- NORTH AMERICA ---
            { name: "New York, USA", flag: "üá∫üá∏", lat: 40.7128, lng: -74.0060 },
            { name: "Los Angeles, USA", flag: "üá∫üá∏", lat: 34.0522, lng: -118.2437 },
            { name: "Chicago, USA", flag: "üá∫üá∏", lat: 41.8781, lng: -87.6298 },
            { name: "San Francisco, USA", flag: "üá∫üá∏", lat: 37.7749, lng: -122.4194 },
            { name: "Miami, USA", flag: "üá∫üá∏", lat: 25.7617, lng: -80.1918 },
            { name: "Las Vegas, USA", flag: "üá∫üá∏", lat: 36.1699, lng: -115.1398 },
            { name: "Seattle, USA", flag: "üá∫üá∏", lat: 47.6062, lng: -122.3321 },
            { name: "Boston, USA", flag: "üá∫üá∏", lat: 42.3601, lng: -71.0589 },
            { name: "Austin, USA", flag: "üá∫üá∏", lat: 30.2672, lng: -97.7431 },
            { name: "Denver, USA", flag: "üá∫üá∏", lat: 39.7392, lng: -104.9903 },
            { name: "New Orleans, USA", flag: "üá∫üá∏", lat: 29.9511, lng: -90.0715 },
            { name: "Philadelphia, USA", flag: "üá∫üá∏", lat: 39.9526, lng: -75.1652 },
            { name: "San Diego, USA", flag: "üá∫üá∏", lat: 32.7157, lng: -117.1611 },
            { name: "Portland, USA", flag: "üá∫üá∏", lat: 45.5051, lng: -122.6750 },
            { name: "Toronto, Canada", flag: "üá®üá¶", lat: 43.6532, lng: -79.3832 },
            { name: "Vancouver, Canada", flag: "üá®üá¶", lat: 49.2827, lng: -123.1207 },
            { name: "Montreal, Canada", flag: "üá®üá¶", lat: 45.5017, lng: -73.5673 },
            { name: "Calgary, Canada", flag: "üá®üá¶", lat: 51.0447, lng: -114.0719 },
            { name: "Ottawa, Canada", flag: "üá®üá¶", lat: 45.4215, lng: -75.6972 },
            { name: "Mexico City, Mexico", flag: "üá≤üáΩ", lat: 19.4326, lng: -99.1332 },
            { name: "Guadalajara, Mexico", flag: "üá≤üáΩ", lat: 20.6597, lng: -103.3496 },
            { name: "Monterrey, Mexico", flag: "üá≤üáΩ", lat: 25.6866, lng: -100.3161 },

            // --- SOUTH AMERICA ---
            { name: "S√£o Paulo, Brazil", flag: "üáßüá∑", lat: -23.5505, lng: -46.6333 },
            { name: "Rio de Janeiro, Brazil", flag: "üáßüá∑", lat: -22.9068, lng: -43.1729 },
            { name: "Bras√≠lia, Brazil", flag: "üáßüá∑", lat: -15.7975, lng: -47.8919 },
            { name: "Salvador, Brazil", flag: "üáßüá∑", lat: -12.9777, lng: -38.5016 },
            { name: "Buenos Aires, Argentina", flag: "üá¶üá∑", lat: -34.6037, lng: -58.3816 },
            { name: "Mendoza, Argentina", flag: "üá¶üá∑", lat: -32.8895, lng: -68.8458 },
            { name: "Santiago, Chile", flag: "üá®üá±", lat: -33.4489, lng: -70.6693 },
            { name: "Valparaiso, Chile", flag: "üá®üá±", lat: -33.0472, lng: -71.6127 },
            { name: "Bogot√°, Colombia", flag: "üá®üá¥", lat: 4.7110, lng: -74.0721 },
            { name: "Medell√≠n, Colombia", flag: "üá®üá¥", lat: 6.2442, lng: -75.5812 },
            { name: "Lima, Peru", flag: "üáµüá™", lat: -12.0464, lng: -77.0428 },
            { name: "Cusco, Peru", flag: "üáµüá™", lat: -13.5320, lng: -71.9675 },
            { name: "Quito, Ecuador", flag: "üá™üá®", lat: -0.1807, lng: -78.4678 },
            { name: "Montevideo, Uruguay", flag: "üá∫üáæ", lat: -34.9011, lng: -56.1645 },
            { name: "La Paz, Bolivia", flag: "üáßüá¥", lat: -16.5004, lng: -68.1193 },

            // --- EUROPE ---
            { name: "London, UK", flag: "üá¨üáß", lat: 51.5074, lng: -0.1278 },
            { name: "Manchester, UK", flag: "üá¨üáß", lat: 53.4808, lng: -2.2426 },
            { name: "Edinburgh, UK", flag: "üá¨üáß", lat: 55.9533, lng: -3.1883 },
            { name: "Paris, France", flag: "üá´üá∑", lat: 48.8566, lng: 2.3522 },
            { name: "Lyon, France", flag: "üá´üá∑", lat: 45.7640, lng: 4.8357 },
            { name: "Marseille, France", flag: "üá´üá∑", lat: 43.2965, lng: 5.3698 },
            { name: "Nice, France", flag: "üá´üá∑", lat: 43.7102, lng: 7.2620 },
            { name: "Madrid, Spain", flag: "üá™üá∏", lat: 40.4168, lng: -3.7038 },
            { name: "Barcelona, Spain", flag: "üá™üá∏", lat: 41.3851, lng: 2.1734 },
            { name: "Seville, Spain", flag: "üá™üá∏", lat: 37.3891, lng: -5.9845 },
            { name: "Valencia, Spain", flag: "üá™üá∏", lat: 39.4699, lng: -0.3763 },
            { name: "Lisbon, Portugal", flag: "üáµüáπ", lat: 38.7223, lng: -9.1393 },
            { name: "Porto, Portugal", flag: "üáµüáπ", lat: 41.1579, lng: -8.6291 },
            { name: "Berlin, Germany", flag: "üá©üá™", lat: 52.5200, lng: 13.4050 },
            { name: "Munich, Germany", flag: "üá©üá™", lat: 48.1351, lng: 11.5820 },
            { name: "Hamburg, Germany", flag: "üá©üá™", lat: 53.5511, lng: 9.9937 },
            { name: "Frankfurt, Germany", flag: "üá©üá™", lat: 50.1109, lng: 8.6821 },
            { name: "Cologne, Germany", flag: "üá©üá™", lat: 50.9375, lng: 6.9603 },
            { name: "Rome, Italy", flag: "üáÆüáπ", lat: 41.9028, lng: 12.4964 },
            { name: "Milan, Italy", flag: "üáÆüáπ", lat: 45.4642, lng: 9.1900 },
            { name: "Venice, Italy", flag: "üáÆüáπ", lat: 45.4408, lng: 12.3155 },
            { name: "Florence, Italy", flag: "üáÆüáπ", lat: 43.7696, lng: 11.2558 },
            { name: "Naples, Italy", flag: "üáÆüáπ", lat: 40.8518, lng: 14.2681 },
            { name: "Amsterdam, Netherlands", flag: "üá≥üá±", lat: 52.3676, lng: 4.9041 },
            { name: "Rotterdam, Netherlands", flag: "üá≥üá±", lat: 51.9244, lng: 4.4777 },
            { name: "Brussels, Belgium", flag: "üáßüá™", lat: 50.8503, lng: 4.3517 },
            { name: "Vienna, Austria", flag: "üá¶üáπ", lat: 48.2082, lng: 16.3738 },
            { name: "Prague, Czechia", flag: "üá®üáø", lat: 50.0755, lng: 14.4378 },
            { name: "Budapest, Hungary", flag: "üá≠üá∫", lat: 47.4979, lng: 19.0402 },
            { name: "Stockholm, Sweden", flag: "üá∏üá™", lat: 59.3293, lng: 18.0686 },
            { name: "Gothenburg, Sweden", flag: "üá∏üá™", lat: 57.7089, lng: 11.9746 },
            { name: "Oslo, Norway", flag: "üá≥üá¥", lat: 59.9139, lng: 10.7522 },
            { name: "Bergen, Norway", flag: "üá≥üá¥", lat: 60.3913, lng: 5.3221 },
            { name: "Helsinki, Finland", flag: "üá´üáÆ", lat: 60.1699, lng: 24.9384 },
            { name: "Copenhagen, Denmark", flag: "üá©üá∞", lat: 55.6761, lng: 12.5683 },
            { name: "Aarhus, Denmark", flag: "üá©üá∞", lat: 56.1629, lng: 10.2039 },
            { name: "Warsaw, Poland", flag: "üáµüá±", lat: 52.2297, lng: 21.0122 },
            { name: "Krakow, Poland", flag: "üáµüá±", lat: 50.0647, lng: 19.9450 },
            { name: "Gdansk, Poland", flag: "üáµüá±", lat: 54.3520, lng: 18.6466 },
            { name: "Athens, Greece", flag: "üá¨üá∑", lat: 37.9838, lng: 23.7275 },
            { name: "Thessaloniki, Greece", flag: "üá¨üá∑", lat: 40.6401, lng: 22.9444 },
            { name: "Zurich, Switzerland", flag: "üá®üá≠", lat: 47.3769, lng: 8.5417 },
            { name: "Geneva, Switzerland", flag: "üá®üá≠", lat: 46.2044, lng: 6.1432 },
            { name: "Dublin, Ireland", flag: "üáÆüá™", lat: 53.3498, lng: -6.2603 },
            { name: "Zagreb, Croatia", flag: "üá≠üá∑", lat: 45.8150, lng: 15.9819 },
            { name: "Dubrovnik, Croatia", flag: "üá≠üá∑", lat: 42.6507, lng: 18.0944 },
            { name: "Bucharest, Romania", flag: "üá∑üá¥", lat: 44.4268, lng: 26.1025 },
            { name: "Sofia, Bulgaria", flag: "üáßüá¨", lat: 42.6977, lng: 23.3219 },
            { name: "Belgrade, Serbia", flag: "üá∑üá∏", lat: 44.7866, lng: 20.4489 },
            { name: "Tallinn, Estonia", flag: "üá™üá™", lat: 59.4370, lng: 24.7536 },
            { name: "Riga, Latvia", flag: "üá±üáª", lat: 56.9496, lng: 24.1052 },
            { name: "Vilnius, Lithuania", flag: "üá±üáπ", lat: 54.6872, lng: 25.2797 },
            { name: "Reykjavik, Iceland", flag: "üáÆüá∏", lat: 64.1265, lng: -21.8174 },

            // --- ASIA ---
            { name: "Istanbul, Turkey", flag: "üáπüá∑", lat: 41.0082, lng: 28.9784 },
            { name: "Ankara, Turkey", flag: "üáπüá∑", lat: 39.9334, lng: 32.8597 },
            { name: "Antalya, Turkey", flag: "üáπüá∑", lat: 36.8969, lng: 30.7133 },
            { name: "Tokyo, Japan", flag: "üáØüáµ", lat: 35.6762, lng: 139.6503 },
            { name: "Osaka, Japan", flag: "üáØüáµ", lat: 34.6937, lng: 135.5023 },
            { name: "Kyoto, Japan", flag: "üáØüáµ", lat: 35.0116, lng: 135.7681 },
            { name: "Sapporo, Japan", flag: "üáØüáµ", lat: 43.0618, lng: 141.3545 },
            { name: "Fukuoka, Japan", flag: "üáØüáµ", lat: 33.5902, lng: 130.4017 },
            { name: "Seoul, South Korea", flag: "üá∞üá∑", lat: 37.5665, lng: 126.9780 },
            { name: "Busan, South Korea", flag: "üá∞üá∑", lat: 35.1796, lng: 129.0756 },
            { name: "Taipei, Taiwan", flag: "üáπüáº", lat: 25.0330, lng: 121.5654 },
            { name: "Kaohsiung, Taiwan", flag: "üáπüáº", lat: 22.6273, lng: 120.3014 },
            { name: "Bangkok, Thailand", flag: "üáπüá≠", lat: 13.7563, lng: 100.5018 },
            { name: "Chiang Mai, Thailand", flag: "üáπüá≠", lat: 18.7883, lng: 98.9853 },
            { name: "Singapore", flag: "üá∏üá¨", lat: 1.3521, lng: 103.8198 },
            { name: "Kuala Lumpur, Malaysia", flag: "üá≤üáæ", lat: 3.1390, lng: 101.6869 },
            { name: "Jakarta, Indonesia", flag: "üáÆüá©", lat: -6.2088, lng: 106.8456 },
            { name: "Bali (Denpasar), Indonesia", flag: "üáÆüá©", lat: -8.6705, lng: 115.2126 },
            { name: "Manila, Philippines", flag: "üáµüá≠", lat: 14.5995, lng: 120.9842 },
            { name: "Cebu City, Philippines", flag: "üáµüá≠", lat: 10.3157, lng: 123.8854 },
            { name: "Ho Chi Minh City, Vietnam", flag: "üáªüá≥", lat: 10.8231, lng: 106.6297 },
            { name: "Hanoi, Vietnam", flag: "üáªüá≥", lat: 21.0285, lng: 105.8542 },
            { name: "Dubai, UAE", flag: "üá¶üá™", lat: 25.2048, lng: 55.2708 },
            { name: "Abu Dhabi, UAE", flag: "üá¶üá™", lat: 24.4539, lng: 54.3773 },
            { name: "Doha, Qatar", flag: "üá∂üá¶", lat: 25.2854, lng: 51.5310 },
            { name: "Tel Aviv, Israel", flag: "üáÆüá±", lat: 32.0853, lng: 34.7818 },
            { name: "Jerusalem, Israel", flag: "üáÆüá±", lat: 31.7683, lng: 35.2137 },
            { name: "Mumbai, India", flag: "üáÆüá≥", lat: 19.0760, lng: 72.8777 },
            { name: "New Delhi, India", flag: "üáÆüá≥", lat: 28.6139, lng: 77.2090 },
            { name: "Bangalore, India", flag: "üáÆüá≥", lat: 12.9716, lng: 77.5946 },
            { name: "Colombo, Sri Lanka", flag: "üá±üá∞", lat: 6.9271, lng: 79.8612 },
            { name: "Ulaanbaatar, Mongolia", flag: "üá≤üá≥", lat: 47.9181, lng: 106.9176 },

            // --- AFRICA ---
            { name: "Cape Town, South Africa", flag: "üáøüá¶", lat: -33.9249, lng: 18.4241 },
            { name: "Johannesburg, South Africa", flag: "üáøüá¶", lat: -26.2041, lng: 28.0473 },
            { name: "Durban, South Africa", flag: "üáøüá¶", lat: -29.8587, lng: 31.0218 },
            { name: "Nairobi, Kenya", flag: "üá∞üá™", lat: -1.2921, lng: 36.8219 },
            { name: "Tunis, Tunisia", flag: "üáπüá≥", lat: 36.8065, lng: 10.1815 },
            { name: "Cairo, Egypt", flag: "üá™üá¨", lat: 30.0444, lng: 31.2357 },
            { name: "Marrakech, Morocco", flag: "üá≤üá¶", lat: 31.6295, lng: -7.9811 },
            { name: "Casablanca, Morocco", flag: "üá≤üá¶", lat: 33.5731, lng: -7.5898 },
            { name: "Dakar, Senegal", flag: "üá∏üá≥", lat: 14.7167, lng: -17.4677 },
            { name: "Accra, Ghana", flag: "üá¨üá≠", lat: 5.6037, lng: -0.1870 },
            { name: "Lagos, Nigeria", flag: "üá≥üá¨", lat: 6.5244, lng: 3.3792 },

            // --- OCEANIA ---
            { name: "Sydney, Australia", flag: "üá¶üá∫", lat: -33.8688, lng: 151.2093 },
            { name: "Melbourne, Australia", flag: "üá¶üá∫", lat: -37.8136, lng: 144.9631 },
            { name: "Brisbane, Australia", flag: "üá¶üá∫", lat: -27.4698, lng: 153.0251 },
            { name: "Perth, Australia", flag: "üá¶üá∫", lat: -31.9505, lng: 115.8605 },
            { name: "Adelaide, Australia", flag: "üá¶üá∫", lat: -34.9285, lng: 138.6007 },
            { name: "Hobart, Australia", flag: "üá¶üá∫", lat: -42.8821, lng: 147.3272 },
            { name: "Auckland, New Zealand", flag: "üá≥üáø", lat: -36.8485, lng: 174.7633 },
            { name: "Wellington, New Zealand", flag: "üá≥üáø", lat: -41.2865, lng: 174.7762 },
            { name: "Christchurch, New Zealand", flag: "üá≥üáø", lat: -43.5321, lng: 172.6362 }
        ];

        let map, mly, guessMarker, resultLine, resultMarker, oppMarkers = [];

        function init() {
            map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬©CARTO' }).addTo(map);

            const { Viewer } = mapillary;
            mly = new Viewer({ accessToken: MLY_TOKEN, container: 'mly', component: { cover: false, sequence: false } });

            map.on('click', (e) => {
                if(STATE.isLocked) return;
                if(guessMarker) map.removeLayer(guessMarker);
                guessMarker = L.marker(e.latlng).addTo(map);
                
                const btn = document.getElementById('confirm-btn');
                btn.classList.add('active');
                btn.innerText = t('btn_guess_confirm');
                btn.disabled = false;
                if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.selectionChanged();
            });

            applyTranslations();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function t(key) { return TR[STATE.lang][key] || key; }
        
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.innerText = t(el.getAttribute('data-i18n'));
            });
            document.getElementById('settings-btn').innerText = STATE.lang === 'en' ? 'üá∫üá∏' : 'üá∑üá∫';
        }

        window.toggleLanguage = () => {
            STATE.lang = STATE.lang === 'en' ? 'ru' : 'en';
            localStorage.setItem('geo_lang', STATE.lang);
            applyTranslations();
        };

        window.showMainMenu = () => {
            document.body.classList.remove('game-active');
            document.querySelectorAll('.full-screen-menu').forEach(el => el.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
        };

        window.openFriendMenu = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('friend-menu').classList.remove('hidden');
        };

        window.selectMpMode = (mode) => {
            STATE.mpModeSelected = mode;
            document.getElementById('mp-mode-endless').classList.toggle('selected', mode === 'endless');
            document.getElementById('mp-mode-challenge').classList.toggle('selected', mode === 'challenge');
        };

        // --- PROFILE LOGIC ---
        window.openProfile = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('profile-screen').classList.remove('hidden');
            
            document.getElementById('pf-name').innerText = STATE.myName;
            document.getElementById('pf-total-games').innerText = STATE.totalGames;
            document.getElementById('pf-total-score').innerText = STATE.totalScore;
            
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            [...STATE.history].reverse().slice(0, 30).forEach(h => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<div>${h.date}</div><div class="h-score">+${h.pts}</div>`;
                list.appendChild(div);
            });
        };

        window.closeProfile = () => window.showMainMenu();

        function updateLocalStats(pts) {
            // Save TOTAL SCORE immediately on every round
            STATE.totalScore += pts;
            localStorage.setItem('geo_total_score', STATE.totalScore.toString());
        }

        function saveGameToHistory(pts) {
            // Only add a "History Item" when a game fully ends, or just track accumulated score
            STATE.totalGames++;
            localStorage.setItem('geo_total_games', STATE.totalGames.toString());
            
            const entry = { date: new Date().toLocaleDateString(), pts: pts };
            STATE.history.push(entry);
            localStorage.setItem('geo_history', JSON.stringify(STATE.history));
        }

        // --- GAME LOGIC ---
        window.startEndless = () => {
            document.body.classList.add('game-active');
            STATE.mode = 'endless'; STATE.score = 0;
            updateHUD(); startGameLoop();
        };

        window.startChallenge = () => {
            document.body.classList.add('game-active');
            STATE.mode = 'challenge'; STATE.round = 1; STATE.score = 0; STATE.maxRounds = 5;
            updateHUD(); startGameLoop();
        };

        function updateHUD() {
            document.querySelectorAll('.full-screen-menu').forEach(el => el.classList.add('hidden'));
            document.getElementById('score-me').innerText = STATE.score;
            document.getElementById('mp-scores').style.display = 'none';
            document.getElementById('host-controls').style.display = 'none';

            if (STATE.mode === 'challenge' || (STATE.mode === 'multi' && STATE.mpModeSelected === 'challenge')) {
                document.getElementById('round-indicator').style.display = 'flex';
                document.getElementById('round-indicator').innerText = `ROUND ${STATE.round}/${STATE.maxRounds}`;
                document.getElementById('timer-box').style.display = 'block';
            } else {
                document.getElementById('round-indicator').style.display = 'none';
                document.getElementById('timer-box').style.display = 'none';
            }
        }

        async function pickRandomLocation() {
            if(LOCATIONS.length < 1) return { id: '5177821635678829', lat: 48.8566, lng: 2.3522, city: { name: "Paris", flag: "üá´üá∑"} };
            const city = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
            const range = 0.04;
            const rLat = city.lat + (Math.random() * range * 2 - range);
            const rLng = city.lng + (Math.random() * range * 2 - range);
            const bbox = `${rLng-0.005},${rLat-0.005},${rLng+0.005},${rLat+0.005}`;
            try {
                const res = await fetch(`https://graph.mapillary.com/images?access_token=${MLY_TOKEN}&fields=id,geometry&bbox=${bbox}&limit=1`);
                const data = await res.json();
                if(data.data && data.data.length > 0) {
                    return { id: data.data[0].id, lat: data.data[0].geometry.coordinates[1], lng: data.data[0].geometry.coordinates[0], city: city };
                } else return pickRandomLocation(); 
            } catch(e) { return pickRandomLocation(); }
        }

        function startGameLoop() {
            resetMapUI();
            if (STATE.mode !== 'multi') {
                document.getElementById('loading').classList.remove('hidden');
                pickRandomLocation().then(loc => {
                    STATE.currentLoc = loc;
                    loadLocation(loc);
                    if(STATE.mode === 'challenge') startTimer(120);
                });
            } else {
                document.getElementById('confirm-btn').innerText = t('btn_wait');
            }
        }

        function loadLocation(loc) {
            mly.moveTo(loc.id)
                .then(() => document.getElementById('loading').classList.add('hidden'))
                .catch(() => pickRandomLocation().then(l => loadLocation(l)));
        }

        function resetMapUI() {
            STATE.isLocked = false;
            document.getElementById('result-sheet').classList.remove('show');
            document.getElementById('map-container').classList.remove('map-result-mode', 'open');
            document.getElementById('mobile-map-toggle').style.display = 'flex';
            document.getElementById('res-mp-list').style.display = 'none';

            if(guessMarker) map.removeLayer(guessMarker);
            if(resultLine) map.removeLayer(resultLine);
            if(resultMarker) map.removeLayer(resultMarker);
            oppMarkers.forEach(m => map.removeLayer(m));
            oppMarkers = [];
            
            guessMarker = null; 
            map.setView([20,0], 2);
            
            const btn = document.getElementById('confirm-btn');
            btn.classList.remove('active');
            btn.innerText = t('btn_guess_tap');
            btn.disabled = true;
            
            const nextBtn = document.getElementById('next-btn');
            nextBtn.classList.remove('loading');
            nextBtn.disabled = false;
        }

        function startTimer(seconds) {
            clearInterval(STATE.timer);
            STATE.timeLeft = seconds;
            updateTimerDisplay();
            STATE.timer = setInterval(() => {
                STATE.timeLeft--;
                updateTimerDisplay();
                if(STATE.timeLeft <= 0) {
                    clearInterval(STATE.timer);
                    if(!STATE.isLocked) window.submitGuess(true); 
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const min = Math.floor(STATE.timeLeft / 60);
            const sec = STATE.timeLeft % 60;
            const el = document.getElementById('timer-box');
            el.innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;
            if(STATE.timeLeft < 10) el.classList.add('warning'); else el.classList.remove('warning');
        }

        // --- MULTIPLAYER ---
        window.createRoom = () => {
            const btn = document.getElementById('btn-create');
            btn.classList.add('loading');
            const code = Math.floor(10000 + Math.random() * 90000).toString();
            STATE.gameId = code;
            STATE.mpRole = 'host';
            STATE.mode = 'multi';
            
            const initialData = {
                status: 'waiting',
                mode: STATE.mpModeSelected,
                round: 1,
                host: STATE.myUid,
                players: { [STATE.myUid]: { name: STATE.myName, score: 0, avatar: 'üëë' } }
            };

            set(ref(db, 'games/' + code), initialData).then(() => {
                btn.classList.remove('loading');
                enterLobby(code);
            });
        };

        window.joinRoom = () => {
            const code = document.getElementById('join-code').value;
            if(code.length !== 5) return;
            const btn = document.getElementById('btn-join');
            btn.classList.add('loading');

            get(ref(db, 'games/' + code)).then((snap) => {
                btn.classList.remove('loading');
                if(snap.exists()) {
                    STATE.gameId = code;
                    STATE.mpRole = 'guest';
                    STATE.mode = 'multi';
                    update(ref(db, `games/${code}/players/${STATE.myUid}`), {
                        name: STATE.myName, score: 0, avatar: 'üë§'
                    });
                    enterLobby(code);
                } else {
                    alert("Room not found");
                }
            });
        };

        function enterLobby(code) {
            document.getElementById('friend-menu').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('lobby-code-display').innerText = code;
            if(STATE.mpRole === 'host') document.getElementById('host-actions').classList.remove('hidden');
            listenToLobby(code);
        }

        window.hostStartGame = () => {
            update(ref(db, `games/${STATE.gameId}`), { status: 'starting' });
        };
        
        window.leaveLobby = () => {
            remove(ref(db, `games/${STATE.gameId}/players/${STATE.myUid}`));
            window.location.reload();
        };
        
        window.hostKick = (uid) => {
             remove(ref(db, `games/${STATE.gameId}/players/${uid}`));
        };

        function listenToLobby(code) {
            onValue(ref(db, 'games/' + code), (snap) => {
                const data = snap.val();
                if(!data) { alert("Room closed"); window.location.reload(); return; }
                if(!data.players || !data.players[STATE.myUid]) {
                    alert(t('msg_kicked')); window.location.reload(); return;
                }
                STATE.players = data.players;
                renderPlayerList(data.players, data.host);

                if(data.status === 'starting' || data.status === 'playing') {
                    document.getElementById('lobby-screen').classList.add('hidden');
                    document.body.classList.add('game-active');
                    if(STATE.mpRole === 'host' && data.status === 'starting') {
                        update(ref(db, `games/${code}`), { status: 'playing' });
                        document.getElementById('loading').classList.remove('hidden');
                        pickRandomLocation().then(loc => {
                            update(ref(db, `games/${code}`), { location: loc });
                        });
                    }
                    listenToGame(code);
                }
            });
        }

        function renderPlayerList(players, hostId) {
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            Object.keys(players).forEach(uid => {
                const p = players[uid];
                const div = document.createElement('div');
                div.className = 'player-item';
                let html = `<div class="player-info"><div class="player-avatar">${p.avatar}</div> <span>${p.name}</span></div>`;
                if(STATE.mpRole === 'host' && uid !== STATE.myUid) {
                    html += `<button class="kick-btn" onclick="window.hostKick('${uid}')">√ó</button>`;
                }
                div.innerHTML = html;
                list.appendChild(div);
            });
        }

        function listenToGame(code) {
            document.getElementById('mp-scores').style.display = 'flex';
            if(STATE.mpRole === 'host') document.getElementById('host-controls').style.display = 'flex';

            onValue(ref(db, 'games/' + code), (snap) => {
                const data = snap.val();
                if(!data) return;

                // Sync Loading Screen (Guest side)
                if(data.status === 'next_round') {
                    document.getElementById('loading').classList.remove('hidden');
                    document.getElementById('result-sheet').classList.remove('show');
                }

                renderMpScores(data.players);

                if(data.location && (!STATE.currentLoc || STATE.currentLoc.id !== data.location.id)) {
                    STATE.currentLoc = data.location;
                    STATE.round = data.round;
                    STATE.resultShown = false; 
                    
                    updateHUD();
                    loadLocation(data.location);
                    resetMapUI();
                    if(data.mode === 'challenge') startTimer(120);
                }

                if(data.forceEndRound && !STATE.isLocked && !STATE.resultShown) {
                     window.submitGuess(true);
                }

                const playerIds = Object.keys(data.players);
                const guesses = data.guesses || {};
                const allGuessed = playerIds.every(uid => guesses[uid]);
                
                if( (allGuessed || data.status === 'results') && !STATE.resultShown ) {
                    STATE.resultShown = true;
                    clearInterval(STATE.timer);
                    showMpResult(guesses, data.location);
                }
            });
        }

        function renderMpScores(players) {
            const container = document.getElementById('mp-scores');
            container.innerHTML = '';
            Object.values(players).sort((a,b) => b.score - a.score).forEach(p => {
                const div = document.createElement('div');
                div.style.cssText = "display:flex; justify-content:space-between; font-size:0.8rem; color:#ddd;";
                div.innerHTML = `<span>${p.name}</span> <span style="color:#f1c40f">${p.score}</span>`;
                container.appendChild(div);
            });
        }
        
        window.hostForceRoundEnd = () => {
            update(ref(db, `games/${STATE.gameId}`), { status: 'results' });
        };

        // --- SUBMIT ---
        window.submitGuess = (force = false) => {
            if((!guessMarker && !force) || STATE.isLocked) return;
            
            clearInterval(STATE.timer);
            STATE.isLocked = true;
            
            const uLat = guessMarker ? guessMarker.getLatLng() : L.latLng(0,0);
            const aLat = L.latLng(STATE.currentLoc.lat, STATE.currentLoc.lng);
            const dist = map.distance(uLat, aLat);
            const pts = (force && !guessMarker) ? 0 : Math.round(5000 * Math.exp(-dist / 120000)); 

            if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            // --- IMPORTANT: SAVE POINTS TO PROFILE IMMEDIATELY ---
            updateLocalStats(pts);

            if(STATE.mode === 'multi') {
                document.getElementById('confirm-btn').innerText = t('btn_wait');
                update(ref(db, `games/${STATE.gameId}/guesses/${STATE.myUid}`), {
                    lat: uLat.lat, lng: uLat.lng, pts: pts, name: STATE.myName
                });
                return;
            }

            STATE.score += pts;
            showSingleResult(uLat, aLat, dist, pts);
        };

        function showSingleResult(uLat, aLat, dist, pts) {
            setupResultMap(uLat, aLat);
            document.getElementById('res-dist').innerText = formatDist(dist);
            document.getElementById('res-pts').innerText = "+" + pts + " pts";
            document.getElementById('res-loc-name').innerHTML = STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag;
            
            const nextBtn = document.getElementById('next-btn');
            const nextBtnText = nextBtn.querySelector('.btn-content');
            
            if (STATE.mode === 'challenge' && STATE.round >= STATE.maxRounds) {
                nextBtnText.innerText = t('btn_finish');
                nextBtn.onclick = showSummary;
                saveGameToHistory(STATE.score); // Save to history list only at end
            } else {
                nextBtnText.innerText = t('btn_next');
                nextBtn.onclick = window.nextRound;
            }
            document.getElementById('result-sheet').classList.add('show');
        }

        function showMpResult(guesses, locData) {
            const actual = L.latLng(locData.lat, locData.lng);
            const myGuess = guesses[STATE.myUid];
            
            setupResultMap(myGuess ? L.latLng(myGuess.lat, myGuess.lng) : actual, actual);
            
            Object.keys(guesses).forEach(uid => {
                if(uid === STATE.myUid) return;
                const g = guesses[uid];
                const gLat = L.latLng(g.lat, g.lng);
                const m = L.circleMarker(gLat, { radius:5, color:'#ff4b2b', fillColor:'#ff4b2b', fillOpacity:1 }).addTo(map);
                const l = L.polyline([gLat, actual], { color: '#ff4b2b', weight: 1, dashArray:'4,4' }).addTo(map);
                oppMarkers.push(m, l);
            });

            const pts = myGuess ? myGuess.pts : 0;
            const dist = myGuess ? map.distance(L.latLng(myGuess.lat, myGuess.lng), actual) : 0;
            
            document.getElementById('res-dist').innerText = myGuess ? formatDist(dist) : "Did not guess";
            document.getElementById('res-pts').innerText = "+" + pts + " pts";
            document.getElementById('res-loc-name').innerHTML = STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag;

            const list = document.getElementById('res-mp-list');
            list.style.display = 'block';
            list.innerHTML = '';
            Object.values(guesses).sort((a,b)=>b.pts - a.pts).forEach(g => {
                const r = document.createElement('div');
                r.style.cssText = "display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:4px;";
                r.innerHTML = `<span>${g.name}</span> <span style="color:#f1c40f">+${g.pts}</span>`;
                list.appendChild(r);
            });

            const nextBtn = document.getElementById('next-btn');
            const nextBtnText = nextBtn.querySelector('.btn-content');
            
            if (STATE.mpModeSelected === 'challenge' && STATE.round >= STATE.maxRounds) {
                nextBtnText.innerText = t('btn_finish');
                nextBtn.onclick = showSummary;
                saveGameToHistory(STATE.score); 
            } else {
                nextBtnText.innerText = (STATE.mpRole === 'host') ? t('btn_next') : t('btn_wait');
                nextBtn.disabled = (STATE.mpRole !== 'host');
                nextBtn.onclick = (STATE.mpRole === 'host') ? window.nextRound : null;
                
                if(STATE.mpRole === 'host') {
                    get(ref(db, `games/${STATE.gameId}/players`)).then(snap => {
                        const p = snap.val();
                        Object.keys(guesses).forEach(uid => { if(p[uid]) p[uid].score += guesses[uid].pts; });
                        update(ref(db, `games/${STATE.gameId}/players`), p);
                    });
                }
            }
            document.getElementById('result-sheet').classList.add('show');
        }

        function setupResultMap(uLat, aLat) {
            document.getElementById('mobile-map-toggle').style.display = 'none';
            document.getElementById('map-container').classList.add('map-result-mode', 'open');
            setTimeout(() => map.invalidateSize(), 200);

            resultMarker = L.circleMarker(aLat, { radius: 8, color: '#fff', fillColor: '#00ff00', fillOpacity: 1 }).addTo(map);
            resultLine = L.polyline([uLat, aLat], { color: '#00C6FF', weight: 4 }).addTo(map);
            
            const group = new L.featureGroup([L.marker(uLat), resultMarker]);
            map.fitBounds(group.getBounds(), { padding: [50, 50], maxZoom: 16 });
        }

        window.nextRound = () => {
            const btn = document.getElementById('next-btn');
            btn.classList.add('loading');
            
            if(STATE.mode === 'endless' || STATE.mode === 'challenge') {
                if(STATE.mode === 'challenge') STATE.round++;
                startGameLoop();
            } else if (STATE.mode === 'multi' && STATE.mpRole === 'host') {
                const nextR = STATE.round + 1;
                // Sets status to 'next_round' so everyone shows loading screen immediately
                update(ref(db, `games/${STATE.gameId}`), {
                    status: 'next_round',
                    round: nextR,
                    guesses: null,
                    forceEndRound: null
                }).then(() => {
                    // Then start fetching new location
                    pickRandomLocation().then(loc => {
                        update(ref(db, `games/${STATE.gameId}`), { location: loc, status: 'playing' });
                    });
                });
            }
        };

        function showSummary() {
            document.getElementById('summary-modal').style.display = 'flex';
            document.getElementById('final-score').innerText = STATE.score;
            confetti({ particleCount: 200, spread: 100 });
        }

        window.toggleMap = () => {
            const c = document.getElementById('map-container');
            const b = document.getElementById('mobile-map-toggle');
            if(c.classList.contains('open')) { c.classList.remove('open'); b.innerText = "üó∫Ô∏è"; } 
            else { c.classList.add('open'); b.innerText = "‚úñ"; setTimeout(() => map.invalidateSize(), 300); }
        };

        function formatDist(m) { return m < 1000 ? Math.round(m) + " m" : (m/1000).toFixed(1) + " km"; }

        window.shareResult = () => {
            const text = `GeoGuessr: I scored ${STATE.score} pts!`;
            const url = `https://t.me/share/url?url=${encodeURIComponent("t.me/geogur_bot/app")}&text=${encodeURIComponent(text)}`;
            if(window.Telegram?.WebApp) window.Telegram.WebApp.openTelegramLink(url);
            else window.open(url, '_blank');
        };

        init();
    </script>
</body>
</html>
