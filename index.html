<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoGuessr</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Init & Fullscreen
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            try {
                window.Telegram.WebApp.requestFullscreen(); 
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.disableVerticalSwipes();
            } catch (e) { console.log("Telegram FS failed", e); }
        }
    </script>

    <!-- Libs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* ==================== THEME & VARS ==================== */
        :root {
            --bg-color: #0f0f12;
            --text-color: #ffffff;
            --primary-grad: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%);
            --red-grad: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            --glass-bg: rgba(30, 30, 40, 0.85); /* Made slightly darker for visibility */
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --blur: 25px;
            
            /* SAFE AREA FOR TOP ELEMENTS */
            --safe-top: 80px; 
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            overflow: hidden; -webkit-tap-highlight-color: transparent;
        }

        /* UTILS */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border); border-radius: 20px;
            box-shadow: var(--glass-shadow);
        }
        .hidden { display: none !important; }
        .scrollable { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        /* ==================== GLOBAL UI ELEMENTS ==================== */
        /* LANGUAGE BUTTON */
        #settings-btn {
            position: absolute; 
            top: var(--safe-top); /* RESTORED 80px */
            right: 20px; 
            z-index: 6000;
            width: 42px; height: 42px; 
            background: var(--glass-bg);
            border-radius: 50%; 
            display: flex; justify-content: center; align-items: center;
            border: 1px solid rgba(255,255,255,0.2); 
            cursor: pointer; font-size: 22px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* ==================== LAYERS ==================== */
        #mly { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        .mapillary-sequence-controls, .mapillary-direction-arrows { display: none; }

        /* ==================== MENUS ==================== */
        .full-screen-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a2e 0%, #050505 100%);
            z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            transition: opacity 0.3s ease;
        }

        .menu-title { 
            font-size: 3.5rem; font-weight: 800; margin-bottom: 10px; 
            background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-align: center; letter-spacing: -1px; filter: drop-shadow(0 0 20px rgba(0, 198, 255, 0.3));
        }
        .menu-subtitle { font-size: 1.1rem; color: #a0a0a0; margin-bottom: 40px; text-align: center; }

        .btn-main {
            width: 100%; max-width: 320px; padding: 18px; margin: 8px 0;
            border: none; border-radius: 18px; font-size: 1.1rem; font-weight: 600;
            cursor: pointer; color: white; text-transform: uppercase; letter-spacing: 1px;
            position: relative; display: flex; align-items: center; justify-content: center; gap: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); background-size: 200% auto;
        }
        .btn-main:active { transform: scale(0.97); }
        .btn-spinner {
            width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white; border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none;
        }
        .btn-main.loading .btn-content { display: none; }
        .btn-main.loading .btn-spinner { display: block; }

        .btn-blue { background: var(--primary-grad); }
        .btn-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .btn-red { background: var(--red-grad); }
        .btn-dark { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }

        .input-code {
            padding: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            color: white; font-size: 24px; width: 80%; text-align: center; margin: 20px 0;
            letter-spacing: 5px; font-weight: bold; text-transform: uppercase; outline: none;
        }

        /* ==================== LOBBY ==================== */
        #player-list {
            width: 100%; max-width: 350px; max-height: 200px;
            margin: 20px 0; overflow-y: auto;
        }
        .player-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: rgba(255,255,255,0.05);
            margin-bottom: 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
        }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-avatar { 
            width: 32px; height: 32px; border-radius: 50%; background: #555; 
            display:flex; justify-content:center; align-items:center; font-size:14px;
        }
        .kick-btn {
            background: none; border: none; color: #ff4b2b; font-weight: bold; font-size: 18px; cursor: pointer;
        }

        /* ==================== PROFILE ==================== */
        #profile-screen {
            background: rgba(10, 10, 15, 0.95); z-index: 6000;
        }
        .profile-header {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;
        }
        .big-avatar {
            width: 80px; height: 80px; border-radius: 50%; background: var(--primary-grad);
            display: flex; justify-content: center; align-items: center; font-size: 35px;
            margin-bottom: 15px; box-shadow: 0 0 20px rgba(0,198,255,0.3);
        }
        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 350px; margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center;
        }
        .stat-val { font-size: 1.5rem; font-weight: 800; color: #fff; }
        .stat-label { font-size: 0.8rem; color: #aaa; text-transform: uppercase; }

        .history-list { width: 100%; max-width: 350px; }
        .history-item {
            background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .h-score { color: #f1c40f; font-weight: bold; }

        /* ==================== HUD (Restored 80px Top) ==================== */
        #top-hud {
            position: absolute; 
            top: var(--safe-top); /* RESTORED 80px */
            left: 0; width: 100%;
            padding: 0 15px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 100; pointer-events: none;
        }
        
        #timer-box, #host-controls, #score-box {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 16px;
            padding: 10px 15px; color: white; margin-bottom: 5px;
            pointer-events: all;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #timer-box { font-size: 1.4rem; font-weight: 700; }
        #timer-box.warning { border-color: #ff4b2b; color: #ff4b2b; animation: pulse 1s infinite; }
        
        #host-controls { display: none; flex-direction: column; gap: 5px; }
        .mini-btn {
            background: rgba(255,255,255,0.1); border: none; color: white; 
            padding: 5px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;
        }
        #score-box { text-align: right; }
        .score-row { margin-bottom: 2px; }
        .score-val { color: #f1c40f; font-size: 1.1rem; font-weight: 800; font-family: monospace;}

        /* ==================== MAP & RESULTS ==================== */
        #mobile-map-toggle {
            position: absolute; bottom: 30px; right: 20px;
            width: 65px; height: 65px; border-radius: 50%;
            background: var(--primary-grad); color: white;
            font-size: 28px; border: 2px solid rgba(255,255,255,0.2);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #map-container {
            position: absolute; bottom: 110px; right: 20px;
            width: 90vw; max-width: 450px; height: 45vh;
            background: rgba(30, 30, 35, 0.8); backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 200;
            transform: scale(0); opacity: 0; pointer-events: none;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column; padding: 6px; box-sizing: border-box;
        }
        #map-container.open { transform: scale(1); opacity: 1; pointer-events: all; }
        
        /* Map Result Mode: Fixed to be behind the sheet but visible */
        #map-container.map-result-mode {
            bottom: 0 !important; right: 0 !important; width: 100% !important; height: 100% !important;
            border-radius: 0 !important; background: #1a1a1a; padding: 0; max-width: none;
            z-index: 10; /* Lower z-index so sheet is on top */
        }
        
        #map { flex-grow: 1; width: 100%; border-radius: 18px; }

        /* The CONFIRM button (Waiting...) */
        #confirm-btn {
            width: 100%; padding: 16px; margin-top: 6px;
            background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.4);
            font-weight: 800; border: none; text-transform: uppercase;
            border-radius: 14px; cursor: not-allowed; transition: 0.3s;
        }
        #confirm-btn.active { background: var(--primary-grad); color: white; cursor: pointer; }

        /* RESULT SHEET (The Next/Share buttons live here) */
        #result-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 15, 22, 0.95); 
            backdrop-filter: blur(30px);
            border-top: 1px solid rgba(255,255,255,0.2);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            z-index: 3000; /* Must be higher than map-result-mode */
            transform: translateY(110%); 
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 30px 25px 50px 25px; /* Extra bottom padding for safe area */
            box-sizing: border-box;
            display: flex; flex-direction: column; gap: 20px; color: white;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }
        #result-sheet.show { transform: translateY(0); }

        .result-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .big-text { font-size: 2.2rem; font-weight: 900; line-height: 1; margin-bottom: 5px; }
        .sub-text { color: #aaa; font-size: 1rem; }

        .btn-group { display: flex; gap: 15px; margin-top: 10px; }
        .btn-primary {
            background: var(--primary-grad); color: white; padding: 18px;
            border: none; border-radius: 16px; font-size: 16px; font-weight: bold; flex: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1); color: white; padding: 16px;
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; 
            font-size: 22px; width: 70px; cursor: pointer;
        }

        /* Toggle Group */
        .toggle-group { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; }
        .toggle-btn {
            flex: 1; padding: 15px; border-radius: 14px; 
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); 
            color: #aaa; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .toggle-btn.selected { background: var(--primary-grad); color: white; border-color: transparent; }

        /* Loading */
        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0f12; z-index: 8000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <!-- SETTINGS / LANG TOGGLE -->
    <button id="settings-btn" onclick="window.toggleLanguage()">üåê</button>

    <!-- LOADING -->
    <div id="loading">
        <div class="spinner" style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #00C6FF; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
        <h3 id="load-text" style="color: #666; margin-top:20px;">Loading...</h3>
    </div>

    <!-- MAIN MENU -->
    <div id="main-menu" class="full-screen-menu hidden">
        <div class="menu-title" data-i18n="app_title">GeoGuessr</div>
        <div class="menu-subtitle" data-i18n="app_subtitle">Explore the world & challenge friends</div>

        <button class="btn-main btn-blue" onclick="window.startEndless()">
            <span class="btn-content" data-i18n="btn_endless">‚àû Endless Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-purple" onclick="window.startChallenge()">
            <span class="btn-content" data-i18n="btn_challenge">‚è±Ô∏è Challenge Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-green" onclick="window.openFriendMenu()">
            <span class="btn-content" data-i18n="btn_friend">üë• Party Mode</span>
            <div class="btn-spinner"></div>
        </button>
        <button class="btn-main btn-dark" onclick="window.openProfile()">
            <span class="btn-content" data-i18n="btn_profile">üë§ My Profile</span>
        </button>
    </div>

    <!-- PROFILE SCREEN -->
    <div id="profile-screen" class="full-screen-menu hidden scrollable">
        <div class="profile-header">
            <div class="big-avatar" id="pf-avatar">üë§</div>
            <h2 id="pf-name">User</h2>
            <div style="color: #aaa;" data-i18n="pf_rank">Novice Explorer</div>
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-val" id="pf-total-games">0</div>
                <div class="stat-label" data-i18n="lbl_games">Games</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="pf-total-score">0</div>
                <div class="stat-label" data-i18n="lbl_score">Total XP</div>
            </div>
        </div>

        <h3 style="align-self: flex-start; margin-left: 20px;" data-i18n="lbl_history">History</h3>
        <div id="history-list" class="history-list">
            <!-- Items injected here -->
        </div>

        <button class="btn-main btn-dark" style="margin-top: 30px;" onclick="window.closeProfile()" data-i18n="btn_back">Back</button>
    </div>

    <!-- FRIEND MENU -->
    <div id="friend-menu" class="full-screen-menu hidden">
        <h2 style="margin-bottom: 20px;" data-i18n="friend_mode">Party Mode</h2>
        
        <div class="glass-panel" style="padding:25px; width:100%; max-width:350px; margin-bottom:20px;">
            <h4 style="margin:0 0 15px 0; color:#ccc; font-size:0.8rem; text-transform:uppercase;" data-i18n="lbl_create">Create Room</h4>
            <div class="toggle-group">
                <button id="mp-mode-endless" class="toggle-btn selected" onclick="window.selectMpMode('endless')" data-i18n="mode_endless">Endless</button>
                <button id="mp-mode-challenge" class="toggle-btn" onclick="window.selectMpMode('challenge')" data-i18n="mode_challenge">Challenge</button>
            </div>
            <button id="btn-create" class="btn-main btn-green" style="width:100%; margin:0;" onclick="window.createRoom()">
                <span class="btn-content" data-i18n="btn_create_play">Create & Play</span>
                <div class="btn-spinner"></div>
            </button>
        </div>

        <div style="color:#555; font-weight:bold; margin-bottom: 20px;">‚Äî OR ‚Äî</div>

        <div class="glass-panel" style="padding:25px; width:100%; max-width:350px; text-align:center;">
            <h4 style="margin:0 0 15px 0; color:#ccc; font-size:0.8rem; text-transform:uppercase;" data-i18n="lbl_join">Join Room</h4>
            <input type="text" id="join-code" class="input-code" placeholder="CODE" maxlength="5">
            <button id="btn-join" class="btn-main btn-blue" style="width:100%; margin:0;" onclick="window.joinRoom()">
                <span class="btn-content" data-i18n="btn_join">Join Room</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
        <button class="btn-main btn-dark" style="width:auto; padding: 10px 30px; margin-top: 20px;" onclick="window.showMainMenu()" data-i18n="btn_back">Back</button>
    </div>

    <!-- LOBBY -->
    <div id="lobby-screen" class="full-screen-menu hidden">
        <h1 id="lobby-code-display" style="font-size:3.5rem; background: var(--primary-grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:5px; margin:0;">----</h1>
        <p style="color:#888;" data-i18n="lbl_share_code">Share code with friends</p>
        
        <div id="player-list"></div>

        <div id="host-actions" class="hidden" style="width:100%; max-width:320px;">
            <button class="btn-main btn-green" onclick="window.hostStartGame()" data-i18n="btn_start_game">Start Game</button>
        </div>
        
        <div id="lobby-status" style="margin-top:20px; color:#aaa;" data-i18n="lbl_waiting">Waiting for players...</div>
        <button class="btn-main btn-red" style="width:auto; margin-top: 30px;" onclick="window.leaveLobby()" data-i18n="btn_leave">Leave</button>
    </div>

    <!-- GAME UI -->
    <div id="mly"></div>
    
    <div id="top-hud">
        <div style="display:flex; flex-direction:column;">
            <div id="timer-box">02:00</div>
            <div id="host-controls">
                <span style="font-size:10px; color:#aaa; margin-bottom:2px;">ADMIN</span>
                <button class="mini-btn" onclick="window.hostForceRoundEnd()" data-i18n="btn_force_end">End Round</button>
            </div>
        </div>
        <div id="score-box">
            <div class="score-row" id="round-indicator" style="display:none; color:#aaa; font-size:0.8rem;">ROUND 1/5</div>
            <div class="score-row"><span data-i18n="lbl_me">YOU</span> <span id="score-me" class="score-val">0</span></div>
            <!-- MP Score List -->
            <div id="mp-scores" style="display:none; flex-direction:column; gap:2px; margin-top:5px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;"></div>
        </div>
    </div>

    <button id="mobile-map-toggle" onclick="window.toggleMap()">üó∫Ô∏è</button>

    <div id="map-container">
        <div id="map"></div>
        <button id="confirm-btn" onclick="window.submitGuess()" data-i18n="btn_guess_tap">Tap map to guess</button>
    </div>

    <div id="result-sheet">
        <div class="result-row">
            <div>
                <div class="big-text" id="res-dist">0 m</div>
                <div style="color:#f1c40f; font-weight:bold; font-size:1.4rem;" id="res-pts">+0 pts</div>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:bold; font-size:1.1rem; color: #ddd;" data-i18n="lbl_location">Location</div>
                <div id="res-loc-name" class="sub-text">City, Country</div>
            </div>
        </div>
        
        <!-- Multi Player Results List -->
        <div id="res-mp-list" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; display:none; max-height:100px; overflow-y:auto;">
            <!-- Injected via JS -->
        </div>

        <div class="btn-group">
            <button class="btn-secondary" onclick="window.shareResult()">üì§</button>
            <button class="btn-primary" id="next-btn" onclick="window.nextRound()">
                <span class="btn-content" data-i18n="btn_next">Play Next</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
    </div>

    <!-- SUMMARY MODAL -->
    <div id="summary-modal" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:7000; display:none; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="text-transform:uppercase; letter-spacing:2px;" data-i18n="lbl_game_over">Game Over</h1>
        <div class="summary-score" id="final-score" style="font-size:4rem; font-weight:900; background:var(--primary-grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin:20px 0;">0</div>
        <button class="btn-main btn-blue" onclick="window.location.reload()" data-i18n="btn_menu">Menu</button>
    </div>

    <!-- JS MODULES -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mapillary-js@4.1.0/dist/mapillary.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // --- 1. CONFIG & TRANSLATIONS ---
        const firebaseConfig = {
            apiKey: "AIzaSyDJjo66zCwODJW1J2SoVQ2B8tIH5FPUu1A",
            authDomain: "mytube-cd424.firebaseapp.com",
            databaseURL: "https://mytube-cd424-default-rtdb.firebaseio.com",
            projectId: "mytube-cd424",
            storageBucket: "mytube-cd424.appspot.com",
            messagingSenderId: "865512387483",
            appId: "1:865512387483:web:de8245f509dba9bbd5273e"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const MLY_TOKEN = 'MLY|26213154491618951|523c0418de2d6a8118aefdab3284d6c2';

        const TR = {
            en: {
                app_title: "GeoGuessr", app_subtitle: "Explore the world & challenge friends",
                btn_endless: "‚àû Endless Mode", btn_challenge: "‚è±Ô∏è Challenge Mode", btn_friend: "üë• Party Mode", btn_profile: "üë§ My Profile",
                btn_back: "Back", friend_mode: "Party Mode", lbl_create: "Create Room", lbl_join: "Join Room",
                mode_endless: "Endless", mode_challenge: "Challenge", btn_create_play: "Create & Play", btn_join: "Join Room",
                lbl_share_code: "Share code with friends", lbl_waiting: "Waiting for players...", btn_leave: "Leave", btn_start_game: "Start Game",
                lbl_me: "YOU", btn_force_end: "End Round", btn_guess_tap: "Tap map to guess", btn_guess_confirm: "CONFIRM GUESS", btn_wait: "WAITING...",
                lbl_location: "Location", btn_next: "Play Next", btn_finish: "Finish Game", lbl_game_over: "Game Over", btn_menu: "Main Menu",
                pf_rank: "Explorer", lbl_games: "Games", lbl_score: "Total XP", lbl_history: "History",
                msg_kicked: "You were kicked from the room."
            },
            ru: {
                app_title: "–ì–µ–æ–ì–µ—Å—Å—Ä", app_subtitle: "–ò—Å—Å–ª–µ–¥—É–π –º–∏—Ä –∏ –∏–≥—Ä–∞–π —Å –¥—Ä—É–∑—å—è–º–∏",
                btn_endless: "‚àû –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π", btn_challenge: "‚è±Ô∏è –ù–∞ –≤—Ä–µ–º—è", btn_friend: "üë• –ì—Ä—É–ø–ø–æ–≤–æ–π", btn_profile: "üë§ –ü—Ä–æ—Ñ–∏–ª—å",
                btn_back: "–ù–∞–∑–∞–¥", friend_mode: "–ò–≥—Ä–∞ —Å –¥—Ä—É–∑—å—è–º–∏", lbl_create: "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É", lbl_join: "–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É",
                mode_endless: "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ", mode_challenge: "–ß–µ–ª–ª–µ–Ω–¥–∂", btn_create_play: "–°–æ–∑–¥–∞—Ç—å", btn_join: "–í–æ–π—Ç–∏",
                lbl_share_code: "–û—Ç–ø—Ä–∞–≤—å –∫–æ–¥ –¥—Ä—É–∑—å—è–º", lbl_waiting: "–ñ–¥–µ–º –∏–≥—Ä–æ–∫–æ–≤...", btn_leave: "–í—ã–π—Ç–∏", btn_start_game: "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É",
                lbl_me: "–í–´", btn_force_end: "–ó–∞–≤–µ—Ä—à–∏—Ç—å", btn_guess_tap: "–ù–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç—É", btn_guess_confirm: "–ü–û–î–¢–í–ï–†–î–ò–¢–¨", btn_wait: "–û–ñ–ò–î–ê–ù–ò–ï...",
                lbl_location: "–õ–æ–∫–∞—Ü–∏—è", btn_next: "–î–∞–ª—å—à–µ", btn_finish: "–§–∏–Ω–∏—à", lbl_game_over: "–ö–æ–Ω–µ—Ü –∏–≥—Ä—ã", btn_menu: "–í –º–µ–Ω—é",
                pf_rank: "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å", lbl_games: "–ò–≥—Ä—ã", lbl_score: "–í—Å–µ–≥–æ XP", lbl_history: "–ò—Å—Ç–æ—Ä–∏—è",
                msg_kicked: "–í—ã –±—ã–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –∫–æ–º–Ω–∞—Ç—ã."
            }
        };

        // --- 2. GLOBAL STATE ---
        const USER = (window.Telegram?.WebApp?.initDataUnsafe?.user) || { id: 'test_'+Math.floor(Math.random()*1000), first_name: 'Guest', language_code: 'en' };
        
        const STATE = {
            lang: localStorage.getItem('geo_lang') || (USER.language_code === 'ru' ? 'ru' : 'en'),
            mode: 'menu',
            mpRole: null, // 'host' or 'guest'
            gameId: null,
            myUid: USER.id.toString(),
            myName: USER.first_name,
            round: 1,
            maxRounds: 5,
            score: 0,
            timer: null,
            timeLeft: 120,
            currentLoc: null,
            isLocked: false,
            mpModeSelected: 'endless',
            players: {}, // For MP
            history: JSON.parse(localStorage.getItem('geo_history') || '[]')
        };

        // --- 3. LOCATIONS ARRAY (PLACEHOLDER) ---
        const LOCATIONS = [
            // PASTE YOUR LOCATIONS ARRAY HERE
            // Example:
            { name: "Paris, France", flag: "üá´üá∑", lat: 48.8566, lng: 2.3522 },
            { name: "New York, USA", flag: "üá∫üá∏", lat: 40.7128, lng: -74.0060 },
            { name: "Tokyo, Japan", flag: "üáØüáµ", lat: 35.6762, lng: 139.6503 },
            { name: "Moscow, Russia", flag: "üá∑üá∫", lat: 55.7558, lng: 37.6173 },
            { name: "London, UK", flag: "üá¨üáß", lat: 51.5074, lng: -0.1278 },
            { name: "Sydney, Australia", flag: "üá¶üá∫", lat: -33.8688, lng: 151.2093 }
            // ... (Add your full 100+ list from previous file)
        ];

        let map, mly, guessMarker, resultLine, resultMarker, oppMarkers = [];

        // --- 4. CORE FUNCTIONS (INIT & I18N) ---
        function init() {
            // Map
            map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬©CARTO' }).addTo(map);

            // Mapillary
            const { Viewer } = mapillary;
            mly = new Viewer({ accessToken: MLY_TOKEN, container: 'mly', component: { cover: false, sequence: false } });

            // Events
            map.on('click', (e) => {
                if(STATE.isLocked) return;
                if(guessMarker) map.removeLayer(guessMarker);
                guessMarker = L.marker(e.latlng).addTo(map);
                
                const btn = document.getElementById('confirm-btn');
                btn.classList.add('active');
                btn.innerText = t('btn_guess_confirm');
                btn.disabled = false;
                
                if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.selectionChanged();
            });

            applyTranslations();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        // Translation Logic
        function t(key) { return TR[STATE.lang][key] || key; }
        
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.innerText = t(el.getAttribute('data-i18n'));
            });
            // Dynamic text updates
            document.getElementById('settings-btn').innerText = STATE.lang === 'en' ? 'üá∫üá∏' : 'üá∑üá∫';
        }

        window.toggleLanguage = () => {
            STATE.lang = STATE.lang === 'en' ? 'ru' : 'en';
            localStorage.setItem('geo_lang', STATE.lang);
            applyTranslations();
        };

        // --- 5. UI FLOW ---
        window.showMainMenu = () => {
            document.querySelectorAll('.full-screen-menu').forEach(el => el.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
        };

        window.openFriendMenu = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('friend-menu').classList.remove('hidden');
        };

        window.selectMpMode = (mode) => {
            STATE.mpModeSelected = mode;
            document.getElementById('mp-mode-endless').classList.toggle('selected', mode === 'endless');
            document.getElementById('mp-mode-challenge').classList.toggle('selected', mode === 'challenge');
        };

        // --- 6. PROFILE SYSTEM ---
        window.openProfile = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('profile-screen').classList.remove('hidden');
            
            // Stats
            const hist = STATE.history;
            const totalGames = hist.length;
            const totalScore = hist.reduce((acc, curr) => acc + (curr.pts || 0), 0);
            
            document.getElementById('pf-name').innerText = STATE.myName;
            document.getElementById('pf-total-games').innerText = totalGames;
            document.getElementById('pf-total-score').innerText = totalScore;
            
            // History
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            [...hist].reverse().slice(0, 30).forEach(h => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<div>${h.date}</div><div class="h-score">+${h.pts}</div>`;
                list.appendChild(div);
            });
        };

        window.closeProfile = () => window.showMainMenu();

        function saveGameToHistory(pts) {
            const entry = {
                date: new Date().toLocaleDateString(),
                pts: pts,
                loc: STATE.currentLoc ? STATE.currentLoc.city.name : 'Unknown'
            };
            STATE.history.push(entry);
            localStorage.setItem('geo_history', JSON.stringify(STATE.history));
        }

        // --- 7. GAME MODES & LOGIC ---
        window.startEndless = () => {
            STATE.mode = 'endless'; STATE.score = 0;
            updateHUD(); startGameLoop();
        };

        window.startChallenge = () => {
            STATE.mode = 'challenge'; STATE.round = 1; STATE.score = 0; STATE.maxRounds = 5;
            updateHUD(); startGameLoop();
        };

        function updateHUD() {
            document.querySelectorAll('.full-screen-menu').forEach(el => el.classList.add('hidden'));
            document.getElementById('score-me').innerText = STATE.score;
            document.getElementById('mp-scores').style.display = 'none';
            document.getElementById('host-controls').style.display = 'none';

            if (STATE.mode === 'challenge' || (STATE.mode === 'multi' && STATE.mpModeSelected === 'challenge')) {
                document.getElementById('round-indicator').style.display = 'flex';
                document.getElementById('round-indicator').innerText = `ROUND ${STATE.round}/${STATE.maxRounds}`;
                document.getElementById('timer-box').style.display = 'block';
            } else {
                document.getElementById('round-indicator').style.display = 'none';
                document.getElementById('timer-box').style.display = 'none';
            }
        }

        async function pickRandomLocation() {
            // Safety fallback if user forgets to paste locations
            if(LOCATIONS.length < 1) return { id: '5177821635678829', lat: 48.8566, lng: 2.3522, city: { name: "Paris", flag: "üá´üá∑"} };

            const city = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
            const range = 0.04;
            const rLat = city.lat + (Math.random() * range * 2 - range);
            const rLng = city.lng + (Math.random() * range * 2 - range);
            const bbox = `${rLng-0.005},${rLat-0.005},${rLng+0.005},${rLat+0.005}`;

            try {
                const res = await fetch(`https://graph.mapillary.com/images?access_token=${MLY_TOKEN}&fields=id,geometry&bbox=${bbox}&limit=1`);
                const data = await res.json();
                if(data.data && data.data.length > 0) {
                    return { id: data.data[0].id, lat: data.data[0].geometry.coordinates[1], lng: data.data[0].geometry.coordinates[0], city: city };
                } else return pickRandomLocation(); 
            } catch(e) { return pickRandomLocation(); }
        }

        function startGameLoop() {
            resetMapUI();
            if (STATE.mode !== 'multi') {
                document.getElementById('loading').classList.remove('hidden');
                pickRandomLocation().then(loc => {
                    STATE.currentLoc = loc;
                    loadLocation(loc);
                    if(STATE.mode === 'challenge') startTimer(120);
                });
            } else {
                document.getElementById('confirm-btn').innerText = t('btn_wait');
            }
        }

        function loadLocation(loc) {
            mly.moveTo(loc.id)
                .then(() => document.getElementById('loading').classList.add('hidden'))
                .catch(() => pickRandomLocation().then(l => loadLocation(l)));
        }

        function resetMapUI() {
            STATE.isLocked = false;
            document.getElementById('result-sheet').classList.remove('show');
            document.getElementById('map-container').classList.remove('map-result-mode', 'open');
            document.getElementById('mobile-map-toggle').style.display = 'flex';
            document.getElementById('res-mp-list').style.display = 'none';

            if(guessMarker) map.removeLayer(guessMarker);
            if(resultLine) map.removeLayer(resultLine);
            if(resultMarker) map.removeLayer(resultMarker);
            oppMarkers.forEach(m => map.removeLayer(m));
            oppMarkers = [];
            
            guessMarker = null; 
            map.setView([20,0], 2);
            
            const btn = document.getElementById('confirm-btn');
            btn.classList.remove('active');
            btn.innerText = t('btn_guess_tap');
            btn.disabled = true;
            
            const nextBtn = document.getElementById('next-btn');
            nextBtn.classList.remove('loading');
            nextBtn.disabled = false;
        }

        function startTimer(seconds) {
            clearInterval(STATE.timer);
            STATE.timeLeft = seconds;
            updateTimerDisplay();
            STATE.timer = setInterval(() => {
                STATE.timeLeft--;
                updateTimerDisplay();
                if(STATE.timeLeft <= 0) {
                    clearInterval(STATE.timer);
                    if(!STATE.isLocked) window.submitGuess(true); 
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const min = Math.floor(STATE.timeLeft / 60);
            const sec = STATE.timeLeft % 60;
            const el = document.getElementById('timer-box');
            el.innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;
            if(STATE.timeLeft < 10) el.classList.add('warning'); else el.classList.remove('warning');
        }

        // --- 8. MULTIPLAYER (PARTY MODE) ---
        window.createRoom = () => {
            const btn = document.getElementById('btn-create');
            btn.classList.add('loading');
            const code = Math.floor(10000 + Math.random() * 90000).toString();
            STATE.gameId = code;
            STATE.mpRole = 'host';
            STATE.mode = 'multi';
            
            const initialData = {
                status: 'waiting',
                mode: STATE.mpModeSelected,
                round: 1,
                host: STATE.myUid,
                players: {
                    [STATE.myUid]: { name: STATE.myName, score: 0, avatar: 'üëë' }
                }
            };

            set(ref(db, 'games/' + code), initialData).then(() => {
                btn.classList.remove('loading');
                enterLobby(code);
            });
        };

        window.joinRoom = () => {
            const code = document.getElementById('join-code').value;
            if(code.length !== 5) return;
            const btn = document.getElementById('btn-join');
            btn.classList.add('loading');

            get(ref(db, 'games/' + code)).then((snap) => {
                btn.classList.remove('loading');
                if(snap.exists()) {
                    STATE.gameId = code;
                    STATE.mpRole = 'guest';
                    STATE.mode = 'multi';
                    
                    // Add myself to players
                    update(ref(db, `games/${code}/players/${STATE.myUid}`), {
                        name: STATE.myName, score: 0, avatar: 'üë§'
                    });
                    
                    enterLobby(code);
                } else {
                    alert("Room not found");
                }
            });
        };

        function enterLobby(code) {
            document.getElementById('friend-menu').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('lobby-code-display').innerText = code;
            
            // Show host controls if host
            if(STATE.mpRole === 'host') document.getElementById('host-actions').classList.remove('hidden');
            
            listenToLobby(code);
        }

        window.hostStartGame = () => {
            update(ref(db, `games/${STATE.gameId}`), { status: 'starting' });
        };
        
        window.leaveLobby = () => {
            // Remove self
            remove(ref(db, `games/${STATE.gameId}/players/${STATE.myUid}`));
            window.location.reload();
        };
        
        window.hostKick = (uid) => {
             remove(ref(db, `games/${STATE.gameId}/players/${uid}`));
        };

        function listenToLobby(code) {
            onValue(ref(db, 'games/' + code), (snap) => {
                const data = snap.val();
                if(!data) { alert("Room closed"); window.location.reload(); return; }

                // Check if kicked
                if(!data.players || !data.players[STATE.myUid]) {
                    alert(t('msg_kicked')); window.location.reload(); return;
                }

                // Update Player List
                STATE.players = data.players;
                renderPlayerList(data.players, data.host);

                // Start Game Trigger
                if(data.status === 'starting' || data.status === 'playing') {
                    document.getElementById('lobby-screen').classList.add('hidden');
                    if(STATE.mpRole === 'host' && data.status === 'starting') {
                        // Host picks loc
                        update(ref(db, `games/${code}`), { status: 'playing' });
                        document.getElementById('loading').classList.remove('hidden');
                        pickRandomLocation().then(loc => {
                            update(ref(db, `games/${code}`), { location: loc });
                        });
                    }
                    listenToGame(code); // Switch to game listener
                }
            });
        }

        function renderPlayerList(players, hostId) {
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            Object.keys(players).forEach(uid => {
                const p = players[uid];
                const div = document.createElement('div');
                div.className = 'player-item';
                let html = `<div class="player-info"><div class="player-avatar">${p.avatar}</div> <span>${p.name}</span></div>`;
                
                // Host Kick Button
                if(STATE.mpRole === 'host' && uid !== STATE.myUid) {
                    html += `<button class="kick-btn" onclick="window.hostKick('${uid}')">√ó</button>`;
                }
                div.innerHTML = html;
                list.appendChild(div);
            });
        }

        function listenToGame(code) {
            // HUD specific for MP
            document.getElementById('mp-scores').style.display = 'flex';
            if(STATE.mpRole === 'host') document.getElementById('host-controls').style.display = 'flex';

            onValue(ref(db, 'games/' + code), (snap) => {
                const data = snap.val();
                if(!data) return;

                // Sync Scores in HUD
                renderMpScores(data.players);

                // Location Sync
                if(data.location && (!STATE.currentLoc || STATE.currentLoc.id !== data.location.id)) {
                    STATE.currentLoc = data.location;
                    STATE.round = data.round;
                    STATE.resultShown = false; 
                    
                    updateHUD();
                    loadLocation(data.location);
                    resetMapUI();
                    
                    if(data.mode === 'challenge') startTimer(120);
                }

                // Force Round End (by Host)
                if(data.forceEndRound && !STATE.isLocked && !STATE.resultShown) {
                     window.submitGuess(true); // Auto submit blank
                }

                // Show Results Logic
                // If everyone guessed OR host forced end
                const playerIds = Object.keys(data.players);
                const guesses = data.guesses || {};
                const allGuessed = playerIds.every(uid => guesses[uid]);
                
                if( (allGuessed || data.status === 'results') && !STATE.resultShown ) {
                    STATE.resultShown = true;
                    clearInterval(STATE.timer);
                    showMpResult(guesses, data.location);
                }
            });
        }

        function renderMpScores(players) {
            const container = document.getElementById('mp-scores');
            container.innerHTML = '';
            Object.values(players).sort((a,b) => b.score - a.score).forEach(p => {
                const div = document.createElement('div');
                div.style.cssText = "display:flex; justify-content:space-between; font-size:0.8rem; color:#ddd;";
                div.innerHTML = `<span>${p.name}</span> <span style="color:#f1c40f">${p.score}</span>`;
                container.appendChild(div);
            });
        }
        
        window.hostForceRoundEnd = () => {
            update(ref(db, `games/${STATE.gameId}`), { status: 'results' });
        };

        // --- 9. SUBMISSION & RESULTS ---
        window.submitGuess = (force = false) => {
            if((!guessMarker && !force) || STATE.isLocked) return;
            
            clearInterval(STATE.timer);
            STATE.isLocked = true;
            
            const uLat = guessMarker ? guessMarker.getLatLng() : L.latLng(0,0);
            const aLat = L.latLng(STATE.currentLoc.lat, STATE.currentLoc.lng);
            const dist = map.distance(uLat, aLat);
            const pts = (force && !guessMarker) ? 0 : Math.round(5000 * Math.exp(-dist / 120000)); 

            if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            if(STATE.mode === 'multi') {
                document.getElementById('confirm-btn').innerText = t('btn_wait');
                update(ref(db, `games/${STATE.gameId}/guesses/${STATE.myUid}`), {
                    lat: uLat.lat, lng: uLat.lng, pts: pts, name: STATE.myName
                });
                return;
            }

            STATE.score += pts;
            saveGameToHistory(pts);
            showSingleResult(uLat, aLat, dist, pts);
        };

        function showSingleResult(uLat, aLat, dist, pts) {
            setupResultMap(uLat, aLat);
            
            document.getElementById('res-dist').innerText = formatDist(dist);
            document.getElementById('res-pts').innerText = "+" + pts + " pts";
            document.getElementById('res-loc-name').innerHTML = STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag;
            
            const nextBtn = document.getElementById('next-btn');
            const nextBtnText = nextBtn.querySelector('.btn-content');
            
            if (STATE.mode === 'challenge' && STATE.round >= STATE.maxRounds) {
                nextBtnText.innerText = t('btn_finish');
                nextBtn.onclick = showSummary;
            } else {
                nextBtnText.innerText = t('btn_next');
                nextBtn.onclick = window.nextRound;
            }

            document.getElementById('result-sheet').classList.add('show');
        }

        function showMpResult(guesses, locData) {
            const actual = L.latLng(locData.lat, locData.lng);
            const myGuess = guesses[STATE.myUid];
            
            // Map Setup
            setupResultMap(myGuess ? L.latLng(myGuess.lat, myGuess.lng) : actual, actual);
            
            // Plot others
            Object.keys(guesses).forEach(uid => {
                if(uid === STATE.myUid) return;
                const g = guesses[uid];
                const gLat = L.latLng(g.lat, g.lng);
                const m = L.circleMarker(gLat, { radius:5, color:'#ff4b2b', fillColor:'#ff4b2b', fillOpacity:1 }).addTo(map);
                const l = L.polyline([gLat, actual], { color: '#ff4b2b', weight: 1, dashArray:'4,4' }).addTo(map);
                oppMarkers.push(m, l);
            });

            // My Stats
            const pts = myGuess ? myGuess.pts : 0;
            const dist = myGuess ? map.distance(L.latLng(myGuess.lat, myGuess.lng), actual) : 0;
            
            document.getElementById('res-dist').innerText = myGuess ? formatDist(dist) : "Did not guess";
            document.getElementById('res-pts').innerText = "+" + pts + " pts";
            document.getElementById('res-loc-name').innerHTML = STATE.currentLoc.city.name + " " + STATE.currentLoc.city.flag;

            // Leaderboard List
            const list = document.getElementById('res-mp-list');
            list.style.display = 'block';
            list.innerHTML = '';
            Object.values(guesses).sort((a,b)=>b.pts - a.pts).forEach(g => {
                const r = document.createElement('div');
                r.style.cssText = "display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:4px;";
                r.innerHTML = `<span>${g.name}</span> <span style="color:#f1c40f">+${g.pts}</span>`;
                list.appendChild(r);
            });

            // Next Button Logic
            const nextBtn = document.getElementById('next-btn');
            const nextBtnText = nextBtn.querySelector('.btn-content');
            
            if (STATE.mpModeSelected === 'challenge' && STATE.round >= STATE.maxRounds) {
                nextBtnText.innerText = t('btn_finish');
                nextBtn.onclick = showSummary;
                saveGameToHistory(STATE.score); // Save total MP score
            } else {
                nextBtnText.innerText = (STATE.mpRole === 'host') ? t('btn_next') : t('btn_wait');
                nextBtn.disabled = (STATE.mpRole !== 'host');
                nextBtn.onclick = (STATE.mpRole === 'host') ? window.nextRound : null;
                
                // Host updates scores permanently
                if(STATE.mpRole === 'host') {
                    get(ref(db, `games/${STATE.gameId}/players`)).then(snap => {
                        const p = snap.val();
                        Object.keys(guesses).forEach(uid => {
                            if(p[uid]) p[uid].score += guesses[uid].pts;
                        });
                        update(ref(db, `games/${STATE.gameId}/players`), p);
                    });
                }
            }
            document.getElementById('result-sheet').classList.add('show');
        }

        function setupResultMap(uLat, aLat) {
            document.getElementById('mobile-map-toggle').style.display = 'none';
            document.getElementById('map-container').classList.add('map-result-mode', 'open');
            setTimeout(() => map.invalidateSize(), 200);

            resultMarker = L.circleMarker(aLat, { radius: 8, color: '#fff', fillColor: '#00ff00', fillOpacity: 1 }).addTo(map);
            resultLine = L.polyline([uLat, aLat], { color: '#00C6FF', weight: 4 }).addTo(map);
            
            const group = new L.featureGroup([L.marker(uLat), resultMarker]);
            map.fitBounds(group.getBounds(), { padding: [50, 50], maxZoom: 16 });
        }

        window.nextRound = () => {
            const btn = document.getElementById('next-btn');
            btn.classList.add('loading');
            
            if(STATE.mode === 'endless' || STATE.mode === 'challenge') {
                if(STATE.mode === 'challenge') STATE.round++;
                startGameLoop();
            } else if (STATE.mode === 'multi' && STATE.mpRole === 'host') {
                const nextR = STATE.round + 1;
                update(ref(db, `games/${STATE.gameId}`), {
                    status: 'next_round',
                    round: nextR,
                    guesses: null,
                    forceEndRound: null // Reset force flag
                }).then(() => {
                    document.getElementById('loading').classList.remove('hidden');
                    pickRandomLocation().then(loc => {
                        update(ref(db, `games/${STATE.gameId}`), { location: loc, status: 'playing' });
                    });
                });
            }
        };

        function showSummary() {
            document.getElementById('summary-modal').style.display = 'flex';
            document.getElementById('final-score').innerText = STATE.score;
            confetti({ particleCount: 200, spread: 100 });
        }

        window.toggleMap = () => {
            const c = document.getElementById('map-container');
            const b = document.getElementById('mobile-map-toggle');
            if(c.classList.contains('open')) { c.classList.remove('open'); b.innerText = "üó∫Ô∏è"; } 
            else { c.classList.add('open'); b.innerText = "‚úñ"; setTimeout(() => map.invalidateSize(), 300); }
        };

        function formatDist(m) { return m < 1000 ? Math.round(m) + " m" : (m/1000).toFixed(1) + " km"; }

        window.shareResult = () => {
            // Simple share via Telegram link
            const text = `GeoGuessr: I scored ${STATE.score} pts!`;
            const url = `https://t.me/share/url?url=${encodeURIComponent("t.me/geogur_bot/app")}&text=${encodeURIComponent(text)}`;
            if(window.Telegram?.WebApp) window.Telegram.WebApp.openTelegramLink(url);
            else window.open(url, '_blank');
        };

        init();
    </script>
</body>
</html>
